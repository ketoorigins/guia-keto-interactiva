<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keto Origins - Plan Personalizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Custom Colors --- */
        :root {
            --brand-blue: #2563EB;
            --brand-purple: #7C3AED;
            --brand-cyan: #22D3EE;
            --brand-green: #4ADE80;
            --brand-pink: #F472B6;
            --brand-amber: #FBBF24;
        }

        /* --- Base and Scrollbar Styles --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Default BG */
            color: #e0e0e0;
        }
        .main-app-bg {
            background-color: #111827; /* Fallback color */
            background-image: linear-gradient(to bottom, #2a2240, #111827);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Welcome & Onboarding Styles --- */
        .welcome-screen {
            background-color: #111827; /* Fallback */
            background-image: linear-gradient(to bottom, #391d3d, #111827);
        }
        .wizard-container {
             background-color: #111827;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
            background: linear-gradient(90deg, var(--brand-blue), var(--brand-purple));
        }
        .progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1F2937;
            z-index: 1;
        }
        .progress-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            padding: 1px; /* Border thickness */
            background: linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
                  mask-composite: exclude;
            z-index: -1;
        }
        .option-button {
            background-color: #1F2937;
            border: 1px solid #4B5563;
            transition: all 0.2s ease-in-out;
            color: #D1D5DB;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .option-button:hover {
            border-color: var(--brand-purple);
            transform: translateY(-2px);
        }
        .option-button.selected {
            background-color: var(--brand-blue);
            border-color: var(--brand-cyan);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
            color: #FFFFFF;
            transform: translateY(-2px);
        }
        .info-card-onboarding {
            background-color: #1e1b2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        /* --- Dashboard & Card Styles --- */
        .dashboard-card, .guide-card, .advice-card {
            background-color: #1e1b2e; /* Dark purple-blue from reference */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            border-radius: 0.75rem;
            position: relative; /* Needed for icon positioning */
        }

        .advice-card {
             background-color: #2a2240; /* Slightly different background for advice */
        }

        .medical-warning {
            border-color: var(--brand-amber) !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }
        
        .lipid-analysis-card .interpretation-box {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        
        .lipid-analysis-card .interpretation-good {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #A7F3D0;
        }

        .lipid-analysis-card .interpretation-warning {
            background-color: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #FCD34D;
        }

        .image-gradient-border {
            border-radius: 9999px; /* rounded-full */
            border: 3px solid transparent;
            background-image: linear-gradient(#1e1b2e, #1e1b2e), linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
            background-origin: border-box;
            background-clip: content-box, border-box;
        }

        .logo-gradient-border {
            position: relative;
            border-radius: 50%;
            display: inline-block;
            padding: 2px; /* Controls the border thickness */
            background: linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
        }
        .logo-gradient-border img {
            display: block;
            border-radius: 50%;
        }


        /* --- Accordion Styles --- */
        .accordion-content {
            max-height: 0;
            overflow: hidden; /* Keep hidden for smooth transition */
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0; /* Ensure initial padding is zero for transition */
            padding-bottom: 0; /* Ensure initial padding is zero for transition */
        }
        .accordion-content.open {
            max-height: 2000px; /* A large enough value to accommodate content */
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background-color: #1e1b2e;
        }
        .accordion-button.open {
             border-radius: 0.5rem 0.5rem 0 0;
        }
        .accordion-button.open .accordion-arrow {
            transform: rotate(90deg);
        }
        .accordion-arrow {
            transition: transform 0.3s ease;
        }


        /* --- General Buttons and Interactive Elements --- */
        .btn-glow {
            cursor: pointer;
            background: linear-gradient(90deg, var(--brand-blue), #4F46E5);
            box-shadow: 0 4px 15px 0 rgba(37, 99, 235, 0.35);
            transition: all 0.2s ease-out;
            border: 2px solid var(--brand-purple);
            border-bottom-width: 4px;
        }
        .btn-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 5px rgba(37, 99, 235, 0.45);
        }
        .btn-glow:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px 0 rgba(37, 99, 235, 0.3);
            border-bottom-width: 2px;
        }
        .btn-glow:disabled {
            background: #4B5563;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
            transform: translateY(0);
            border-color: #4B5563;
        }
        .custom-checkbox {
            appearance: none;
            background-color: #374151;
            border: 1px solid #4B5563;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }
        .custom-checkbox:checked {
            background-color: var(--brand-blue);
            border-color: var(--brand-blue);
        }
        .custom-checkbox:checked::after {
            content: '✓';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            line-height: 1;
        }
        .note-textarea { background-color: rgba(17, 24, 39, 0.7); border: 1px solid #4B5563; }
        .note-textarea:focus { border-color: var(--brand-blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); outline: none; }

        /* --- Sidebar and Navigation --- */
        .sidebar { transition: transform 0.3s ease-in-out; }
        
        .nav-link.dashboard-special-button {
            position: relative;
            background-color: #1F2937;
            z-index: 1;
            border: none;
        }

        .nav-link.dashboard-special-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            padding: 1px; /* Controls the border thickness */
            background: linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
                  mask-composite: exclude;
            z-index: -1;
        }


        .nav-link.active:not(.dashboard-special-button) {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.3), rgba(29, 78, 216, 0.3));
            box-shadow: inset 2px 0 0 var(--brand-blue), inset 0 0 10px rgba(99, 102, 241, 0.4);
            color: #ffffff; font-weight: 700;
        }
        .nav-link:not(.dashboard-special-button):hover { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), rgba(29, 78, 216, 0.2)); 
        }
        
        /* --- Toast Notification --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast-notification {
            transition: opacity 0.5s, transform 0.5s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* --- Modal and Help Icon Styles --- */
        #info-modal {
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        #info-modal.flex {
            display: flex;
        }
        .help-icon {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 1.5rem;
            height: 1.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .help-icon:hover {
            background-color: var(--brand-purple);
            color: white;
            transform: scale(1.1);
        }

    </style>
</head>
<body class="min-h-screen">

    <!-- Access Code Screen (New Welcome Screen) -->
    <div id="access-screen" class="welcome-screen fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center">
        <div class="logo-gradient-border mb-8 shadow-2xl">
            <img src="https://i.ibb.co/20NypXdZ/ketoorigins.png" alt="Logo Keto Origins" class="w-48 h-48 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/192x192/1e1b2e/ffffff?text=Logo';">
        </div>
        <div class="w-full max-w-sm">
            <h1 class="text-3xl font-extrabold text-white mb-6">Bienvenido a Keto Origins</h1>
            <label for="access-code-input" class="block text-gray-300 mb-2">Ingresa tu código de acceso para comenzar</label>
            <input type="text" id="access-code-input" placeholder="Tu Código Aquí" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none transition">
            <button id="submit-code-btn" class="text-white font-bold py-4 px-16 rounded-full text-xl btn-glow mt-6 w-full">Validar Código</button>
            <div id="loading-spinner" class="hidden mt-4">
                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <p id="code-error-message" class="text-red-400 mt-4 font-semibold h-6"></p>
        </div>
    </div>

    <!-- Onboarding Wizard -->
    <div id="onboarding-wizard" class="wizard-container fixed inset-0 z-50 hidden flex-col p-4">
        <div class="w-full max-w-4xl mx-auto mb-4">
            <div class="grid grid-cols-3 items-center text-white mb-2">
                <div class="justify-self-start">
                    <button onclick="prevStep()" id="wizard-back-btn" class="text-2xl opacity-70 hover:opacity-100 transition">&larr;</button>
                </div>
                <div class="justify-self-center">
                    <div class="progress-circle">
                        <span id="progress-text" class="font-semibold text-lg">0%</span>
                    </div>
                </div>
                <div class="justify-self-end"></div> </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
        <div id="wizard-steps-container" class="flex-grow flex items-center justify-center overflow-y-auto no-scrollbar py-4">
            <!-- Wizard steps will be rendered here -->
        </div>
        <div class="w-full max-w-4xl mx-auto mt-4 flex justify-center">
            <button id="wizard-next-btn" onclick="nextStep()" disabled class="text-white font-bold py-3 px-12 rounded-full text-lg btn-glow">Continuar</button>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Main Application Container -->
    <div id="app-container" class="flex hidden main-app-bg">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed top-0 left-0 z-40 w-72 h-screen bg-black bg-opacity-30 backdrop-blur-lg p-5 transform -translate-x-full md:translate-x-0 flex flex-col no-scrollbar">
            <div class="flex items-center justify-center mb-8">
                <div class="logo-gradient-border shadow-lg">
                    <img src="https://i.ibb.co/20NypXdZ/ketoorigins.png" alt="Logo Keto Origins" class="w-28 h-28 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/112x112/1e1b2e/ffffff?text=Logo';">
                </div>
            </div>
            <nav id="main-nav" class="flex-grow overflow-y-auto no-scrollbar">
                <a href="#dashboard" class="nav-link dashboard-special-button block font-semibold py-3 px-4 rounded-lg transition duration-200 text-white">Dashboard</a>
                <a href="#herramientas" class="nav-link locked-content hidden block font-semibold py-3 px-4 rounded-lg transition duration-200 text-white mt-4">Herramientas</a>
            </nav>
             <!-- NUEVO: Botón de Reinicio -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <button id="reset-app-btn" class="w-full text-center text-sm text-gray-400 hover:text-red-400 transition py-2 px-4 rounded-lg hover:bg-red-500/10">
                    Borrar mis datos y empezar de nuevo
                </button>
            </div>
        </aside>

        <!-- Sidebar Toggle for Mobile -->
        <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 rounded-md btn-glow text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
        </button>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 md:ml-72 p-6 md:p-10 transition-all duration-300 overflow-y-auto h-screen">
            <section id="dashboard" class="mb-12">
                <!-- Dashboard content will be rendered here -->
            </section>
            
            <section id="herramientas" class="mb-12 hidden">
                <!-- Tools content will be rendered here -->
            </section>

        </main>
    </div>

    <!-- Information Modal -->
    <div id="info-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div id="info-modal-content" class="dashboard-card max-w-lg w-full relative">
            <h3 id="info-modal-title" class="text-2xl font-bold text-cyan-400 mb-4"></h3>
            <p id="info-modal-text" class="text-gray-300"></p>
            <button id="info-modal-close" class="btn-glow mt-6 py-2 px-6 rounded-lg self-center">Entendido</button>
        </div>
    </div>


<script>
// --- Global State & Config ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSBjpr3iNusaGeYbdjKmTnz1I6rA35HZm1XbYAop1keBUPPSTgAWLzqwtHL-ScdkrBug/exec';
let appState = {};
let weightChartInstance = null;
let healthChartInstance = null;
let lipidChartInstance = null;
let isAppInitialized = false;
let eventListeners = []; 

// --- App Cleanup Function ---
function cleanupAndReset() {
    console.log("Cleaning up and resetting app state...");
    if (weightChartInstance) {
        weightChartInstance.destroy();
        weightChartInstance = null;
    }
    if (healthChartInstance) {
        healthChartInstance.destroy();
        healthChartInstance = null;
    }
    if (lipidChartInstance) {
        lipidChartInstance.destroy();
        lipidChartInstance = null;
    }

    eventListeners.forEach(({ element, type, handler }) => {
        if (element) {
            element.removeEventListener(type, handler);
        }
    });
    eventListeners = [];
    console.log("Event listeners cleared.");

    appState = {
        userId: '',
        currentStepIndex: 0,
        wizardFlow: [],
        userData: {
            altura: 0,
            pesoInicial: 0,
            pesoActual: 0,
            historialPeso: [],
            historialGlucosa: [],
            historialPresion: [],
            historialLipidico: []
        },
        answers: {}
    };
    console.log("App state reset to initial values.");

    isAppInitialized = false;

    const containersToClear = ['#dashboard', '#herramientas', '#wizard-steps-container', '#toast-container'];
    containersToClear.forEach(selector => {
        const el = document.querySelector(selector);
        if (el) el.innerHTML = '';
    });
    console.log("Dynamic containers cleared.");

    document.getElementById('access-screen')?.classList.remove('hidden');
    document.getElementById('onboarding-wizard')?.classList.add('hidden');
    document.getElementById('app-container')?.classList.add('hidden');
    console.log("Main container visibility reset.");
}


// --- Static Data Definitions ---
const infoCardGraphics = {
    'weight-graph': 'https://i.ibb.co/B5rswTYR/peso.png',
    'appetite-graph': 'https://i.ibb.co/LzkYrcDn/apetito.png',
    'sugar-graph': 'https://i.ibb.co/pv8nfKNG/azucar-en-sangre.png',
    'water-graph': 'https://i.ibb.co/4gptYYX8/agua.png'
};

const tooltipDefinitions = {
    'projection': {
        title: 'Proyección de Peso',
        text: 'Estimación de cuanto podría demorar tu cuerpo en alcanzar su equilibrio metabólico. Siempre varía según los hábitos de cada persona.'
    },
    'imc': {
        title: 'Tu IMC actual',
        text: 'El Índice de Masa Corporal (IMC) es un indicador que relaciona el peso de una persona con su altura, utilizado para evaluar si el peso se encuentra dentro de rangos saludables.'
    },
    'water': {
        title: 'Consumo de agua',
        text: 'El cuerpo humano está compuesto aproximadamente entre un 50% y un 70% de agua. Este porcentaje puede variar dependiendo de factores como la edad, el sexo y la composición corporal de cada individuo. Y es vital para el correcto funcionamiento de nuestro cuerpo.'
    },
    'recipes': {
        title: 'Tus Recetas Keto',
        text: 'Tendrás acceso a nuestra aplicación de recetas keto para que no te quedes estancado sin saber que preparar cada día.'
    }
};

const baseWizardSteps = [
    { id: 'gender', type: 'question', question: '👤 Comencemos, ¿Cuál es tu género?', key: 'gender', options: [
        { text: '♀️ Femenino', value: 'female' },
        { text: '♂️ Masculino', value: 'male' }]
    },
    { id: 'weight_history', type: 'question', question: '⚖️ ¿Hace cuánto tiempo que no estás en tu peso ideal? (Selecciona una opción)', key: 'weight_history', options: [
        { text: '✅ Estoy en mi peso ideal', value: 'ideal_weight' },
        { text: '🗓️ Menos de un año', value: 'less_than_year' },
        { text: '📅 Más de un año', value: 'more_than_year' },
        { text: '🤷 Ya ni lo recuerdo', value: 'cant_remember' }]
    },
    { id: 'main_goal', type: 'question', question: '🎯 Cuéntanos sobre tu objetivo principal con Keto (Selecciona una opción)', key: 'main_goal', options: [
        { text: '📉 Perder peso y equilibrar mi metabolismo', value: 'loss' },
        { text: '✨ Mejorar energía, enfoque y concentración', value: 'energy' },
        { text: '❤️ Mejorar una condición de salud', value: 'health' },
        { text: '💪 Tonificar mi cuerpo y aumentar masa muscular', value: 'muscle' }]
    },
    { id: 'habits', type: 'question', question: '📝 Selecciona las opciones que te identifican: (Puedes seleccionar varias)', key: 'habits', multiple: true, options: [
        { text: '😴 Duermo muy poco', value: 'sleep_less' },
        { text: '🌙 Como muy tarde por la noche', value: 'dine_late' },
        { text: '🧂 Consumo muy poca sal', value: 'low_salt' },
        { text: '🍫 Me encantan los dulces y chocolates', value: 'sweet_cravings' },
        { text: '🥤 Me gustan las gaseosas y/o energéticas', value: 'love_soda' },
        { text: '👍 Ninguna de las anteriores', value: 'none' }]
    },
    { id: 'emotional_eating', type: 'question', question: '🍔 ¿Sufres de hambre emocional? (Selecciona una opción)', key: 'emotional_eating', options: [
        { text: '😔 Sí, a menudo', value: 'yes' },
        { text: '🤔 A veces', value: 'sometimes' },
        { text: '🙂 Muy rara vez', value: 'rarely' },
        { text: '😊 Nunca', value: 'never' }]
    },
    { id: 'junk_food_freq', type: 'question', question: '🌭 ¿Con qué frecuencia consumes comida chatarra? (Selecciona una opción)', key: 'junk_food_freq', options: [
        { text: '🥗 Nunca o raramente', value: 'rarely' },
        { text: '🍟 1-2 veces por semana', value: '1-2_weekly' },
        { text: '🍕 3-4 veces por semana', value: '3-4_weekly' },
        { text: '🍔 Casi a diario', value: 'daily' }]
    },
    { id: 'eat_out_freq', type: 'question', question: '🏙️ ¿Con qué frecuencia sales a comer fuera? (Selecciona una opción)', key: 'eat_out_freq', options: [
        { text: '🏠 Casi nunca', value: 'rarely' },
        { text: '🍴 Algunas veces al mes', value: 'monthly' },
        { text: '🍽️ Semanalmente', value: 'weekly' },
        { text: '🥡 Casi a diario', value: 'daily' }]
    },
    { id: 'cooking_skill', type: 'question', question: '🍳 ¿Cómo te consideras en la cocina? (Selecciona una opción)', key: 'cooking_skill', options: [
        { text: '🤷‍♂️ No sé cocinar', value: 'no' },
        { text: '👨‍🍳 Soy principiante', value: 'beginner' },
        { text: '👌 Me defiendo bien', value: 'intermediate' },
        { text: '🧑‍🍳 Soy un chef experto', value: 'advanced' }]
    },
    { id: 'daily_drinks', type: 'question', question: '🥤 ¿Qué sueles beber durante el día? (Puedes seleccionar varias)', key: 'daily_drinks', multiple: true, options: [
        { text: '☕ Café', value: 'coffee' },
        { text: '🍵 Té', value: 'tea' },
        { text: '💧 Agua', value: 'water' },
        { text: '🧃 Jugos', value: 'juice' },
        { text: '🥤 Gaseosas', value: 'soda' },
        { text: '✖️ Ninguna de las anteriores', value: 'none' }]
    },
    { id: 'water_intake', type: 'question', question: '🚰 ¿Cuánta agua bebes cada día? (Selecciona una opción)', key: 'water_intake', options: [
        { text: '💧 Casi nada', value: 'less_2' },
        { text: '💧💧 2-4 vasos', value: '2-4' },
        { text: '💧💧💧 4-6 vasos', value: '4-6' },
        { text: '💧💧💧💧 Más de 6 vasos', value: 'more_6' }]
    },
    { id: 'alcohol_intake', type: 'question', question: '🍺 ¿Con qué frecuencia bebes alcohol? (Selecciona una opción)', key: 'alcohol_intake', options: [
        { text: '🚫 No bebo alcohol', value: 'no' },
        { text: '🥂 Ocasionalmente', value: 'occasionally' },
        { text: '🍻 Regularmente (fines de semana)', value: 'yes' }]
    },
    { id: 'info_weight', type: 'info_card', title: 'Tu Peso', text: 'La dieta keto es una herramienta poderosa para alcanzar tu peso ideal. Al cambiar el combustible de tu cuerpo de azúcar a grasa, no solo pierdes peso, sino que también reduces la inflamación y ganas control sobre tu apetito, evitando el temido efecto rebote.<p class="text-sm italic text-purple-300 mt-4">"El hombre se convierte en lo que come" - Ludwig Feuerbach</p>', graphic_placeholder: 'weight-graph' },
    { id: 'activity_level', type: 'question', question: '🤸 ¿Cuál es tu nivel de actividad física semanal? (Selecciona una opción)', key: 'activity_level', options: [
        { text: '🛋️ Sedentario', value: 'sedentary' },
        { text: '🚶 Ligero (caminatas 1-2 días)', value: 'light' },
        { text: '🏃 Moderado (ejercicio 2-3 días)', value: 'moderate' },
        { text: '🏋️ Intenso (ejercicio 4+ días)', value: 'high' }]
    },
    { id: 'info_appetite', type: 'info_card', title: 'Tu Apetito', text: 'Al entrar en cetosis, tu cuerpo se vuelve sensible a las hormonas de la saciedad. Esto se traduce en menos antojos y un control natural del hambre, permitiéndote comer de forma consciente y no por impulso.<p class="text-sm italic text-purple-300 mt-4">"Comer es una necesidad, pero comer inteligentemente es un arte" - La Rochefoucauld</p>', graphic_placeholder: 'appetite-graph' },
    { id: 'health_conditions', type: 'question', question: '❤️‍🩹 ¿Tienes alguna de estas condiciones de salud? (Puedes seleccionar varias)', key: 'health_conditions', multiple: true, options: [
        { text: '🩸 Resistencia a la Insulina / Diabetes T2', value: 'insulin_resistance' },
        { text: '🌿 Hígado Graso', value: 'fatty_liver' },
        { text: '❤️‍🩹 Hipertensión', value: 'hypertension' },
        { text: '🦋 Hipotiroidismo', value: 'hypothyroidism' },
        { text: '🔥 Inflamación Sistémica', value: 'inflammation' },
        { text: '😴 Insomnio / Fatiga Crónica', value: 'insomnia' },
        { text: '✅ Ninguna de las anteriores', value: 'none' }]
    },
    { id: 'info_sugar', type: 'info_card', title: 'Tu Azúcar en Sangre', text: 'La dieta keto es excepcional para estabilizar la glucosa. Al minimizar los carbohidratos, evitas los picos de azúcar que causan fatiga y antojos, logrando niveles de energía estables durante todo el día.<p class="text-sm italic text-purple-300 mt-4">"La comida debe ser simple, natural y nutritiva" - Louis Pasteur</p>', graphic_placeholder: 'sugar-graph' },
    { id: 'stress_level', type: 'question', question: '🤯 ¿Sientes estrés con frecuencia? (Selecciona una opción)', key: 'stress_level', options: [
        { text: '😊 Nunca', value: 'never' },
        { text: '🙂 A veces', value: 'sometimes' },
        { text: '😟 A menudo', value: 'often' },
        { text: '😩 Casi siempre', value: 'always' }]
    },
    { id: 'info_water', type: 'info_card', title: 'Tu Hidratación', text: 'El agua es clave en keto para optimizar la quema de grasa y eliminar toxinas. Una correcta hidratación con electrolitos previene la "gripe keto" y potencia tus resultados. Te daremos una meta personalizada.<p class="text-sm italic text-purple-300 mt-4">"La comida es la base de toda cura" - Paracelso</p>', graphic_placeholder: 'water-graph' },
    { id: 'final_measures', type: 'final', question: '¡Casi listo! Introduce tus medidas para personalizar tu plan.' },
];

const conditionalSteps = {
    insulin_resistance: { id: 'cond_glucose', type: 'conditional_input', question: 'Si lo conoces, ingresa tu último nivel de glucosa en sangre (mg/dL). (Opcional)', key: 'glucose_level', inputType: 'number', placeholder: 'Ej: 110' },
    hypertension: { id: 'cond_pressure', type: 'conditional_input', question: 'Si la conoces, ingresa tu última medición de presión arterial. (Opcional)', key: 'blood_pressure', inputType: 'text', placeholder: 'Ej: 140/90' },
    obesity: { id: 'cond_lipids', type: 'conditional_input', question: 'Si los tienes, ingresa tus datos de lípidos. (Opcional)', key: 'lipids', multiple: true, fields: [
        { key: 'triglycerides', placeholder: 'Triglicéridos (mg/dL)' },
        { key: 'hdl', placeholder: 'Colesterol HDL (mg/dL)' },
        { key: 'ldl', placeholder: 'Colesterol LDL (mg/dL)' }
    ]}
};

const mainGoalPlan = {
    loss: {
        science: `Excelente elección. Has tomado la decisión de no solo perder peso, sino de arreglar la causa raíz del problema. Tu cuerpo es una máquina increíblemente inteligente que ha estado funcionando en 'modo almacenamiento' debido a una hormona clave: la <strong>insulina</strong>. Cada vez que comes carbohidratos o azúcar, la insulina sube y le grita a tu cuerpo: "¡Guarda esta energía como grasa! ¡No quemes nada!".<br><br>Lo que haremos es cambiar las reglas del juego. Al restringir los carbohidratos, vamos a 'silenciar' a la insulina. Cuando esta hormona baja, es como si tu cuerpo recibiera una nueva orden: <strong>"¡Abran las bodegas de grasa y úsenlas como combustible!"</strong>. Este cambio no es una dieta, es un cambio de sistema operativo para tu metabolismo, de quemador de azúcar a quemador de grasa.`,
        steps: [
            "<strong>Vaciar las Reservas de Azúcar (Depleción de Glucógeno):</strong> Durante los primeros 3-5 días, tu única misión es agotar el azúcar almacenado en tus músculos e hígado. Para ello, elimina por completo todos los azúcares, granos, harinas y frutas (excepto un puñado de bayas). Sé estricto aquí, es la fase más crítica.",
            "<strong>Activar la Quema de Grasa (Lipólisis):</strong> Una vez vaciadas las reservas, tu cuerpo buscará una nueva fuente de energía. Aquí es donde entran las grasas saludables. Come palta, aceite de oliva, aceitunas, y no temas a la grasa natural de las carnes y huevos. Estás enseñando a cada célula de tu cuerpo a usar grasa como su combustible preferido.",
            "<strong>Controlar la Insulina con tus Comidas:</strong> Come 2 o 3 comidas densas en nutrientes al día hasta sentirte saciado. Evita picotear entre horas. Cada vez que comes, generas una respuesta de insulina. Al espaciar tus comidas, mantienes la insulina baja por más tiempo, maximizando las horas del día en que tu cuerpo está activamente quemando grasa.",
            "<strong>Optimizar con Electrolitos:</strong> Este paso no es opcional. La pérdida de agua inicial arrastra minerales. Prepara tu suero con <strong>agua mineral, sal de mar y limón</strong> y bébelo durante el día para evitar fatiga o calambres."
        ]
    },
    energy: {
        science: `Un objetivo fantástico y uno de los beneficios más sorprendentes para muchos. Piénsalo de esta manera: tu cerebro ha estado funcionando con glucosa (azúcar), que es como echarle a un auto de lujo la gasolina de peor calidad. Te da picos de energía seguidos de caídas bruscas, lo que causa esa 'niebla mental' y el cansancio de la tarde.<br><br>Cuando tu cuerpo entra en cetosis, empieza a producir <strong>cetonas</strong>. Las cetonas son un <strong>súper-combustible</strong> para el cerebro. Son una fuente de energía mucho más limpia, estable y duradera que la glucosa. Al darle a tu cerebro este combustible premium, lo que experimentarás no es una energía nerviosa como la del café, sino una <strong>calma enfocada</strong>.`,
        steps: [
            "<strong>Fase de Adaptación (Semana 1-2):</strong> Tu prioridad absoluta es enseñarle a tu cerebro a pedir el nuevo combustible. Elimina por completo azúcares, harinas y procesados. No te preocupes por contar calorías, solo enfócate en comer alimentos de nuestra lista de compras hasta sentirte saciado.",
            "<strong>Prioriza las Grasas Inteligentes:</strong> Tu cerebro está composto en un 60% por grasa. Dale los mejores materiales. Incorpora a diario palta (aguacate), aceite de oliva extra virgen, aceitunas y considera añadir aceite MCT a tu café o batidos para un impulso cetónico directo al cerebro.",
            "<strong>Hidratación Neuronal:</strong> Un cerebro deshidratado es un cerebro lento. Prepara tu suero diario con <strong>agua mineral, sal de mar y limón</strong>. Los electrolitos son cruciales para la comunicación entre neuronas y la claridad mental.",
            "<strong>Introduce el Ayuno 16/8:</strong> Una vez adaptado (después de la semana 2), intenta consolidar tus comidas en una ventana de 8 horas. Este período de ayuno de 16 horas potenciará la producción de cetonas y activará la autofagia, un proceso de limpieza celular que es increíblemente beneficioso para la salud neuronal."
        ]
    },
    health: {
        science: `Has elegido el camino más profundo y poderoso. La mayoría de las condiciones de salud crónicas modernas no son fallos de tu cuerpo, sino respuestas lógicas a un ambiente hostil, principalmente uno pro-inflamatorio. El azúcar y los carbohidratos refinados son los principales culpables, actúan como un incendio constante a nivel celular.<br><br>Al cambiar tu fuente de energía a grasas saludables, no solo quitamos el combustible a ese incendio, sino que producimos <strong>cetonas</strong>, que son moléculas de señalización que activamente le dan a tus genes la orden de <strong>reducir la inflamación</strong>. Estamos, literalmente, cambiando la expresión de tus genes hacia un estado de reparación y equilibrio.`,
        steps: [
            "<strong>Apagar el Fuego Inflamatorio:</strong> Tu primer paso, no negociable, es cortar de raíz los principales agentes inflamatorios: azúcar, harinas, granos y aceites de semilla (girasol, canola, soya). Esto es como dejarleña al fuego.",
            "<strong>Construir con Materiales Anti-inflamatorios:</strong> Prioriza grasas como la palta (aguacate), el aceite de oliva y el pescado graso (rico en Omega-3). Estas grasas son los ladrillos que tus células usarán para reparar sus membranas y calmar la inflamación.",
            "<strong>Activar la Limpieza Celular (Autofagia):</strong> Introduce un ayuno intermitente suave, como el 16/8 (16 horas de ayuno, 8 para comer). Este período sin comer le da a tu cuerpo el tiempo y la señal para activar un proceso de 'reciclaje' interno, donde elimina las células dañadas que perpetúan la inflamación.",
            "<strong>Reducir el Estrés Metabético:</strong> El estrés crónico libera cortisol, una hormona que puede sabotear tus esfuerzos. Dedica 10 minutos diarios a una actividad relajante (caminar, respirar, meditar). Calmar tu sistema nervioso es tan importante como calmar la inflamación con la comida."
        ]
    },
    muscle: {
        science: `Perfecto. Este es un punto donde hay muchos mitos. La gente cree que Keto te hace perder músculo, y es todo lo contrario si se hace bien. Una alimentación cetogénica bien formulada es <strong>'protectora de la masa muscular'</strong>. Cuando tu cuerpo se adapta a quemar grasa, deja de tener la necesidad de recurrir a las proteínas (tus músculos) para obtener energía.<br><br>El resultado es lo que llamamos <strong>'recomposición corporal'</strong>. Al usar la grasa como energía, tu cuerpo se vuelve increíblemente eficiente en eliminar la grasa que recubre los músculos, mientras que preserva la masa magra. Esto es lo que produce esa apariencia tonificada y definida que buscas. Además, la reducción de la inflamación general te ayudará a recuperarte mejor y más rápido de tus entrenamientos.`,
        steps: [
            "<strong>Calcula tu Proteína Objetivo:</strong> Este es tu paso más importante. Apunta a consumir entre 1.6 y 2.2 gramos de proteína por cada kilogramo de tu peso corporal ideal. Divide esa meta entre tus comidas. La proteína es el ladrillo para tus músculos.",
            "<strong>Entrenamiento de Fuerza es Prioridad:</strong> Debes darle a tus músculos una razón para crecer. Prioriza el entrenamiento con pesas (pesas, calistenia) al menos 3-4 veces por semana, enfocándote en la sobrecarga progresiva (levantar un poco más o hacer más repeticiones con el tiempo).",
            "<strong>Usa la Grasa como Palanca Energética:</strong> La grasa es tu energía para entrenar. No le temas. Asegúrate de consumir suficientes grasas saludables para sentirte con energía durante tus sesiones. Si te sientes débil, probablemente necesites más grasa, no más carbohidratos.",
            "<strong>El Sueño es Anabólico:</strong> El músculo no crece en el gimnasio, crece mientras duermes. Apunta a 7-9 horas de sueño de calidad por noche. Durante el sueño profundo, tu cuerpo libera hormona de crecimiento, que es esencial para la reparación y el crecimiento muscular."
        ]
    }
};

// --- 100% REWRITTEN CONTENT FOR ORIGINALITY AND PLAGIARISM-FREE GUARANTEE ---
const pathologyExplanations = {
    insulin_resistance: {
        title: "Punto de Enfoque: Resistencia a la Insulina / Diabetes tipo 2",
        cause: "Piensa en tus células como casas y en la insulina como el cartero que entrega el paquete de energía (glucosa). Cuando hay resistencia, es como si las casas dejaran de abrirle la puerta al cartero. La energía se queda 'dando vueltas en la calle' (tu sangre), sin poder ser usada y generando problemas.",
        action: "Este plan cambia las reglas del juego. En vez de depender del 'cartero', le enseñamos a tu cuerpo a usar su propia reserva de combustible: la grasa. Al bajar los carbohidratos, la insulina se toma un descanso, permitiendo que las 'casas' vuelvan a ser receptivas. Es un reinicio metabólico para que tu cuerpo use la energía de forma eficiente."
    },
    hypertension: {
        title: "Punto de Enfoque: Hipertensión",
        cause: "Tus arterias deberían ser como mangueras nuevas y flexibles. La hipertensión a menudo significa que esas 'mangueras' se han endurecido por la inflamación crónica, como una manguera vieja al sol. Esto obliga a tu corazón a bombear con mucha más fuerza para que la sangre circule, aumentando la presión en todo el sistema.",
        action: "Nuestra estrategia es 'rejuvenecer' esas mangueras desde adentro. Al eliminar los alimentos pro-inflamatorios como el azúcar y las harinas, y enfocarnos en nutrientes que combaten la inflamación, le devolvemos la flexibilidad a tus arterias. Esto le quita un tremendo peso de encima a tu corazón, permitiendo que la presión arterial baje de forma natural."
    },
    fatty_liver: {
        title: "Punto de Enfoque: Hígado Graso",
        cause: "El hígado es la 'bodega' principal de tu cuerpo. Cuando lo inundas con un exceso de azúcar y carbohidratos, la bodega se llena y el hígado no tiene más opción que empezar a guardar esa energía extra en forma de grasa dentro de sus propias paredes, lo que lo 'ahoga' y le impide hacer bien su trabajo.",
        action: "Lo que haremos es simple: cerraremos la llave de paso del azúcar. Al hacer esto, no solo detenemos la acumulación de nueva grasa, sino que forzamos al hígado a abrir las compuertas de la 'bodega' y a quemar la grasa ya almacenada para obtener energía. Es una desintoxicación y un alivio directo para tu motor metabólico."
    },
    hypothyroidism: {
        title: "Punto de Enfoque: Hipotiroidismo",
        cause: "La tiroides es el 'termostato' de tu metabolismo. En el hipotiroidismo, este termostato funciona a un ritmo más bajo, causando cansancio y lentitud. Este estado a menudo se ve empeorado por una inflamación corporal generalizada, que actúa como un 'ruido de fondo' que interfiere aún más con la señal de la tiroides.",
        action: "Este plan actúa como un 'aislante acústico' para tu metabolismo. Al ser profundamente antiinflamatorio, reducimos ese 'ruido de fondo', permitiendo que la función tiroidea que tienes trabaje de forma más eficiente. Aunque no es un reemplazo de tu tratamiento, muchas personas sienten un aumento significativo de energía y vitalidad al quitarle esta carga extra al cuerpo."
    },
    inflammation: {
        title: "Punto de Enfoque: Inflamación Sistémica",
        cause: "La inflamación es la respuesta natural del cuerpo a una agresión. El problema es la inflamación crónica: es como tener una gotera en casa que nunca reparas. Día tras día, esa pequeña gotera (causada por el azúcar, el estrés, los malos aceites) va dañando la estructura, generando un desgaste silencioso que es la base de muchas enfermedades.",
        action: "Este plan es como llamar al mejor gásfiter para tu cuerpo. Primero, cerramos la llave de paso (eliminamos el azúcar y los procesados). Segundo, usamos materiales de reparación de alta calidad (grasas saludables y nutrientes). Y tercero, las cetonas que producirás actúan como un sellador anti-fugas, combatiendo activamente la inflamación y permitiendo que tu cuerpo se repare de verdad."
    },
    insomnia: {
        title: "Punto de Enfoque: Insomnio y Fatiga Crónica",
        cause: "Tu energía diaria y tu sueño nocturno son dos caras de la misma moneda: el azúcar en la sangre. Si durante el día vives en una 'montaña rusa' de energía por el azúcar (subidones y bajones bruscos), por la noche tu cerebro sigue en esa misma montaña rusa, impidiendo un sueño profundo y reparador.",
        action: "El plan Keto te baja de la montaña rusa y te sube a un 'auto de lujo en carretera'. La energía que obtienes de las grasas es estable, predecible y duradera. Esto no solo te da una vitalidad constante durante el día, sin 'bajones', sino que le da a tu cerebro la calma y estabilidad que necesita para tener un sueño de calidad y verdaderamente reparador."
    }
};

// --- LIBRERÍA DE CONSEJOS PARA HÁBITOS ---
const habitAdviceLibrary = {
    'sleep_less': {
        title: 'Sobre Dormir Poco',
        text: 'Dormir menos de 7 horas dispara la hormona del estrés, cortisol. Esto no solo aumenta el azúcar en sangre y promove el almacenamiento de grasa abdominal, sino que también incrementa la grelina, la hormona del hambre, provocando antojos de energía rápida (azúcar) al día siguiente. Priorizar el sueño es una estrategia metabólica fundamental.'
    },
    'dine_late': {
        title: 'Sobre Comer Tarde por la Noche',
        text: 'Cenar tarde crea una batalla hormonal. Tu cuerpo intenta liberar melatonina para iniciar el descanso, pero al mismo tiempo debe liberar insulina para gestionar la comida. Esto interrumpe la calidad del sueño profundo, impide la quema de grasa nocturna y la autofagia (limpieza celular), procesos clave para la reparación y la pérdida de peso.'
    },
    'low_salt': {
        title: 'Sobre Consumir Poca Sal',
        text: 'Contrario a la creencia popular, en una dieta baja en carbohidratos, el cuerpo excreta más sodio. La falta de sal (sodio) es la causa principal de la "gripe keto", calambres y fatiga. Necesitas MÁS sal de buena calidad (sal de mar) para mantener el equilibrio de electrolitos, la energía y la función de tus glándulas suprarrenales.'
    },
    'sweet_cravings': {
        title: 'Sobre los Antojos de Dulces',
        text: 'Los antojos de dulces son un síntoma de una montaña rusa de azúcar en sangre. Cada vez que comes azúcar, tu insulina se dispara para bajarla, y la caída brusca te hace desear más azúcar. Es un círculo vicioso. Al eliminar el azúcar y usar grasas como energía, estabilizas el azúcar en sangre y las cetonas reducen los antojos a nivel cerebral.'
    },
    'love_soda': {
        title: 'Sobre las Gaseosas y Energéticas',
        text: 'Las gaseosas, incluso las "dietéticas", son metabólicamente dañinas. Las azucaradas son una bomba de azúcar directo al hígado, promoviendo el hígado graso. Las "diet" con edulcorantes artificiales pueden alterar tu microbiota intestinal y, en algunas personas, generar una respuesta de insulina, manteniendo vivos los antojos por lo dulce.'
    }
};

// --- LIBRERÍA PSICOLÓGICA COMBINADA ---
const psicologiaCombinada = {
    'yes': {
        'always': {
            enfoquePsicologico: "Gracias por tu valentía al compartir esto. Es vital que reconozcas esta intensa conexión: cuando el estrés es constante, tu cuerpo está en modo de supervivencia y busca alivio inmediato. Comer por emoción no es una falla de voluntad, sino una respuesta bioquímica para obtener una dosis rápida de calma a través de la comida. Este plan está diseñado para romper ese ciclo, dándote energía estable desde las grasas para que tu cerebro no necesite esos 'rescates' de azúcar.",
            consejoAntiEstres: "Como un primer paso para recuperar el control, te propongo una 'Pausa de Anclaje' de 1 minuto. Cuando sientas que el estrés te desborda, detente. Pon una mano sobre tu pecho y siente tu respiración. No intentes cambiarla, solo siéntela. Este simple acto físico te reconecta con tu cuerpo en el presente y crea un espacio entre el impulso y la acción, dándote el poder de elegir."
        },
        'often': {
            enfoquePsicologico: "Reconocer que el hambre emocional aparece junto al estrés frecuente es un paso gigante. Tu cuerpo ha aprendido que la comida puede ser una forma rápida de apagar la 'alarma' del estrés. Nuestro objetivo es darle a tu cuerpo una fuente de energía tan estable (las grasas) que ya no necesite sonar esa alarma con tanta frecuencia, reduciendo la urgencia de comer por impulso.",
            consejoAntiEstres: "Para manejar el estrés frecuente, prueba la técnica 'Soltar la Carga'. Al final del día, toma 3 minutos para escribir en un papel todo lo que te preocupó. No tienes que solucionarlo, solo sacarlo de tu mente y ponerlo en el papel. Este acto simbólico le dice a tu cerebro que puede 'soltar' esas preocupaciones por la noche, permitiendo un descanso más reparador."
        },
        'sometimes': {
            enfoquePsicologico: "Es muy común que en los picos de estrés, aunque sean ocasionales, recurramos a la comida como una forma de consuelo. Lo importante es que ya lo identificas. Con este plan, al tener tu azúcar en sangre estable, notarás que en esos momentos de estrés, la 'voz' que pide comida pierde mucha fuerza, dándote más control.",
            consejoAntiEstres: "Para esos momentos de estrés ocasional, usa el 'Cambio de Escena'. En lugar de ir a la cocina, sal a caminar 5 minutos, escucha una canción que te guste mucho o llama a un amigo. Cambiar tu entorno físico y mental rompe el patrón automático que te lleva del estrés a la comida."
        },
        'never': {
            enfoquePsicologico: "Es interesante que, aunque no sientas estrés, sí identifiques el hambre emocional. Esto puede indicar que el hábito está muy arraigado o que la causa es puramente bioquímica: la montaña rusa del azúcar. Al estabilizar tu glucosa con Keto, le quitamos el combustible a ese impulso, permitiéndote nutrir tu cuerpo con verdadera intención.",
            consejoAntiEstres: "Ya que no sientes estrés, tu herramienta será la 'Nutrición Consciente'. Antes de comer, pregúntate: '¿Esto es hambre real o es un hábito?'. Tómate un vaso de agua y espera 5 minutos. Esta simple pausa te dará la claridad para diferenciar el hambre física de la emocional."
        }
    },
    'sometimes': {
        'always': {
            enfoquePsicologico: "Es una carga muy pesada vivir con estrés constante, y es natural que 'a veces' la comida se convierta en una válvula de escape. El problema es que el alivio es momentáneo y el ciclo continúa. Al darle a tu cerebro energía limpia y constante con las cetonas, reduciremos la necesidad de esas 'escapadas' y te daremos más resiliencia frente al estrés.",
            consejoAntiEstres: "Cuando el estrés es tu estado base, necesitas una rutina de 'descompresión'. Dedica 5 minutos cada mañana, antes de empezar tu día, a sentarte en silencio y enfocarte en un sonido agradable (pájaros, música suave). Esto establece un tono de calma para el resto del día, haciendo que el estrés sea menos reactivo."
        },
        'often': {
            enfoquePsicologico: "Esta combinación es muy común. El estrés frecuente desgasta nuestras defensas y nos hace más vulnerables a caer en el hambre emocional. La buena noticia es que al atacar la raíz bioquímica con Keto, fortalecemos esas defensas. Notarás que, aunque el estrés aparezca, tu respuesta automática de buscar comida disminuirá significativamente.",
            consejoAntiEstres: "Implementa la 'Regla del Bloqueo de 10 minutos'. Cuando el estrés te haga pensar en comida, pon una alarma para 10 minutos. En ese tiempo, bebe un té o haz una tarea simple. Nueve de cada diez veces, cuando la alarma suene, el impulso intenso habrá pasado, demostrándote que tienes el control."
        },
        'sometimes': {
            enfoquePsicologico: "Reconocer que ambos factores aparecen 'a veces' es clave. Significa que tienes una buena base de control, pero hay detonantes específicos que activan el ciclo. Este plan te ayudará a ser aún más consciente de esos momentos, ya que al no tener picos de glucosa, será más fácil identificar si el hambre es real o una respuesta a una situación concreta.",
            consejoAntiEstres: "Tu herramienta será el 'Diario de Detonantes'. Cuando sientas la combinación de estrés y ganas de comer por emoción, anota rápidamente qué pasó justo antes. ¿Una reunión difícil? ¿Una mala noticia? Identificar tus patrones es el primer paso para desactivarlos."
        },
        'never': {
            enfoquePsicologico: "Aquí vemos que el hambre emocional, aunque ocasional, no está ligada al estrés. Esto apunta fuertemente a una causa fisiológica. Probablemente, tus 'antojos' ocasionais coinciden con bajadas de azúcar en sangre. Keto es la solución perfecta para esto, ya que elimina esa montaña rusa de glucosa.",
            consejoAntiEstres: "Tu práctica será la 'Planificación de Snacks Inteligentes'. Ten siempre a mano un snack keto aprobado (un puñado de almendras, unas aceitunas). Así, cuando aparezca el impulso, tienes una opción que te saciará sin sacarte del plan y sin reforzar el ciclo del azúcar."
        }
    },
    'rarely': {
        'always': {
            enfoquePsicologico: "Es admirable que, a pesar de sentirlo constantemente, muy rara vez recurras a la comida. Esto demuestra una gran fortaleza mental. Sin embargo, ese estrés crónico sigue afectando tu metabolismo. Este plan te ayudará a combatir el estrés desde adentro, reduciendo la inflamación que genera y dándote más energía para afrontarlo.",
            consejoAntiEstres: "Para ti, el foco es la recuperación. El estrés crónico agota los nutrientes. Asegúrate de cumplir con tu ingesta de electrolitos (especialmente magnesio antes de dormir) y considera un suplemento de Omega-3. Nutrir tu sistema nervioso es la mejor defensa contra el estrés a largo plazo."
        },
        'often': {
            enfoquePsicologico: "Tienes un excelente control, ya que a pesar del estrés frecuente, el hambre emocional es rara. Esto nos dice que tu principal batalla es contra los efectos fisiológicos del estrés. Al adoptar Keto, le darás a tu cuerpo una energía más resiliente que te ayudará a manejar esos periodos de estrés con mayor calma y claridad.",
            consejoAntiEstres: "Prueba la 'Respiración Cuadrada'. Inhala durante 4 segundos, sostén el aire 4 segundos, exhala durante 4 segundos y mantente sin aire 4 segundos. Repite 5-10 veces. Es una técnica usada por atletas y militares para calmar el sistema nervioso rápidamente en momentos de alta presión."
        },
        'sometimes': {
            enfoquePsicologico: "Este es un perfil muy resiliente. Indica que tienes una relación muy consciente con la comida y buenas herramientas para manejar el estrés. Este plan actuará como un optimizador, llevando tu bienestar y claridad mental al siguiente nivel, haciendo que esos raros episodios sean aún menos frecuentes.",
            consejoAntiEstres: "Tu estrategia es la 'Prevención'. Si sabes que vas a entrar en una situación estresante (ej. una presentación importante), ten una comida rica en grasas saludables y proteínas antes. Un cerebro bien nutrido y saciado es mucho menos susceptible al estrés."
        },
        'never': {
            enfoquePsicologico: "Este es el escenario ideal. No sufres de estrés y el hambre emocional es prácticamente inexistente. Tienes una base psico-metabólica sólida. Para ti, este plan no es una reparación, es una optimización para alcanzar tu máximo potencial de energía y rendimiento cognitivo.",
            consejoAntiEstres: "Tu práctica es la 'Gratitud Activa'. Cada día, piensa en tres cosas específicas por las que estás agradecido. Esto refuerza las vías neuronales positivas y protege tu mente contra el estrés futuro, manteniendo esa fortaleza que ya posees."
        }
    },
    'never': {
        'always': {
            enfoquePsicologico: "Es impresionante que nunca uses la comida para lidiar con el estrés, a pesar de sentirlo constantemente. Tienes una disciplina de hierro. Sin embargo, ese estrés crónico sigue afectando tu metabolismo a nivel hormonal. Este plan te ayudará a mitigar ese daño interno, reduciendo la inflamación y dándote una energía más estable.",
            consejoAntiEstres: "Tu enfoque debe ser el movimiento. El ejercicio de baja intensidad, como una caminata diaria de 30 minutos, es una de las formas más efectivas de 'quemar' el exceso de cortisol y adrenalina generados por el estrés crónico. No es para quemar calorías, es para limpiar tu sistema."
        },
        'often': {
            enfoquePsicologico: "Tienes una excelente disociación entre emoción y comida. El estrés frecuente sigue siendo un desafío metabólico. Al cambiar a Keto, tu cuerpo y cerebro tendrán un combustible más eficiente, lo que te hará sentir más ecuánime y con mayor capacidad para gestionar esos picos de estrés sin que te agoten.",
            consejoAntiEstres: "Usa la 'Técnica de la Perspectiva'. Cuando te sientas estresado, pregúntate: '¿Esto importará en 5 días? ¿En 5 meses? ¿En 5 años?'. Esta pregunta ayuda a redimensionar el problema y a reducir la respuesta de estrés inmediata."
        },
        'sometimes': {
            enfoquePsicologico: "Este es un perfil muy resiliente. Tienes una relación sana con la comida y manejas bien el estrés ocasional. Para ti, este plan es una herramienta de bio-hacking para optimizar tu rendimiento, dándote una claridad mental y una energía física aún mayores.",
            consejoAntiEstres: "Tu herramienta es la 'Planificación Proactiva'. Identifica qué situaciones te generan estrés y planifica cómo las afrontarás. Tener un plan de acción reduce la ansiedad anticipatoria y te da una sensación de control que minimiza el impacto del estrés cuando llega."
        },
        'never': {
            enfoquePsicologico: "Felicidades, este es el estado óptimo de bienestar psico-metabólico. Tienes una relación impecable con la comida y un sistema nervioso bien regulado. Este plan te servirá para explorar los beneficios más profundos de la cetosis, como la longevidad celular y el máximo rendimiento cognitivo.",
            consejoAntiEstres: "Tu práctica es el 'Reto Positivo'. Ya que no tienes que luchar contra el estrés, canaliza esa energía en un nuevo reto que te entusiasme: aprender una nueva habilidad, un nuevo deporte. Esto mantiene tu cerebro plástico y tu motivación alta."
        }
    }
};

// --- LIBRERÍA DE CONSEJOS PARA COMIDA CHATARRA ---
const junkFoodAdviceLibrary = {
    'rarely': {
        text: "¡Excelente! Disfrutar de un gusto de vez en cuando es parte de un estilo de vida sostenible. La clave es hacerlo de forma inteligente. La próxima vez que tengas antojo de una hamburguesa, te retamos a que la prepares en casa. Imagina: carne de alta calidad, queso derretido, tocino crujiente, palta y tus vegetales favoritos... todo dentro de un <strong>delicioso pan de hamburguesa keto</strong> que puedes hacer tú mismo o encontrar en tiendas especializadas. Descubrirás que la versión casera y keto no solo es increíblemente sabrosa, sino que te dejará sintiéndote con energía, no inflamado."
    },
    '1-2_weekly': {
        text: "Gracias por tu honestidad. Es importante que sepas que consumir comida chatarra varias veces por semana somete a tu cuerpo a un estrés metabólico constante. No se trata solo de calorías, sino de una avalancha de inflamación. Los aceites vegetales refinados (soya, canola) aumentan la inflamación celular, mientras que el exceso de azúcar y harinas dispara tu insulina, promoviendo el almacenamiento de grasa y alimentando un ciclo de antojos. Este plan está diseñado para darte las herramientas para romper ese ciclo."
    },
    '3-4_weekly': {
        text: "Gracias por tu honestidad. Es importante que sepas que consumir comida chatarra varias veces por semana somete a tu cuerpo a un estrés metabólico constante. No se trata solo de calorías, sino de una avalancha de inflamación. Los aceites vegetales refinados (soya, canola) aumentan la inflamación celular, mientras que el exceso de azúcar y harinas dispara tu insulina, promoviendo el almacenamiento de grasa y alimentando un ciclo de antojos. Este plan está diseñado para darte las herramientas para romper ese ciclo."
    },
    'daily': {
        text: `Aquí necesitamos ser completamente transparentes. Comer comida rápida a diario es una de las acciones más perjudiciales para tu salud a largo plazo. Es similar a la advertencia que las cadenas de comida rápida están obligadas a mostrar: estos alimentos están asociados a enfermedades graves. Esto se debe a que no solo consumes calorías vacías, sino un cóctel de químicos diseñados para crear adicción.<br><br>
        <strong>Algunos de los ingredientes que estás ingeriendo son:</strong><br>
        <ul class="list-disc list-inside mt-2 space-y-1">
            <li><strong>Aceites Hidrogenados (Grasas Trans):</strong> Se utilizan para freír porque son baratos y reutilizables. Tu cuerpo no puede procesarlos, lo que causa inflamación masiva en tus arterias y células.</li>
            <li><strong>Jarabe de Maíz de Alta Fructosa:</strong> Un azúcar ultraprocesado que va directo a tu hígado, convirtiéndose en grasa y siendo un precursor directo del hígado graso y la resistencia a la insulina.</li>
            <li><strong>Glutamato Monosódico (GMS):</strong> Un potenciador del sabor que 'engaña' a tu cerebro, haciéndote comer más de lo que necesitas y anulando tus señales naturales de saciedad.</li>
            <li><strong>Acrilamidas:</strong> Un compuesto químico que se forma en alimentos ricos en almidón (como las papas fritas) al ser cocinados a altas temperaturas. Las agencias de salud lo clasifican como un probable carcinógeno.</li>
        </ul><br>
        La decisión de seguir este plan es el primer paso para liberar a tu cuerpo de esta carga tóxica.`
    }
};

// --- LIBRERÍA DE CONSEJOS PARA BEBIDAS ---
const drinksAdviceLibrary = {
    'water': {
        title: 'La Jerarquía de la Hidratación',
        text: "Has elegido el pilar fundamental de la vida, pero es crucial entender que no toda el agua hidrata de la misma manera.<br><ul class='list-disc list-inside mt-2 space-y-1'><li><strong>Agua de la Llave:</strong> A menudo contiene aditivos como el cloro, que puede dañar tu microbiota, y el flúor, un disruptor endocrino que puede calcificar la glándula pineal, reguladora de tus ciclos de sueño.</li><li><strong>Agua Purificada:</strong> Es un agua 'muerta' y desmineralizada que puede 'robar' minerales de tu cuerpo.</li><li><strong>Agua Mineral:</strong> Es la opción superior, cargada de electrolitos naturales para una verdadera hidratación celular.</li></ul>"
    },
    'juice': {
        title: 'La Verdad Tóxica de la Fructosa',
        text: "Los jugos, incluso naturales, son una bomba de **fructosa** líquida. Su metabolismo en el hígado consume energía (ATP) y genera un residuo tóxico: **ácido úrico**. El ácido úrico elevado puede cristalizarse en las articulaciones causando **Gota** y, además, inhibe la producción de **óxido nítrico**, crucial para la salud de tus vasos sanguíneos y la presión arterial."
    },
    'soda': {
        title: 'El Cóctel Químico de las Gaseosas',
        text: "Las gaseosas, incluidas las 'diet', son un ataque químico a tu metabolismo. Las azucaradas conducen al hígado graso. Las 'diet' usan químicos como el **aspartamo** (asociado en estudios con daños neurológicos) y el **colorante caramelo (E150d)**, cuyo proceso de fabricación genera 4-MEI, un posible carcinógeno."
    },
    'coffee': {
        title: 'El Doble Filo del Café',
        text: "El café es una potente herramienta metabólica por sus antioxidantes. Sin embargo, es un diurético y su alto contenido en **oxalatos** puede aumentar el riesgo de cálculos renales si no se gestiona con una hidratación inteligente."
    },
    'tea': {
        title: 'El Doble Filo del Té',
        text: "El té, especialmente el verde, es rico en antioxidantes. No obstante, al igual que el café, es un diurético y contiene oxalatos. La clave es la moderación y acompañarlo siempre de agua mineralizada."
    },
    'smart_combo': {
        title: 'Sinergia de Hidratación Inteligente',
        text: "¡Esta es una combinación estratégica! Entiendes que el café/té aporta beneficios, pero que la verdadera **homeostasis hídrica** (el equilibrio de agua en tus células) depende de minerales como el **sodio, potasio y magnesio**.<br><br><strong>Tu Protocolo Experto:</strong> Por cada taza de café o té, bebe un vaso de agua mineral con una pizca de **sal de mar** (para el sodio y oligoelementos) y el **jugo de medio limón**. La sal repone los electrolitos que el café/té elimina, y el citrato del limón es el inhibidor natural más potente de la formación de cálculos de oxalato. Con esta estrategia, obtienes todos los beneficios mientras anulas todos los riesgos."
    }
};

const personalizedAdviceLibrary = {
    alcohol_intake: {
        'yes': {
            emoji: '🛑',
            title: "Foco Rojo: Consumo Regular de Alcohol",
            text: "El consumo de alcohol afecta gravemente al hígado, provoca inflamación, acumulación de grasa y cicatrices, lo que puede derivar en enfermedades hepáticas graves como la cirrosis. Además, puede interferir con el metabolismo de las grasas y dificultar la pérdida de peso, lo que va en contra de los principios de la dieta cetogénica."
        },
        'occasionally': {
            emoji: '🥂',
            title: "Brindis Inteligente: Alcohol en Ocasiones",
            text: "Debemos aclarar que no recomendamos el consumo de alcohol para la dieta keto!, ya que te saca completamente de cetosis. y no ayuda en nada a nuestro hígado. Pero entendemos que la vida tiene momentos para celebrar. ¡No se trata de prohibir, sino de elegir sabiamente! Para esas ocasiones, prefiere destilados puros (whisky, gin, vodka, tequila) con agua mineral y hielo, o comparte una botella de vino (sin azúcar adicionada o vinos soleados). Al final de la lista, cerveza ligera y espumantes Brut Nature o Extra Brut . Así minimizas el azúcar y el impacto en tu progreso. ¡Salud por eso!"
        },
        'no': {
            emoji: '🏆',
            title: "¡Decisión de Campeón!",
            text: "¡Excelente! Esta es una de las decisiones que más acelera los resultados. Al no consumir alcohol, le das a tu hígado la libertad para enfocarse 100% en quemar grasa y desintoxicar tu cuerpo. Tienes una ventaja competitiva enorme. ¡Felicidades!"
        }
    },
    cooking_skill: {
        'no': {
            emoji: '🍳',
            title: "¡Bienvenido a tu Nueva Cocina!",
            text: "¡No te preocupes en absoluto! Nuestras recetas están diseñadas para ser a prueba de principiantes: sencillas, rápidas y deliciosas. Verás que te conviertes en un chef keto con confianza antes de lo que imaginas. ¡Este es el inicio de una nueva habilidad!"
        },
        'beginner': {
            emoji: '👨‍🍳',
            title: "De Principiante a Profesional Keto",
            text: "¡Perfecto! Tienes la curiosidad y las ganas, que es lo más importante. Con nuestra guía, pasarás de amateur a un cocinero keto seguro, sorprendiendo a todos (incluyéndote a ti) con platos increíbles y saludables."
        },
        'intermediate': {
            emoji: '🔥',
            title: "Perfeccionando tus Habilidades",
            text: "¡Genial! Ya tienes una base sólida. Este plan te dará las herramientas y los 'secretos' keto para llevar tus habilidades al siguiente nivel. Aprenderás a optimizar sabores y nutrientes para potenciar aún más tus resultados."
        },
        'advanced': {
            emoji: '🌟',
            title: "El Lado Gourmet de Keto te Espera",
            text: "¡Fantástico! Un chef en la cocina. Prepárate para explorar el lado más sofisticado de Keto. Con tu habilidad, podrás crear verdaderas obras de arte culinarias que no solo son deliciosas, sino que son tu mejor medicina."
        }
    },
    activity_level: {
        'sedentary': {
            emoji: '🌱',
            title: "Este es el comienzo de tu Transformación",
            text: "Este es el punto de partida perfecto para un cambio increíble. Nuestras mitocondrias son las fuentes energéticas de nuestro cuerpo, y se multiplican principalmente a través de un proceso llamado biogénesis mitocondrial, que es estimulado por el ejercicio físico. a mas mitocondrias, más grasa quemas!. No necesitas ser un atleta. Empezaremos a despertar tu metabolismo con movimientos y rutinas suaves y efectivos. Cada paso, por pequeño que sea, construye un gran progreso."
        },
        'light': {
            emoji: '🚶‍♂️',
            title: "Encendiendo tu Metabolismo.",
            text: "¡Excelente! Ya tienes el hábito del movimiento, y eso es una gran victoria. Ahora, vamos a optimizar esa actividad para que cada paso se convierta en una señal potente para pasar al próximo nivel, quemar grasa y construir energía duradera."
        },
        'moderate': {
            emoji: '💪',
            title: "Hacia un Nuevo Nivel de Energía",
            text: "Estás en el punto ideal. Al combinar tu entrenamiento con la energía estable de Keto, vas a experimentar una resistencia y potencia que quizás no conocías. Prepárate para superar tus propios límites y transformar tu cuerpo."
        },
        'high': {
            emoji: '🚀',
            title: "Rendimiento de Élite",
            text: "Impresionante. Ya estás construyendo tu mejor versión!. La alimentación Keto puede ser el eslabón perdido para llevar tu rendimiento y recuperación a un nivel superior. Usaremos la grasa como un combustible de alto octanaje para tu motor. ¡A romper tus propios récords!"
        }
    },
    eat_out_freq: {
        'daily': {
            emoji: '🏙️',
            title: "Navegando el Menú como un Experto",
            text: "Comer fuera a diario es un desafío, pero no un obstáculo insuperable. En nuestra guía, encontrarás una sección dedicada a convertirte en un 'detective de menús', para que sepas exactamente qué pedir y qué evitar para mantenerte en cetosis y disfrutar."
        },
        'weekly': {
            emoji: '🍽️',
            title: "Disfrutando Fuera de Casa",
            text: "Perfecto para mantener un equilibrio. Te enseñaremos los trucos para que tus salidas semanales sean un placer sin culpa. Aprenderás a elegir platos que te mantengan en el camino correcto sin sacrificar tu vida social."
        },
        'monthly': {
            emoji: '🎉',
            title: "Salidas Ocasionales, Cero Estrés",
            text: "Tus salidas son un gusto especial, y así deben seguir. Te daremos una guía rápida para que, cuando llegue la ocasión, sepas exactamente qué opciones del menú son tus aliadas para seguir disfrutando y progresando."
        },
        'rarely': {
            emoji: '🏡',
            title: "El Control está en tus Manos",
            text: "¡Esto es una gran ventaja! Cocinar en casa te da el máximo control sobre la calidad de tus ingredientes. Y para esas raras ocasiones que comas fuera, nuestra guía te preparará para que lo hagas como un profesional."
        }
    }
};


const imcCategories = [
    { range: [0, 15.9], name: 'Delgadez Severa', rangeText: '< 16.0', definition: 'Un peso significativamente bajo que puede suponer un riesgo para la salud.' },
    { range: [16, 16.9], name: 'Delgadez Moderada', rangeText: '16.0 - 16.9', definition: 'Indica un peso bajo. Es importante asegurar una nutrición adecuada.' },
    { range: [17, 18.4], name: 'Delgadez Aceptable', rangeText: '17.0 - 18.4', definition: 'Estás en el límite inferior del peso saludable. Un plan bien estructurado te ayudará.' },
    { range: [18.5, 24.9], name: 'Peso Normal', rangeText: '18.5 - 24.9', definition: '¡Felicidades! Tu peso está en un rango saludable y equilibrado.' },
    { range: [25, 29.9], name: 'Sobrepeso', rangeText: '25.0 - 29.9', definition: 'Indica un exceso de peso corporal que puede aumentar el riesgo de problemas de salud.' },
    { range: [30, 34.9], name: 'Obesidad Tipo I', rangeText: '30.0 - 34.9', definition: 'Un nivel de exceso de peso que requiere atención para prevenir complicaciones de salud.' },
    { range: [35, 39.9], name: 'Obesidad Tipo II', rangeText: '35.0 - 39.9', definition: 'Considerada una obesidad severa. Es un buen momento para tomar acción.' },
    { range: [40, 49.9], name: 'Obesidad Tipo III (Mórbida)', rangeText: '40.0 - 49.9', definition: 'Un grado de obesidad que presenta un alto riesgo para la salud. Este plan es un gran primer paso.' },
    { range: [50, Infinity], name: 'Obesidad Tipo IV (Extrema)', rangeText: '≥ 50.0', definition: 'El nivel más alto de obesidad, que requiere un plan de acción inmediato y supervisado.' }
];

// --- App Start & Wizard Logic ---
function startQuestionnaire() {
    console.log("Starting questionnaire...");
    const accessScreen = document.getElementById('access-screen');
    const wizard = document.getElementById('onboarding-wizard');
    if (accessScreen) accessScreen.classList.add('hidden');
    
    if (wizard) {
        appState.wizardFlow = [...baseWizardSteps, { id: 'action_plan', type: 'action_plan' }];
        appState.currentStepIndex = 0;
        document.getElementById('app-container').classList.add('hidden');
        wizard.classList.remove('hidden');
        wizard.classList.add('flex');
        renderCurrentStep();
        const backBtn = document.getElementById('wizard-back-btn');
        if(backBtn) backBtn.style.display = 'none';
        console.log("Onboarding wizard displayed.");
    }
}

function renderCurrentStep() {
    const stepData = appState.wizardFlow[appState.currentStepIndex];
    const container = document.getElementById('wizard-steps-container');
    if (!container || !stepData) {
        console.error("Container or step data not found for rendering current step.");
        return;
    }

    console.log(`Rendering step: ${stepData.id} (Type: ${stepData.type})`);
    let stepHtml = '';

    if (stepData.type === 'question') stepHtml = createQuestionStep(stepData);
    else if (stepData.type === 'info_card') stepHtml = createInfoCardStep(stepData);
    else if (stepData.type === 'final') stepHtml = createFinalStep(stepData);
    else if (stepData.type === 'conditional_input') stepHtml = createConditionalInputStep(stepData);
    else if (stepData.type === 'action_plan') {
        createActionPlan();
        return;
    }
    
    container.innerHTML = stepHtml;

    if (stepData.type === 'question') {
        document.querySelectorAll('.option-button').forEach(button => {
            addTrackedListener(button, 'click', () => selectOption(button, stepData.multiple));
        });
    }
    
    updateProgress();
    checkNextButtonState();
}

function nextStep() {
    const currentStep = appState.wizardFlow[appState.currentStepIndex];
    if (!currentStep) {
        console.error("Current step not found for nextStep.");
        return;
    }
    
    if (currentStep.type === 'question') {
        const selected = Array.from(document.querySelectorAll('.option-button.selected')).map(b => b.dataset.value);
        if (selected.length === 0) {
            showToast('Por favor, selecciona una opción.', 'error');
            return;
        }
        appState.answers[currentStep.key] = currentStep.multiple ? selected : selected[0];
    } else if (currentStep.type === 'final') {
        if (!saveFinalMeasures()) return;
    } else if (currentStep.type === 'conditional_input') {
        saveConditionalData(currentStep);
    }

    if (currentStep.id === 'health_conditions') {
        insertConditionalSteps(appState.answers.health_conditions);
    } else if (currentStep.id === 'final_measures') {
        const imc = calculateIMC(appState.answers.measurements.height, appState.answers.measurements.weight);
        if (imc >= 30 && !appState.wizardFlow.some(s => s.id === 'cond_lipids')) {
             appState.wizardFlow.splice(appState.currentStepIndex + 1, 0, conditionalSteps.obesity);
        }
    }
    
    if (appState.currentStepIndex < appState.wizardFlow.length - 1) {
        appState.currentStepIndex++;
        renderCurrentStep();
        const backBtn = document.getElementById('wizard-back-btn');
        if(backBtn) backBtn.style.display = 'block';
    } else {
        console.log("Wizard finished. Creating action plan.");
        createActionPlan();
    }
}

function prevStep() {
    if (appState.currentStepIndex > 0) {
        appState.currentStepIndex--;
        renderCurrentStep();
        console.log(`Moved to previous step: ${appState.wizardFlow[appState.currentStepIndex].id}`);
    }

    const backBtn = document.getElementById('wizard-back-btn');
    if (appState.currentStepIndex === 0 && backBtn) {
        backBtn.style.display = 'none';
    }
}

function insertConditionalSteps(conditions) {
    if (!Array.isArray(conditions) || conditions.includes('none')) return;
    const stepsToInsert = conditions
        .map(condition => conditionalSteps[condition])
        .filter(step => step && !appState.wizardFlow.some(s => s.id === step.id));
    if (stepsToInsert.length > 0) {
        appState.wizardFlow.splice(appState.currentStepIndex + 1, 0, ...stepsToInsert);
        console.log("Inserted conditional steps:", stepsToInsert.map(s => s.id));
    }
}

function createActionPlan() {
    console.log("Creating action plan (transitioning to main app)...");
    const wizard = document.getElementById('onboarding-wizard');
    if (!wizard) {
        console.error("Onboarding wizard element not found.");
        return;
    }
    wizard.style.transition = 'opacity 0.5s ease-out';
    wizard.style.opacity = '0';
    setTimeout(() => {
        wizard.classList.add('hidden');
        wizard.classList.remove('flex');
        const appContainer = document.getElementById('app-container');
        if (appContainer) {
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            console.log("Main app container displayed.");
        }
        initializeApp(false);
    }, 500);
}

// --- HTML Generation for Steps ---
function createQuestionStep(stepData) {
    const gridCols = stepData.options.length > 4 ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1';
    let optionsHtml = stepData.options.map(opt => `
        <button class="option-button w-full text-left p-4 rounded-lg font-semibold text-lg flex items-center" data-value="${opt.value}">
            <span>${opt.text}</span>
        </button>
    `).join('');
    return `<div class="w-full max-w-2xl text-center text-white px-4"><h2 class="text-2xl md:text-3xl font-bold mb-8">${stepData.question}</h2><div class="grid ${gridCols} gap-4">${optionsHtml}</div></div>`;
}

function createInfoCardStep(stepData) {
    const imageUrl = infoCardGraphics[stepData.graphic_placeholder];
    let graphicHtml = `<div class="w-full h-64 bg-gray-900/30 rounded-lg flex items-center justify-center my-4 border border-dashed border-gray-600">
        <span class="text-gray-500 text-sm italic">Espacio para gráfico: ${stepData.graphic_placeholder}</span>
    </div>`;

    if (imageUrl) {
        graphicHtml = `<div class="my-4"><img src="${imageUrl}" alt="${stepData.title}" class="w-full h-auto object-contain max-h-72" onerror="this.onerror=null;this.src='https://placehold.co/400x288/1e1b2e/ffffff?text=Imagen';"></div>`;
    }

    return `<div class="w-full max-w-md text-center text-white px-4">
                <div class="info-card-onboarding p-4 rounded-2xl">
                    ${graphicHtml}
                    <div class="text-gray-300 text-lg px-4 mt-4">${stepData.text}</div>
                </div>
            </div>`;
}

function createFinalStep(stepData) {
    return `<div class="w-full max-w-md text-white">
                <h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">${stepData.question}</h2>
                <div class="space-y-4 text-left bg-gray-800 bg-opacity-50 p-6 rounded-lg border border-gray-700">
                    <div><label for="final-age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="final-age" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition"></div>
                    <div><label for="final-altura" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="final-altura" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition"></div>
                    <div><label for="final-peso" class="block text-sm font-medium text-gray-300 mb-1">Peso Actual (kg)</label><input type="number" id="final-peso" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition"></div>
                </div>
            </div>`;
}

function createConditionalInputStep(stepData) {
    let inputsHtml = '';
    if (stepData.multiple) {
        inputsHtml = stepData.fields.map(field => `<div><label for="cond-input-${field.key}" class="block text-sm font-medium text-gray-300 mb-1">${field.placeholder}</label><input type="${field.inputType || 'text'}" id="cond-input-${field.key}" data-key="${field.key}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="${field.placeholder}"></div>`).join('');
    } else {
        inputsHtml = `<div><label for="cond-input-${stepData.key}" class="block text-sm font-medium text-gray-300 mb-1">${stepData.placeholder}</label><input type="${stepData.inputType || 'text'}" id="cond-input-${stepData.key}" data-key="${stepData.key}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="${stepData.placeholder}"></div>`;
    }
    return `<div class="w-full max-w-md text-white"><h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">${stepData.question}</h2><div class="space-y-4 text-left bg-gray-800 bg-opacity-50 p-6 rounded-lg border border-gray-700">${inputsHtml}</div></div>`;
}

// --- Data Saving ---
function saveFinalMeasures() {
    const age = document.getElementById('final-age').value;
    const height = document.getElementById('final-altura').value;
    const weight = document.getElementById('final-peso').value;
    if (!age || !height || !weight) {
        showToast('Por favor, completa edad, altura y peso.', 'error');
        return false;
    }
    appState.answers.measurements = { age: parseInt(age), height: parseFloat(height), weight: parseFloat(weight) };
    console.log("App State after final measures:", appState.answers);
    return true;
}

function saveConditionalData(step) {
    if (step.multiple) {
        appState.answers[step.key] = {};
        step.fields.forEach(field => {
            const input = document.getElementById(`cond-input-${field.key}`);
            if (input && input.value) {
                appState.answers[step.key][field.key] = input.value;
            }
        });
    } else {
        const input = document.getElementById(`cond-input-${step.key}`);
        if (input && input.value) {
            appState.answers[step.key] = input.value;
        }
    }
    console.log(`Conditional data saved for ${step.key}:`, appState.answers[step.key]);
}

// --- Wizard State & UI ---
function checkNextButtonState() {
    const step = appState.wizardFlow[appState.currentStepIndex];
    const nextBtn = document.getElementById('wizard-next-btn');
    if (!step || !nextBtn) return;
    
    if (step.type === 'info_card' || step.type === 'conditional_input') {
        nextBtn.disabled = false;
    } else if (step.type === 'question') {
        nextBtn.disabled = document.querySelectorAll('.option-button.selected').length === 0;
    } else if (step.type === 'final') {
        const ageEl = document.getElementById('final-age');
        const heightEl = document.getElementById('final-altura');
        const weightEl = document.getElementById('final-peso');
        
        const update = () => {
             nextBtn.disabled = !ageEl.value || !heightEl.value || !weightEl.value;
        };

        addTrackedListener(ageEl, 'input', update);
        addTrackedListener(heightEl, 'input', update);
        addTrackedListener(weightEl, 'input', update);
        update(); // Initial check
    }
}

function updateProgress() {
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    if (!progressBar || !progressText) return;

    const progress = (appState.currentStepIndex / (appState.wizardFlow.length - 1)) * 100;
    progressBar.style.width = `${progress}%`;
    progressText.innerText = `${Math.round(progress)}%`;
}

function selectOption(button, isMultiple) {
    const value = button.dataset.value;
    if (value === 'none') {
        document.querySelectorAll('.option-button.selected').forEach(b => b.classList.remove('selected'));
        button.classList.add('selected');
    } else {
        const noneButton = document.querySelector('.option-button[data-value="none"]');
        if (noneButton) noneButton.classList.remove('selected');
        if (!isMultiple) {
            document.querySelectorAll('.option-button.selected').forEach(b => {
                if (b !== button) b.classList.remove('selected');
            });
        }
        button.classList.toggle('selected');
    }
    checkNextButtonState();
}

// --- Helper & Calculation Functions ---
function calculateIMC(height, weight) {
    return (height > 0 && weight > 0) ? (weight / ((height / 100) ** 2)) : 0;
}

function getIMCCategory(imc) {
    return imcCategories.find(cat => imc >= cat.range[0] && imc <= cat.range[1]) || { name: 'N/A', definition: '' };
}

function calculateHealthyWeightRange(height) {
    if (!height || height <= 0) return null;
    const heightInMeters = height / 100;
    const minWeight = 18.5 * (heightInMeters ** 2);
    const maxWeight = 24.9 * (heightInMeters ** 2);
    const idealWeight = 21.75 * (heightInMeters ** 2);
    return {
        min: minWeight.toFixed(1),
        max: maxWeight.toFixed(1),
        ideal: idealWeight.toFixed(1)
    };
}


function calculateWaterIntake(weight, height, age, gender, activity_level) {
    if (isNaN(weight) || weight <= 0 || isNaN(height) || height <= 0 || isNaN(age) || age <= 0 || !gender || !activity_level) {
        console.warn("Invalid input for calculateWaterIntake. Returning null.");
        return null;
    }

    let bmr = (10 * weight) + (6.25 * height) - (5 * age);
    bmr += (gender === 'male' ? 5 : -161);
    const activityMultipliers = { sedentary: 1.2, light: 1.375, moderate: 1.55, high: 1.725 };
    const multiplier = activityMultipliers[activity_level] || 1.2;
    const tdee = bmr * multiplier;
    const waterLiters = (tdee * 1.5) / 1000;
    return Math.max(2.0, waterLiters);
}

function renderImcDetails(container, height, weight) {
    if(!container) return;
    container.innerHTML = '';
    const h = parseFloat(height), w = parseFloat(weight);
    if (h > 0 && w > 0) {
        const imc = calculateIMC(h, w);
        const imcCategory = getIMCCategory(imc);
        let html = `<p class="text-5xl font-bold">${imc.toFixed(1)}</p><p class="text-lg text-gray-300 mt-1">${imcCategory.name}</p><ul class="space-y-1 text-sm mt-4">`;
        imcCategories.forEach(cat => {
            const isCurrent = (imc >= cat.range[0] && imc <= cat.range[1]);
            html += `<li class="flex justify-between items-center p-2 rounded-md transition-all duration-300 ${isCurrent ? 'bg-blue-900/50 ring-1 ring-blue-400' : ''}"><span>${cat.name}</span><span class="font-mono text-gray-400">${cat.rangeText}</span></li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
        console.log(`IMC calculated: ${imc.toFixed(1)} (${imcCategory.name})`);
    } else {
        container.innerHTML = '<p class="text-gray-400">Ingresa tus datos para calcular.</p>';
        console.warn("Cannot calculate IMC: height or weight is zero/invalid.");
    }
}


// --- Main App Initialization ---
function initializeApp(isReloading = false) {
    console.log(`Initializing app... (Reloading: ${isReloading})`);
    if (isAppInitialized) {
        console.log("App already initialized, re-rendering dashboard.");
        renderDashboard();
        return;
    }
    
    if (!isReloading) {
        const { measurements, glucose_level, blood_pressure, lipids, accessCode } = appState.answers;
        
        appState.userData.altura = measurements.height;
        appState.userData.pesoInicial = measurements.weight;
        appState.userData.pesoActual = measurements.weight;
        appState.userData.historialPeso.push({ fecha: new Date().toISOString().split('T')[0], peso: measurements.weight });
        
        appState.userData.historialGlucosa = [];
        appState.userData.historialPresion = [];
        appState.userData.historialLipidico = [];

        if (glucose_level) {
            appState.userData.historialGlucosa.push({ fecha: new Date().toISOString().split('T')[0], valor: parseFloat(glucose_level) });
        }
        if (blood_pressure) {
            const [sistolica, diastolica] = blood_pressure.split('/').map(Number);
            if(sistolica && diastolica) {
                appState.userData.historialPresion.push({ fecha: new Date().toISOString().split('T')[0], sistolica: sistolica, diastolica: diastolica });
            }
        }
        if (lipids && Object.keys(lipids).length > 0) {
            appState.userData.historialLipidico.push({
                fecha: new Date().toISOString().split('T')[0],
                triglycerides: parseFloat(lipids.triglycerides) || null,
                hdl: parseFloat(lipids.hdl) || null,
                ldl: parseFloat(lipids.ldl) || null
            });
        }

        sendDataToGoogleSheet();
        try {
            localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
            localStorage.setItem('ketoOriginsSession', JSON.stringify({ code: accessCode, userId: appState.userId }));
            console.log("App state and session saved to localStorage.");
        } catch (e) {
            console.error("Error saving to localStorage:", e);
        }
    }

    isAppInitialized = true;
    console.log("App initialized. User data:", appState.userData);

    renderDashboard();
    setupEventListeners();
    setActiveNavLink();
}

// --- Dashboard Rendering ---

function generateMainGoalAccordion(goal) {
    const plan = mainGoalPlan[goal];
    if (!plan) return '';

    const stepsHtml = plan.steps.map((step, index) => `
        <li class="flex items-start mb-2">
            <span class="text-green-400 font-bold mr-3">${index + 1}.</span>
            <span class="text-gray-300">${step}</span>
        </li>
    `).join('');

    return `
        <div class="mb-6">
            <div class="dashboard-card">
                <button class="accordion-button w-full flex justify-between items-center text-left p-0">
                    <span class="font-semibold text-lg text-cyan-400">👇 La ciencia de tu plan y tus primeros pasos</span>
                    <span class="accordion-arrow text-2xl text-cyan-400">&rarr;</span>
                </button>
                <div class="accordion-content">
                    <div class="pt-4 border-t border-gray-700/50 mt-4">
                        <p class="text-gray-300 mb-4">${plan.science}</p>
                        <h4 class="font-bold text-green-400 mb-2">Tu Plan de Acción Metabólica:</h4>
                        <ul class="list-none p-0">${stepsHtml}</ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generatePersonalizedAdvice(answers) {
    let adviceHtml = '';
    const handledKeys = new Set();

    const createAccordionHtml = (advice) => {
        return `
            <div>
                <button class="accordion-button w-full flex justify-between items-center text-left bg-gray-800/50 p-4 rounded-lg hover:bg-gray-700/50 transition">
                    <span class="font-semibold text-lg text-cyan-400 flex items-center">
                        <span class="text-2xl mr-3">${advice.emoji || ''}</span>
                        <span>${advice.title}</span>
                    </span>
                    <span class="accordion-arrow text-2xl text-cyan-400">&rarr;</span>
                </button>
                <div class="accordion-content">
                    <div class="pt-4 text-sm text-gray-300">${advice.text}</div>
                </div>
            </div>
        `;
    };

    const selectedHabits = answers.habits;
    if (selectedHabits && Array.isArray(selectedHabits) && selectedHabits.length > 0 && !selectedHabits.includes('none')) {
        let combinedText = selectedHabits.map(habitKey => {
            const advice = habitAdviceLibrary[habitKey];
            return advice ? `<p class="mb-3"><strong>${advice.title}:</strong> ${advice.text}</p>` : '';
        }).join('');
        const stormAccordion = { emoji: '⚠️', title: 'Análisis Crítico: La Tormenta Metabólica Perfecta', text: combinedText };
        adviceHtml += createAccordionHtml(stormAccordion);
    }

    const emotionalResponse = answers.emotional_eating;
    const stressResponse = answers.stress_level;
    if (emotionalResponse && stressResponse && psicologiaCombinada[emotionalResponse] && psicologiaCombinada[emotionalResponse][stressResponse]) {
        const adviceData = psicologiaCombinada[emotionalResponse][stressResponse];
        const combinedText = `<p class="mb-3">${adviceData.enfoquePsicologico}</p><p><strong>Tu primer paso práctico:</strong> ${adviceData.consejoAntiEstres}</p>`;
        const psychoAccordion = { emoji: '❤️‍🩹', title: 'Sanando la Relación con la Comida', text: combinedText };
        adviceHtml += createAccordionHtml(psychoAccordion);
        handledKeys.add('emotional_eating'); 
    }

    const waterIntakeResponse = answers.water_intake;
    if (waterIntakeResponse) {
        const waterGoal = calculateWaterIntake(answers.measurements.weight, answers.measurements.height, answers.measurements.age, answers.gender, answers.activity_level);
        let hydrationText = '', userIntakeLiters = 0;
        switch (waterIntakeResponse) {
            case 'less_2': userIntakeLiters = 0.25; break;
            case '2-4': userIntakeLiters = 0.75;  break;
            case '4-6': userIntakeLiters = 1.25; break;
            case 'more_6': userIntakeLiters = 1.75; break;
        }
        if (waterGoal === null) {
            hydrationText = `<p class="text-gray-400">Datos insuficientes o inválidos para calcular tu meta de hidratación.</p>`;
        } else if (waterIntakeResponse === 'less_2') {
            hydrationText = `Gracias por tu honestidad. Aquí hemos detectado un foco rojo de alto riesgo para tu salud. Tu meta diaria de hidratación es de <strong>${waterGoal.toFixed(1)} litros</strong>, pero actualmente tu ingesta es mínima. Esto es una emergencia metabética silenciosa. La deshidratación crónica, incluso si no sientes sed, tiene consecuencias graves:
<ul class="list-disc list-inside mt-2 space-y-1">
    <li><strong>Estrés Cardiovascular:</strong> Tu volumen sanguíneo disminuye, lo que obliga a tu corazón a bombear com más fuerza y eleva tu presión arterial.</li>
    <li><strong>Toxicidad Acumulada:</strong> Tus riñones no tienen suficiente líquido para filtrar y eliminar las toxinas de tu cuerpo, lo que lleva a una acumulación interna.</li>
    <li><strong>Niebla Mental y Fatiga:</strong> La entrega de oxígeno a tu cerebro se ve drásticamente reducida, causando confusión, falta de concentración y un cansancio que ningún café puede solucionar.</li>
</ul>
<p class="mt-2">Tu misión más importante, que no es negociable, es comenzar a hidratarte correctamente desde hoy. Tu primera meta es simplemente beber más agua, y la forma ideal de hacerlo es con la combinación perfecta: Agua Mineral (nunca purificada ni de la llave, por su contenido de flúor y cloro) con una pizca de sal de mar y el jugo de medio limón. Esto no solo hidrata, sino que repone los minerales esenciales para que el agua pueda entrar a tus células.</p>`;
        } else if (userIntakeLiters < waterGoal) {
            hydrationText = `¡Excelente que ya tengas el hábito de beber agua! Estás en camino y muy cerca del objetivo. Tu meta de hidratación es de <strong>${waterGoal.toFixed(1)} litros</strong>, y actualmente estás consumiendo alrededor de <strong>${userIntakeLiters.toFixed(1)} litros</strong>. Estás a solo unos vasos de diferencia. Ese último tramo es el que marca la diferencia entre simplemente 'funcionar' y 'prosperar'. Ese extra de agua potenciará la quema de grasa, mejorará drásticamente la apariencia de tu piel y aumentará tu claridad mental. Para optimizar tu esfuerzo, recuerda siempre la combinación perfecta: Agua Mineral con sal de mar y limón.`;
        } else {
            hydrationText = `¡Felicidades! Este es uno de los hábitos más importantes para el éxito en Keto y ya lo tienes dominado. Tu ingesta de agua cumple o supera tu meta de <strong>${waterGoal.toFixed(1)} litros</strong>. Esto significa que estás apoyando activamente la desintoxicación de tu cuerpo, manteniendo tus células energizadas y optimizando cada proceso metabólico. Recuerda siempre la combinación perfecta para potenciar aún más los resultados: Agua Mineral + Sal de Mar + Limón.`;
        }
        const hydrationAccordion = { emoji: '💧📈', title: 'Análisis de tu Hidratación', text: hydrationText };
        adviceHtml += createAccordionHtml(hydrationAccordion);
    }

    for (const key in personalizedAdviceLibrary) {
        if (handledKeys.has(key)) continue;
        const userResponse = answers[key];
        if (userResponse) {
            const processResponse = (responseValue) => {
                if (personalizedAdviceLibrary[key]?.[responseValue]) {
                    adviceHtml += createAccordionHtml(personalizedAdviceLibrary[key][responseValue]);
                }
            };
            Array.isArray(userResponse) ? userResponse.forEach(processResponse) : processResponse(userResponse);
        }
    }
    
    const junkFoodResponse = answers.junk_food_freq;
    if (junkFoodResponse && junkFoodAdviceLibrary[junkFoodResponse]) {
        const junkFoodAccordion = { emoji: '🍔🍕', title: 'La Verdad Oculta en la Comida Rápida', text: junkFoodAdviceLibrary[junkFoodResponse].text };
        adviceHtml += createAccordionHtml(junkFoodAccordion);
    }

    const selectedDrinks = answers.daily_drinks;
    if (selectedDrinks && Array.isArray(selectedDrinks) && selectedDrinks.length > 0 && !selectedDrinks.includes('none')) {
        let drinksText = '';
        const hasWater = selectedDrinks.includes('water'), hasStimulant = selectedDrinks.includes('coffee') || selectedDrinks.includes('tea');
        if (hasWater && hasStimulant) {
            drinksText = `<p class="mb-3"><strong>${drinksAdviceLibrary.smart_combo.title}:</strong> ${drinksAdviceLibrary.smart_combo.text}</p>`;
            selectedDrinks.filter(d => d !== 'water' && d !== 'coffee' && d !== 'tea').forEach(drinkKey => {
                if (drinksAdviceLibrary[drinkKey]) drinksText += `<p class="mb-3"><strong>${drinksAdviceLibrary[drinkKey].title}:</strong> ${drinksAdviceLibrary[drinkKey].text}</p>`;
            });
        } else {
            selectedDrinks.forEach(drinkKey => {
                if (drinksAdviceLibrary[drinkKey]) drinksText += `<p class="mb-3"><strong>${drinksAdviceLibrary[drinkKey].title}:</strong> ${drinksAdviceLibrary[drinkKey].text}</p>`;
            });
        }
        const drinksAccordion = { emoji: '🥛🥤', title: 'Lo que Bebes Importa', text: drinksText };
        adviceHtml += createAccordionHtml(drinksAccordion);
    }

    return adviceHtml;
}


function renderDashboard() {
    console.log("Rendering dashboard...");
    const dashboardContainer = document.getElementById('dashboard');
    if (!dashboardContainer) {
        console.error("Dashboard container not found.");
        return;
    }

    const { measurements, health_conditions = [], glucose_level, blood_pressure, main_goal, weight_history, lipids } = appState.answers;
    const imc = calculateIMC(measurements.height, measurements.weight);
    const imcCategory = getIMCCategory(imc);
    const waterIntake = calculateWaterIntake(measurements.weight, measurements.height, measurements.age, appState.answers.gender, appState.answers.activity_level);
    const healthyWeight = calculateHealthyWeightRange(measurements.height);
    const diferenciaPeso = measurements.weight - healthyWeight.ideal;

    let weightGoalCardHtml = '';
    if (diferenciaPeso > 0) {
        weightGoalCardHtml = `<div class="dashboard-card flex flex-col justify-center items-center text-center border-amber-400/50"><p class="text-4xl font-bold text-amber-400">${diferenciaPeso.toFixed(1)}</p><p class="text-sm text-amber-400/80 mt-1">Kg a Perder</p></div>`;
    } else if (diferenciaPeso < 0) {
        weightGoalCardHtml = `<div class="dashboard-card flex flex-col justify-center items-center text-center border-green-400/50"><p class="text-4xl font-bold text-green-400">${Math.abs(diferenciaPeso).toFixed(1)}</p><p class="text-sm text-green-400/80 mt-1">Kg a Ganar</p></div>`;
    }

    let weightProjectionText = '';
    if (diferenciaPeso > 0) {
        const monthsToLose = ((diferenciaPeso * 1000) / 143 / 30).toFixed(1);
        weightProjectionText = `Basado en una pérdida de grasa saludable y sostenible, podrías alcanzar tu peso ideal en aproximadamente <strong>${monthsToLose} meses</strong>.`;
    } else if (diferenciaPeso < 0) {
        weightProjectionText = `Tu peso está por debajo del rango saludable. Este plan te ayudará a ganar masa muscular y peso de forma saludable.`;
    } else {
        weightProjectionText = `¡Felicidades! Estás en tu peso ideal. El plan se enfocará en optimizar tu energía y salud.`;
    }

    const goalTitles = {
        loss: 'Tu Hoja de Ruta para Perder Peso y Equilibrar tu Metabolismo',
        energy: 'Tu Hoja de Ruta para Mejorar tu Energía y Enfoque',
        health: 'Tu Hoja de Ruta para Mejorar una Condición de Salud',
        muscle: 'Tu Hoja de Ruta para Tonificar tu Cuerpo y Aumentar Masa Muscular'
    };
    const mainTitle = goalTitles[main_goal] || 'Tu Hoja de Ruta Personalizada';
    const mainGoalAccordionHtml = generateMainGoalAccordion(main_goal);

    let introParagraph = '';
    if (weight_history === 'ideal_weight') {
        introParagraph = `<p class="text-center text-gray-300 mb-4 text-md">¡Felicitaciones por estar en tu peso ideal! Este plan optimizará tu bienestar.</p>`;
    } else if (weight_history === 'less_than_year') {
        introParagraph = `<p class="text-center text-gray-300 mb-4 text-md">Estás en el momento perfecto para actuar. Tu cuerpo responderá rápidamente.</p>`;
    } else if (weight_history === 'more_than_year' || weight_history === 'cant_remember') {
        introParagraph = `<p class="text-center text-gray-300 mb-4 text-md">Entendemos que llevas tiempo luchando. Este plan es un 'reseteo' profundo. ¡Vamos a hacerlo bien!</p>`;
    }

    const personalizedAdviceHtml = generatePersonalizedAdvice(appState.answers);
    
    const topMetricsHtml = `
        <div class="dashboard-card flex flex-col justify-center items-center text-center"><p class="text-4xl font-bold text-cyan-400">${measurements.age}</p><p class="text-sm text-gray-400 mt-1">Años</p></div>
        <div class="dashboard-card flex flex-col justify-center items-center text-center"><p class="text-4xl font-bold text-cyan-400">${measurements.height}</p><p class="text-sm text-gray-400 mt-1">Altura (cm)</p></div>
        <div class="dashboard-card flex flex-col justify-center items-center text-center"><p class="text-4xl font-bold text-cyan-400">${measurements.weight}</p><p class="text-sm text-gray-400 mt-1">Peso Actual kg</p></div>
        ${weightGoalCardHtml}
    `;
    
    const healthyWeightCardHtml = `
        <div class="dashboard-card p-4">
            <h3 class="font-bold text-xl mb-2 text-green-400">Tu Rango de Peso Saludable</h3>
            <p class="text-sm text-gray-300">Basado en tu estatura, un peso saludable para ti se encuentra entre <strong class="text-white">${healthyWeight.min} kg</strong> y <strong class="text-white">${healthyWeight.max} kg</strong>.</p>
            <p class="text-sm text-gray-400 mt-2">Un punto ideal de referencia, con un IMC de 21.75, es alrededor de <strong class="text-green-300">${healthyWeight.ideal} kg</strong>. ¡Esa es una excelente meta a largo plazo!</p>
        </div>
    `;

    let healthFocusHtml = '';
    if (health_conditions.length > 0 && !health_conditions.includes('none')) {
        healthFocusHtml = `<div class="dashboard-card p-4">
            <h3 class="font-bold text-xl mb-4 text-pink-400">Tu Plan de Enfoque de Salud</h3>`;
        health_conditions.forEach(condition => {
            const explanation = pathologyExplanations[condition];
            if (explanation) {
                let medicalAdvice = '';
                let warningClass = '';
                if (condition === 'insulin_resistance' && glucose_level >= 100) {
                    warningClass = 'medical-warning';
                    medicalAdvice = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu nivel de glucosa (${glucose_level} mg/dL) sugiere una atención especial. Aunque este plan es una excelente herramienta, es fundamental que converses sobre este valor con tu médico.</p>`;
                }
                if (condition === 'hypertension' && blood_pressure) {
                    const [systolic, diastolic] = blood_pressure.split('/').map(Number);
                    if (systolic >= 140 || diastolic >= 90) {
                        warningClass = 'medical-warning';
                        medicalAdvice = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu presión arterial (${blood_pressure}) se encuentra elevada. Si bien este plan te ayudará a mejorar, es crucial que un médico evalúe estos números contigo.</p>`;
                    }
                }

                healthFocusHtml += `<div class="mb-3 pb-3 border-b border-gray-700/50 last:border-b-0 ${warningClass}">
                    <h4 class="font-semibold text-blue-400 text-md">${explanation.title}</h4>
                    <p class="text-xs text-gray-400 mt-1"><strong class="text-gray-300">La Raíz Metabética:</strong> ${explanation.cause}</p>
                    <p class="text-xs text-gray-400"><strong class="text-gray-300">Tu Plan de Acción Keto:</strong> ${explanation.action}</p>
                    ${medicalAdvice}
                </div>`;
            }
        });
        healthFocusHtml += `</div>`;
    }

    let lipidProfileHtml = '';
    if (lipids && (lipids.triglycerides || lipids.hdl || lipids.ldl)) {
        const tg = parseFloat(lipids.triglycerides);
        const hdlVal = parseFloat(lipids.hdl);
        const ldlVal = parseFloat(lipids.ldl);
        const ratio = (tg && hdlVal) ? (tg / hdlVal).toFixed(2) : 'N/A';
        const gender = appState.answers.gender;

        let interpretationText = '';
        let interpretationClass = '';
        let medicalAdviceLipids = '';
        if (ratio !== 'N/A') {
             if (gender === 'male') {
                 if (ratio <= 3.5) {
                     interpretationClass = 'interpretation-good';
                     interpretationText = `<strong>Interpretación (Hombre):</strong> ¡Excelente! Tu ratio TG/HDL de <strong>${ratio}</strong> está en el rango deseable (menor a 3.5).`;
                 } else if (ratio > 5.0) {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretación (Hombre):</strong> Atención. Tu ratio TG/HDL de <strong>${ratio}</strong> es elevado (mayor a 5.0).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) es elevado. Es fundamental que converses sobre este valor con tu médico.</p>`;
                 } else {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretación (Hombre):</strong> Tu ratio TG/HDL de <strong>${ratio}</strong> está en un rango moderado (entre 3.5 y 5.0).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) está en un rango moderado. Considera discutir este valor con tu médico.</p>`;
                 }
             } else { // female
                 if (ratio <= 2.5) {
                     interpretationClass = 'interpretation-good';
                     interpretationText = `<strong>Interpretación (Mujer):</strong> ¡Excelente! Tu ratio TG/HDL de <strong>${ratio}</strong> está en el rango ideal (menor a 2.5).`;
                 } else if (ratio > 3.5) {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretación (Mujer):</strong> Atención. Tu ratio TG/HDL de <strong>${ratio}</strong> es elevado (mayor a 3.5).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) es elevado. Es fundamental que converses sobre este valor con tu médico.</p>`;
                 } else {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretación (Mujer):</strong> Tu ratio TG/HDL de <strong>${ratio}</strong> está en un rango moderado (entre 2.5 y 3.5).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) está en un rango moderado. Considera discutir este valor con tu médico.</p>`;
                 }
             }
        }
        lipidProfileHtml = `
        <div class="dashboard-card p-4 lipid-analysis-card">
            <h3 class="font-bold text-xl mb-4 text-pink-300">🔬 Análisis de tu Perfil Lipídico</h3>
            <div class="mb-4">
                <p class="text-sm">Para entender tus resultados, primero conozcamos a tu <strong>flota de submarinos</strong>, las lipoproteínas que transportan grasas y colesterol por tu cuerpo:</p>
                <ul class="list-disc list-inside space-y-1 mt-2 text-xs">
                    <li><strong>Quilomicrones:</strong> Submarinos gigantes que transportan la grasa de tu última comida desde los intestinos.</li>
                    <li><strong>VLDL:</strong> Submarinos grandes lanzados desde el hígado, cargados con triglicéridos (energía) para tus células.</li>
                    <li><strong>IDL:</strong> El VLDL después de entregar parte de su carga, un paso intermedio.</li>
                    <li><strong>LDL:</strong> Submarinos cuya misión vital es entregar colesterol para reparar y construir cada célula de tu cuerpo.</li>
                    <li><strong>HDL:</strong> Tu flota de 'salvamento y reparación'. Patrullan tus arterias, recogen el colesterol no utilizado y, crucialmente, <strong>limpian las paredes arteriales de colesterol oxidado (ateromas)</strong>, devolviéndolo al hígado.</li>
                </ul>
            </div>
            <div class="p-3 bg-gray-800/50 rounded-lg mb-3">
                <h4 class="font-semibold text-lg text-cyan-300">Tus Valores Actuales:</h4>
                <p>Triglicéridos: <strong>${tg || 'N/A'} mg/dL</strong></p>
                <p>Colesterol HDL: <strong>${hdlVal || 'N/A'} mg/dL</strong></p>
                <p>Colesterol LDL: <strong>${ldlVal || 'N/A'} mg/dL</strong></p>
                <p class="mt-2 text-xl">Ratio TG/HDL: <strong class="text-amber-400">${ratio}</strong></p>
            </div>
            <div class="interpretation-box ${interpretationClass}">
                ${interpretationText}
            </div>
            ${medicalAdviceLipids}
            <p class="mt-4 text-xs italic">El objetivo es: <strong>Triglicéridos bajos</strong> (el cuerpo quema grasa), <strong>HDL alto</strong> (buen sistema de limpieza) y un <strong>LDL "contextualizado"</strong>, donde la calidad de la partícula (inferida por el ratio) es más importante que su cantidad total. Recuerda que estos rangos pueden variar com la edad, consulta siempre a tu médico.</p>
        </div>`;
    }
    
    const otherCardsHtml = `
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/mrnDR0CS/PROYECCION-DE-PESO.png" alt="Gráfico de Proyección de Peso" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="projection">?</span>
                <h3 class="font-bold text-white mb-2">Proyección de Peso</h3>
                <p class="text-sm text-gray-300 leading-relaxed">${weightProjectionText}</p>
            </div>
        </div>
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/20mMD59q/Tu-IMC-actual.png" alt="Gráfico de IMC" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="imc">?</span>
                <h3 class="font-bold text-white mb-2">Tu IMC actual</h3>
                <p class="text-5xl font-extrabold text-cyan-400">${imc.toFixed(1)}</p>
                <p class="text-md font-semibold text-gray-300">${imcCategory.name}</p>
                <p class="text-xs text-gray-400 mt-1 px-2">${imcCategory.definition}</p>
            </div>
        </div>
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/GvFVvJPM/Copia-de-Copia-de-Logo-500-x-500-px-1.png" alt="Gráfico de Consumo de agua" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="water">?</span>
                <h3 class="font-bold text-white">Consumo de agua</h3>
                <p class="text-5xl font-bold text-cyan-400 my-2">${waterIntake !== null ? waterIntake.toFixed(1) : 'N/A'} L</p>
                <p class="text-xs text-gray-400">El cuerpo pierde 1.5-2.5L de agua al día (respiración, sudor, orina, etc.). Usamos la fórmula de Holliday-Segar para tu recomendación.</p>
            </div>
        </div>
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/S4hTHgbj/Copia-de-Copia-de-Logo-500-x-500-px-3.png" alt="Gráfico de Recetas Keto" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="recipes">?</span>
                <h3 class="font-bold text-white mb-2">Tus Recetas Keto</h3>
                <p class="text-sm text-gray-300 leading-relaxed">Deliciosos platos, inspirados en los alimentos que más te gustan y tus hábitos.</p>
            </div>
        </div>
    `;

    dashboardContainer.innerHTML = `
        <h1 class="text-3xl font-extrabold text-white text-center mb-6">${mainTitle}</h1>
        ${mainGoalAccordionHtml}
        ${introParagraph}
        <h2 class="text-2xl font-bold text-white text-center mb-2 mt-8">Tus Métricas Clave</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">${topMetricsHtml}</div>
        <div class="grid grid-cols-1 gap-4 mb-6">${healthyWeightCardHtml}</div>
        ${healthFocusHtml ? `<div class="grid grid-cols-1 gap-4 mb-6">${healthFocusHtml}</div>` : ''}
        ${lipidProfileHtml ? `<div class="grid grid-cols-1 gap-4 mb-6">${lipidProfileHtml}</div>` : ''}
        <h2 class="text-2xl font-bold text-white text-center mb-4 mt-8">Tus Consejos Personalizados</h2>
        <div id="personalized-advice-container" class="space-y-4 mb-6">${personalizedAdviceHtml}</div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">${otherCardsHtml}</div>
        <div id="unlock-button-container" class="text-center mt-8"><button id="unlock-app-btn" class="btn-glow text-white font-bold py-3 px-12 rounded-full text-xl">VER MIS HERRAMIENTAS</button></div>
    `;
    
    addTrackedListener(document.getElementById('unlock-app-btn'), 'click', unlockAppContent);
    console.log("Dashboard rendered.");
}

function unlockAppContent() {
    console.log("Unlocking app content (populating tools)...");
    populateToolsContent(); // Populate tools before showing them
    
    const herramientas = document.getElementById('herramientas');
    if(herramientas) herramientas.classList.remove('hidden');

    document.querySelectorAll('.locked-content').forEach(el => {
        el.classList.remove('hidden');
    });

    const unlockBtnContainer = document.getElementById('unlock-button-container');
    if(unlockBtnContainer) unlockBtnContainer.style.display = 'none';

    if(herramientas) herramientas.scrollIntoView({ behavior: 'smooth' });
    console.log("Tools section made visible.");
}

function populateToolsContent() {
    console.log("Populating tools content with HTML...");
    const herramientasContainer = document.getElementById('herramientas');
    if (!herramientasContainer) {
        console.error("Herramientas container not found.");
        return;
    }

    const userMeasurements = appState.answers.measurements || {};
    const userGender = appState.answers.gender || '';
    const userActivityLevel = appState.answers.activity_level || '';

    const healthTrackersHtml = `
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-pink-300 mb-4">Registrar Nuevas Mediciones</h2>
            <div class="space-y-4">
                <div><label for="new-glucose" class="block text-sm font-medium text-gray-300 mb-1">Glucosa (mg/dL)</label><input type="number" id="new-glucose" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <div><label for="new-pressure" class="block text-sm font-medium text-gray-300 mb-1">Presión Arterial (ej: 120/80)</label><input type="text" id="new-pressure" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <button id="register-measurement-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Registrar Medición</button>
            </div>
        </div>
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">Evolución de tu Salud Metabólica</h2>
            <div class="relative h-64"><canvas id="health-chart"></canvas></div>
            <button id="reset-health-chart-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg mt-4">Reiniciar Gráfico</button>
        </div>
    `;
    
    const lipidTrackersHtml = `
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-pink-300 mb-4">Registrar Perfil Lipídico</h2>
            <div class="space-y-4">
                <div><label for="new-triglycerides" class="block text-sm font-medium text-gray-300 mb-1">Triglicéridos (mg/dL)</label><input type="number" id="new-triglycerides" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <div><label for="new-hdl" class="block text-sm font-medium text-gray-300 mb-1">Colesterol HDL (mg/dL)</label><input type="number" id="new-hdl" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <div><label for="new-ldl" class="block text-sm font-medium text-gray-300 mb-1">Colesterol LDL (mg/dL)</label><input type="number" id="new-ldl" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <button id="register-lipids-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Registrar Lípidos</button>
            </div>
        </div>
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">Evolución de tu Perfil Lipídico</h2>
            <div class="relative h-64"><canvas id="lipid-chart"></canvas></div>
            <button id="reset-lipid-chart-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg mt-4">Reiniciar Gráfico</button>
        </div>
    `;

    const weightTrackersHtml = `
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-green-300 mb-4">Registrar Peso</h2>
            <div class="space-y-4">
                <div>
                    <label for="new-weight" class="block text-sm font-medium text-gray-300 mb-1">Peso Actual (kg)</label>
                    <input type="number" id="new-weight" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                </div>
                <button id="register-weight-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Registrar Peso</button>
            </div>
        </div>
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-green-300 mb-4">Evolución del Peso</h2>
            <div class="relative h-64"><canvas id="weight-chart"></canvas></div>
            <button id="reset-weight-chart-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg mt-4">Reiniciar Gráfico</button>
        </div>
    `;

    herramientasContainer.innerHTML = `
        <h1 class="text-4xl font-extrabold mb-8 text-white">Herramientas Keto</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="guide-card p-6">
                <h2 class="text-2xl font-bold text-cyan-300 mb-4">Calculadora de IMC</h2>
                <div class="space-y-4">
                    <div><label for="tool-altura" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="tool-altura" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" value="${userMeasurements.height || ''}"></div>
                    <div><label for="tool-peso" class="block text-sm font-medium text-gray-300 mb-1">Peso (kg)</label><input type="number" id="tool-peso" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" value="${userMeasurements.weight || ''}"></div>
                    <button id="calc-imc-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Calcular</button>
                </div>
                <div id="tool-imc-result-container" class="mt-6"></div>
            </div>
            <div class="guide-card p-6">
                <h2 class="text-2xl font-bold text-green-300 mb-4">Calculadora de Hidratación</h2>
                <div class="space-y-4">
                    <div><label for="peso-agua" class="block text-sm font-medium text-gray-300 mb-1">Tu Peso (kg)</label><input type="number" id="peso-agua" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" value="${userMeasurements.weight || ''}"></div>
                    <div><label for="hydration-age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="hydration-age" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" value="${userMeasurements.age || ''}"></div>
                    <div><label for="hydration-height" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="hydration-height" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" value="${userMeasurements.height || ''}"></div>
                    <div><label for="hydration-gender" class="block text-sm font-medium text-gray-300 mb-1">Género</label>
                        <select id="hydration-gender" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                            <option value="">Selecciona</option>
                            <option value="female" ${userGender === 'female' ? 'selected' : ''}>Femenino</option>
                            <option value="male" ${userGender === 'male' ? 'selected' : ''}>Masculino</option>
                        </select>
                    </div>
                    <div><label for="hydration-activity" class="block text-sm font-medium text-gray-300 mb-1">Nivel de Actividad</label>
                        <select id="hydration-activity" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                            <option value="">Selecciona</option>
                            <option value="sedentary" ${userActivityLevel === 'sedentary' ? 'selected' : ''}>Sedentario</option>
                            <option value="light" ${userActivityLevel === 'light' ? 'selected' : ''}>Ligero (caminatas 1-2 días)</option>
                            <option value="moderate" ${userActivityLevel === 'moderate' ? 'selected' : ''}>Moderado (ejercicio 2-3 días)</option>
                            <option value="high" ${userActivityLevel === 'high' ? 'selected' : ''}>Intenso (ejercicio 4+ días)</option>
                        </select>
                    </div>
                    <button id="calc-agua-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Calcular Agua</button>
                    <div id="resultado-agua" class="mt-4"></div>
                </div>
            </div>
            ${weightTrackersHtml}
            ${healthTrackersHtml}
            ${lipidTrackersHtml}
        </div>
        <div class="text-center mt-12 border-t-2 border-gray-700 pt-8">
             <button id="download-full-report-btn" class="btn-glow text-white font-bold py-4 px-16 rounded-full text-xl">Descargar Reporte Completo en PDF</button>
             <button id="full-guide-btn" class="btn-glow text-white font-bold py-4 px-16 rounded-full text-xl mt-4">Guía Completa KETO Origins</button>
        </div>
    `;
    setTimeout(() => {
        attachToolsEventListeners(); 
        setupHealthTracking(); 
        console.log("setupHealthTracking and attachToolsEventListeners called after a short delay.");
    }, 100);
}


function addTrackedListener(element, type, handler) {
    if (!element) {
        console.warn(`Attempted to add listener to non-existent element for type: ${type}`);
        return;
    }
    element.addEventListener(type, handler);
    eventListeners.push({ element, type, handler });
}

function attachToolsEventListeners() {
    console.log("Attaching tools specific event listeners...");

    addTrackedListener(document.getElementById('calc-imc-btn'), 'click', () => {
        const height = document.getElementById('tool-altura').value;
        const weight = document.getElementById('tool-peso').value;
        const container = document.getElementById('tool-imc-result-container');
        if (!height || !weight) {
            showToast('Por favor, ingresa altura y peso.', 'error');
            return;
        }
        renderImcDetails(container, height, weight);
    });

    addTrackedListener(document.getElementById('calc-agua-btn'), 'click', () => {
        const weight = parseFloat(document.getElementById('peso-agua').value);
        const age = parseFloat(document.getElementById('hydration-age').value);
        const height = parseFloat(document.getElementById('hydration-height').value);
        const gender = document.getElementById('hydration-gender').value;
        const activity = document.getElementById('hydration-activity').value;
        const resultEl = document.getElementById('resultado-agua');
        
        if (!weight || !age || !height || !gender || !activity) {
            showToast('Por favor, completa todos los campos.', 'error');
            return;
        }
        
        const waterLiters = calculateWaterIntake(weight, height, age, gender, activity);
        if (waterLiters !== null) {
            resultEl.innerHTML = `<p class="text-5xl font-bold text-cyan-400">${waterLiters.toFixed(1)} L</p><p class="text-md font-semibold text-gray-300 mt-1">Tu consumo diario recomendado</p>`;
        } else {
            showToast('Datos inválidos para calcular la hidratación.', 'error');
        }
    });

    addTrackedListener(document.getElementById('register-measurement-btn'), 'click', registerNewMeasurement);
    addTrackedListener(document.getElementById('register-lipids-btn'), 'click', registerNewLipidMeasurement);
    addTrackedListener(document.getElementById('register-weight-btn'), 'click', registerNewWeight);
    addTrackedListener(document.getElementById('reset-weight-chart-btn'), 'click', resetWeightChartData);
    addTrackedListener(document.getElementById('reset-health-chart-btn'), 'click', resetHealthChartData);
    addTrackedListener(document.getElementById('reset-lipid-chart-btn'), 'click', resetLipidChartData);
    
    addTrackedListener(document.getElementById('download-full-report-btn'), 'click', downloadFullReportPDF);
    
    addTrackedListener(document.getElementById('full-guide-btn'), 'click', () => {
        window.open('https://guia-completa-herramientas.netlify.app/', '_blank');
    });

    console.log("Tools specific event listeners attached.");
}


function setupEventListeners() {
    console.log("Setting up global event listeners...");
    const accordionHandler = function(event) {
        const button = event.target.closest('.accordion-button');
        if (button) {
            const content = button.nextElementSibling;
            if (content && content.classList.contains('accordion-content')) {
                button.classList.toggle('open');
                content.classList.toggle('open');
            }
        }
    };
    if (!document.body.__accordionListenerAdded) {
        addTrackedListener(document.body, 'click', accordionHandler);
        document.body.__accordionListenerAdded = true;
    }

    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    
    const sidebarToggleHandler = (e) => {
        e.stopPropagation();
        sidebar.classList.toggle('-translate-x-full');
    };
    addTrackedListener(sidebarToggle, 'click', sidebarToggleHandler);

    const documentClickHandler = (e) => {
        if (sidebar && !sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
            sidebar.classList.add('-translate-x-full');
        }
    };
    addTrackedListener(document, 'click', documentClickHandler);

    document.querySelectorAll('.nav-link').forEach(link => {
        addTrackedListener(link, 'click', handleNavClick);
    });

    const mainContent = document.getElementById('main-content');
    addTrackedListener(mainContent, 'scroll', setActiveNavLink);

    addTrackedListener(document.body, 'click', function(event) {
        const icon = event.target.closest('.help-icon');
        if (icon) {
            const key = icon.dataset.tooltipKey;
            showInfoModal(key);
        }
    });
    addTrackedListener(document.getElementById('info-modal-close'), 'click', hideInfoModal);
    addTrackedListener(document.getElementById('info-modal'), 'click', function(event) {
        if (event.target === this) {
            hideInfoModal();
        }
    });

    addTrackedListener(document.getElementById('reset-app-btn'), 'click', resetAppAndData);

    console.log("Global event listeners set up.");
}

function resetAppAndData() {
    const confirmation = confirm("¿Estás seguro de que quieres borrar todos tus datos y empezar de nuevo? Esta acción no se puede deshacer.");
    if (confirmation) {
        try {
            localStorage.removeItem('ketoOriginsData');
            localStorage.removeItem('ketoOriginsSession'); // Clear session too
            console.log("localStorage data cleared.");
            showToast('Datos borrados. La aplicación se reiniciará.', 'success');
            setTimeout(() => window.location.reload(), 2000);
        } catch (e) {
            console.error("Error clearing localStorage:", e);
            showToast('No se pudieron borrar los datos.', 'error');
        }
    } else {
        showToast('Acción cancelada.', 'info');
    }
}


function showInfoModal(key) {
    const modal = document.getElementById('info-modal');
    const titleEl = document.getElementById('info-modal-title');
    const textEl = document.getElementById('info-modal-text');
    const definition = tooltipDefinitions[key];

    if (definition && modal && titleEl && textEl) {
        titleEl.textContent = definition.title;
        textEl.textContent = definition.text;
        modal.classList.add('flex');
        modal.classList.remove('hidden');
        setTimeout(() => modal.style.opacity = '1', 10);
    }
}

function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 300);
    }
}


function handleNavClick(event) {
    event.preventDefault();
    const targetId = event.currentTarget.getAttribute('href');
    const targetElement = document.querySelector(targetId);
    if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        if (window.innerWidth < 768) {
            document.getElementById('sidebar')?.classList.add('-translate-x-full');
        }
    }
}

function setActiveNavLink() {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;
    let currentSectionId = 'dashboard';
    
    const sections = document.querySelectorAll('#main-content > section[id]');
    
    for (const section of sections) {
        if (section.id && section.offsetTop <= mainContent.scrollTop + 150) {
            currentSectionId = section.id;
        }
    }
    
    document.querySelectorAll('.nav-link').forEach(link => {
        const linkHref = link.getAttribute('href').substring(1);
        link.classList.toggle('active', linkHref === currentSectionId);
    });
}


// --- Health Tracking Functions ---
function setupHealthTracking() {
    console.log("Setting up health tracking (charts and input listeners)...");
    renderHealthChart();
    renderLipidChart();
    renderWeightChart();
}

function registerNewWeight() {
    const weightInput = document.getElementById('new-weight');
    const parsedWeight = parseFloat(weightInput.value);
    if (!isNaN(parsedWeight) && parsedWeight > 0) {
        appState.userData.historialPeso.push({ fecha: new Date().toISOString().split('T')[0], peso: parsedWeight });
        localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
        weightInput.value = '';
        showToast('Peso registrado con éxito.', 'success');
        renderWeightChart();
        sendTrackingDataToSheet({ type: 'Peso', value1: parsedWeight });
    } else {
        showToast('Por favor, ingresa un valor de peso válido.', 'error');
    }
}

function registerNewMeasurement() {
    const glucoseInput = document.getElementById('new-glucose');
    const pressureInput = document.getElementById('new-pressure');
    const newGlucose = glucoseInput.value;
    const newPressure = pressureInput.value;
    const today = new Date().toISOString().split('T')[0]; 
    let registered = false;
    let stateChanged = false;

    if (newGlucose && !isNaN(parseFloat(newGlucose)) && parseFloat(newGlucose) > 0) {
        appState.userData.historialGlucosa.push({ fecha: today, valor: parseFloat(newGlucose) });
        glucoseInput.value = '';
        registered = true;
        stateChanged = true;
        sendTrackingDataToSheet({ type: 'Glucosa (mg/dL)', value1: parseFloat(newGlucose) });
    }
    if (newPressure) {
        const [sistolica, diastolica] = newPressure.split('/').map(Number);
        if (sistolica && diastolica && !isNaN(sistolica) && !isNaN(diastolica)) {
            appState.userData.historialPresion.push({ fecha: today, sistolica, diastolica });
            pressureInput.value = '';
            registered = true;
            stateChanged = true;
            sendTrackingDataToSheet({ type: 'Presión Arterial', value1: `${sistolica}/${diastolica}` });
        } else if (newPressure.trim() !== '') {
            showToast('Formato de presión incorrecto. Usa "120/80".', 'error');
            return;
        }
    }
    
    if(registered) {
        showToast('Medición registrada con éxito.', 'success');
        if (stateChanged) {
            localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
        }
        renderHealthChart();
    } else {
        showToast('Ingresa al menos un valor válido.', 'error');
    }
}

function registerNewLipidMeasurement() {
    const tgInput = document.getElementById('new-triglycerides');
    const hdlInput = document.getElementById('new-hdl');
    const ldlInput = document.getElementById('new-ldl');
    const newTriglycerides = parseFloat(tgInput.value);
    const newHdl = parseFloat(hdlInput.value);
    const newLdl = parseFloat(ldlInput.value);

    if (!isNaN(newTriglycerides) && !isNaN(newHdl) && !isNaN(newLdl) && newTriglycerides > 0 && newHdl > 0 && newLdl > 0) {
        appState.userData.historialLipidico.push({
            fecha: new Date().toISOString().split('T')[0],
            triglycerides: newTriglycerides,
            hdl: newHdl,
            ldl: newLdl
        });
        localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
        tgInput.value = '';
        hdlInput.value = '';
        ldlInput.value = '';
        showToast('Perfil lipídico registrado.', 'success');
        renderLipidChart();
        sendTrackingDataToSheet({ 
            type: 'Perfil Lipídico', 
            value1: `TG: ${newTriglycerides}`,
            value2: `HDL: ${newHdl}`,
            value3: `LDL: ${newLdl}`
        });
    } else {
        showToast('Por favor, completa los tres campos de lípidos.', 'error');
    }
}

function renderWeightChart() {
    const canvas = document.getElementById('weight-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (weightChartInstance) weightChartInstance.destroy();
    const weightData = appState.userData.historialPeso;
    const displayLabels = weightData.map((d, index) => `Entrada ${index + 1}`);
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(139, 92, 246, 0.8)');
    gradient.addColorStop(1, 'rgba(34, 211, 238, 0.8)');
    weightChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: displayLabels,
            datasets: [{
                label: 'Peso (kg)',
                data: weightData.map(d => d.peso),
                backgroundColor: gradient,
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 1,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#9CA3AF' } }, y: { beginAtZero: true, ticks: { color: '#9CA3AF' } } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderHealthChart() {
    const canvas = document.getElementById('health-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (healthChartInstance) healthChartInstance.destroy();
    const glucoseData = appState.userData.historialGlucosa;
    const pressureData = appState.userData.historialPresion;
    const maxEntries = Math.max(glucoseData.length, pressureData.length);
    const displayLabels = Array.from({ length: maxEntries }, (_, i) => `Entrada ${i + 1}`);
    const datasets = [];
    if (glucoseData.length > 0) datasets.push({
        label: 'Glucosa (mg/dL)',
        data: displayLabels.map((_, i) => glucoseData[i] ? glucoseData[i].valor : null),
        backgroundColor: 'rgba(244, 114, 182, 0.6)', borderColor: 'rgba(244, 114, 182, 1)', borderWidth: 1, borderRadius: 5
    });
    if (pressureData.length > 0) {
        datasets.push({
            label: 'Presión Sistólica (mmHg)',
            data: displayLabels.map((_, i) => pressureData[i] ? pressureData[i].sistolica : null),
            backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 1, borderRadius: 5
        });
        datasets.push({
            label: 'Presión Diastólica (mmHg)',
            data: displayLabels.map((_, i) => pressureData[i] ? pressureData[i].diastolica : null),
            backgroundColor: 'rgba(96, 165, 250, 0.6)', borderColor: 'rgba(96, 165, 250, 1)', borderWidth: 1, borderRadius: 5
        });
    }
    healthChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: displayLabels, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#9CA3AF' } }, y: { beginAtZero: true, ticks: { color: '#9CA3AF' } } },
            plugins: { legend: { labels: { color: '#D1D5DB' } } }
        }
    });
}

function renderLipidChart() {
    const canvas = document.getElementById('lipid-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (lipidChartInstance) lipidChartInstance.destroy();
    const lipidData = appState.userData.historialLipidico;
    const displayLabels = lipidData.map(d => new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'));
    lipidChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: displayLabels,
            datasets: [
                { label: 'Triglicéridos', data: lipidData.map(d => d.triglycerides), backgroundColor: 'rgba(251, 191, 36, 0.6)', borderColor: 'rgba(251, 191, 36, 1)', borderWidth: 1, borderRadius: 5 },
                { label: 'HDL', data: lipidData.map(d => d.hdl), backgroundColor: 'rgba(76, 175, 80, 0.6)', borderColor: 'rgba(76, 175, 80, 1)', borderWidth: 1, borderRadius: 5 },
                { label: 'LDL', data: lipidData.map(d => d.ldl), backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#9CA3AF' } }, y: { beginAtZero: true, ticks: { color: '#9CA3AF' } } },
            plugins: { legend: { labels: { color: '#D1D5DB' } } }
        }
    });
}

// --- Reset Chart Data Functions ---
function resetWeightChartData() {
    appState.userData.historialPeso = [];
    localStorage.setItem('ketoOriginsData', JSON.stringify(appState)); // Update localStorage
    showToast('Gráfico de Peso Reiniciado.', 'success');
    renderWeightChart();
}

function resetHealthChartData() {
    appState.userData.historialGlucosa = [];
    appState.userData.historialPresion = [];
    localStorage.setItem('ketoOriginsData', JSON.stringify(appState)); // Update localStorage
    showToast('Gráfico de Salud Metabólica Reiniciado.', 'success');
    renderHealthChart();
}

function resetLipidChartData() {
    appState.userData.historialLipidico = [];
    localStorage.setItem('ketoOriginsData', JSON.stringify(appState)); // Update localStorage
    showToast('Gráfico de Perfil Lipídico Reiniciado.', 'success');
    renderLipidChart();
}

// --- PDF Generation ---
async function downloadFullReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let yPos = 15; // Initial Y position for content

    doc.setFontSize(22);
    doc.text("Reporte de Progreso - Keto Origins", 105, yPos, { align: 'center' });
    yPos += 15;

    // Helper to add chart and table to PDF
    const addSection = (chartInstance, title, data, head, bodyMapper) => {
        if (yPos > 240) { // Check if new page is needed before adding content
            doc.addPage();
            yPos = 15;
        }
        doc.setFontSize(16);
        doc.text(title, 14, yPos);
        yPos += 10;

        if (chartInstance && data.length > 0) {
            const imgData = chartInstance.toBase64Image();
            doc.addImage(imgData, 'PNG', 14, yPos, 180, 90);
            yPos += 100;

            doc.autoTable({
                startY: yPos,
                head: [head],
                body: data.map(bodyMapper),
                theme: 'grid',
                headStyles: { fillColor: [30, 27, 46] }
            });
            yPos = doc.autoTable.previous.finalY + 15;
        } else {
            doc.setFontSize(12);
            doc.text("No hay datos registrados para este gráfico.", 14, yPos);
            yPos += 10;
        }
    };

    // 1. Weight Section
    addSection(
        weightChartInstance,
        "Evolución del Peso",
        appState.userData.historialPeso,
        ['Entrada', 'Fecha', 'Peso (kg)'],
        (d, i) => [`Entrada ${i + 1}`, new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), d.peso]
    );

    // 2. Health Section
    if (yPos > 240) { doc.addPage(); yPos = 15; }
    doc.setFontSize(16);
    doc.text("Evolución de Salud Metabólica", 14, yPos);
    yPos += 10;
    if (healthChartInstance && (appState.userData.historialGlucosa.length > 0 || appState.userData.historialPresion.length > 0)) {
        const imgData = healthChartInstance.toBase64Image();
        doc.addImage(imgData, 'PNG', 14, yPos, 180, 90);
        yPos += 100;

        if (appState.userData.historialGlucosa.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Entrada', 'Fecha', 'Glucosa (mg/dL)']],
                body: appState.userData.historialGlucosa.map((d, i) => [`Entrada ${i + 1}`, new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), d.valor]),
                theme: 'grid', headStyles: { fillColor: [30, 27, 46] }
            });
            yPos = doc.autoTable.previous.finalY + 10;
        }
        if (appState.userData.historialPresion.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Entrada', 'Fecha', 'Presión Arterial']],
                body: appState.userData.historialPresion.map((d, i) => [`Entrada ${i + 1}`, new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), `${d.sistolica}/${d.diastolica}`]),
                theme: 'grid', headStyles: { fillColor: [30, 27, 46] }
            });
            yPos = doc.autoTable.previous.finalY + 15;
        }
    } else {
        doc.setFontSize(12);
        doc.text("No hay datos de glucosa o presión registrados.", 14, yPos);
        yPos += 10;
    }

    // 3. Lipid Section
    addSection(
        lipidChartInstance,
        "Evolución del Perfil Lipídico",
        appState.userData.historialLipidico,
        ['Fecha', 'Triglicéridos', 'HDL', 'LDL'],
        (d) => [new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), d.triglycerides, d.hdl, d.ldl]
    );

    doc.save('reporte_completo_keto_origins.pdf');
    showToast('Reporte PDF generado.', 'success');
}


// --- Toast Notification System ---
function showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
    
    toast.className = `toast-notification ${bgColor} text-white font-bold py-3 px-6 rounded-full opacity-0 transform translate-y-4`;
    toast.textContent = message;
    
    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-4');
        toast.classList.add('opacity-100', 'translate-y-0');
    }, 10);

    setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => toast.remove(), 500);
    }, duration);
}


// --- Functions to send data to Google Sheet ---

function translateValue(key, value) {
    if (!value) return '';
    if (Array.isArray(value)) {
        return value.map(v => translateValue(key, v)).join(', ');
    }

    const step = baseWizardSteps.find(s => s.key === key);
    if (step && step.options) {
        const option = step.options.find(o => o.value === value);
        return option ? option.text : value;
    }
    return value;
}

/**
 * NEW: Generic function to communicate with the Google Apps Script.
 * It handles errors and expects a JSON response.
 */
async function sendApiRequest(payload) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8' // Workaround for Apps Script CORS
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('API response not OK:', response.status, errorText);
            throw new Error(`Error del servidor (${response.status}).`);
        }

        const text = await response.text();
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error("Failed to parse API response as JSON. Raw response:", text);
            throw new Error("Respuesta del servidor no válida.");
        }
    } catch (error) {
        console.error(`Error in sendApiRequest for action ${payload.action}:`, error);
        return { status: 'error', message: error.message || 'Error de red.' };
    }
}

/**
 * Gathers user data from the appState and sends it to a Google Apps Script endpoint.
 */
function sendDataToGoogleSheet() {
    const { measurements, accessCode, ...otherAnswers } = appState.answers;
    const flatAnswers = { ...otherAnswers, ...measurements };
    
    const translatedData = Object.keys(flatAnswers).reduce((acc, key) => {
        const headerMap = {
            gender: 'Genero', main_goal: 'ObjetivoPrincipal', weight_history: 'HistoriaPeso', habits: 'Habitos',
            emotional_eating: 'HambreEmocional', junk_food_freq: 'FrecuenciaComidaChatarra', eat_out_freq: 'FrecuenciaComerFuera',
            cooking_skill: 'NivelCocina', daily_drinks: 'BebidasDiarias', water_intake: 'ConsumoAgua', alcohol_intake: 'ConsumoAlcohol',
            activity_level: 'NivelActividad', health_conditions: 'CondicionesSalud', stress_level: 'NivelEstres',
            age: 'Edad', height: 'Altura', weight: 'Peso', glucose_level: 'NivelGlucosa', blood_pressure: 'PresionArterial', lipids: 'Lipidos'
        };
        const header = headerMap[key];
        if (header && flatAnswers[key] !== undefined) {
             let value = flatAnswers[key];
            if (key === 'lipids' && value) {
                value = `TG: ${value.triglycerides || 'N/A'}, HDL: ${value.hdl || 'N/A'}, LDL: ${value.ldl || 'N/A'}`;
            }
            acc[header] = translateValue(key, value);
        }
        return acc;
    }, {});

    const payload = { 
        action: 'saveInitialData',
        userId: appState.userId,
        data: { UserID: appState.userId, ...translatedData },
        appStateJSON: JSON.stringify(appState) // Include the full state
    };

    sendApiRequest(payload).then(res => {
        console.log("Response from saveInitialData:", res);
        if (res.status !== 'success' && res.result !== 'success') { // Check both possible success keys
            showToast('Error al guardar datos iniciales.', 'error');
        }
    });
}


// --- NEW FUNCTION to send TRACKING data ---
function sendTrackingDataToSheet(data) {
    const payload = {
        action: 'saveTrackingData',
        userId: appState.userId,
        data: { UserID: appState.userId, ...data },
        appStateJSON: JSON.stringify(appState) // Include the updated state
    };

    sendApiRequest(payload).then(res => {
        console.log("Response from saveTrackingData:", res);
         if (res.status !== 'success' && res.result !== 'success') {
            showToast('Error al guardar seguimiento.', 'error');
        }
    });
}

// --- NEW Access Control Functions ---
async function handleCodeValidation() {
    const codeInput = document.getElementById('access-code-input');
    const code = codeInput.value.trim().toUpperCase();
    const errorEl = document.getElementById('code-error-message');
    const spinner = document.getElementById('loading-spinner');
    const submitBtn = document.getElementById('submit-code-btn');

    if (!code) {
        errorEl.textContent = 'Por favor, ingresa un código.';
        return;
    }
    
    errorEl.textContent = '';
    spinner.classList.remove('hidden');
    submitBtn.disabled = true;

    const payload = { action: 'validateCode', code: code };
    const result = await sendApiRequest(payload);

    spinner.classList.add('hidden');
    submitBtn.disabled = false;
        
    if (result.status === 'success') {
        if (result.data) { // Returning user with existing data
            console.log("Returning user validated. Loading data...");
            try {
                // Data from Apps Script is expected to be a stringified JSON
                appState = JSON.parse(result.data);
                // Save the valid session info
                localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
                localStorage.setItem('ketoOriginsSession', JSON.stringify({ code: code, userId: appState.userId }));
                
                document.getElementById('access-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeApp(true); // Initialize in "reloading" mode
            } catch (e) {
                console.error("Failed to parse user data from server:", e);
                errorEl.textContent = "Error al procesar los datos del usuario.";
            }
        } else { // New user, validation was successful
            console.log("New user validated. Proceeding to questionnaire.");
            appState.userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            appState.answers.accessCode = code; // Save code to link user later
            
            // Assign user ID to the code in the background
            const assignPayload = { action: 'assignUser', code: code, userId: appState.userId };
            sendApiRequest(assignPayload).then(assignRes => {
                console.log("User ID assignment response:", assignRes);
            });

            startQuestionnaire();
        }
    } else {
        errorEl.textContent = result.message || 'Código no válido o expirado.';
    }
}


// --- Main App Execution ---
function main() {
    console.log("Main function started. Cleaning up and resetting.");
    cleanupAndReset();

    try {
        const savedSessionJSON = localStorage.getItem('ketoOriginsSession');
        const savedDataJSON = localStorage.getItem('ketoOriginsData');
        
        if (savedSessionJSON && savedDataJSON) {
            console.log("Found saved session. Loading dashboard directly.");
            const savedData = JSON.parse(savedDataJSON);
            appState = savedData;

            document.getElementById('access-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            initializeApp(true);
        } else {
            console.log("No saved session found. Showing access code screen.");
            document.getElementById('access-screen').classList.remove('hidden');
            addTrackedListener(document.getElementById('submit-code-btn'), 'click', handleCodeValidation);
            addTrackedListener(document.getElementById('access-code-input'), 'keypress', (e) => {
                if (e.key === 'Enter') {
                    handleCodeValidation();
                }
            });
        }
    } catch (e) {
        console.error("Error with localStorage, starting fresh.", e);
        localStorage.clear(); // Clear potentially corrupted storage
        document.getElementById('access-screen').classList.remove('hidden');
        addTrackedListener(document.getElementById('submit-code-btn'), 'click', handleCodeValidation);
         addTrackedListener(document.getElementById('access-code-input'), 'keypress', (e) => {
            if (e.key === 'Enter') {
                handleCodeValidation();
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', main);

</script>
</body>
</html>

