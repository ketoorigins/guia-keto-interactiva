<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keto Origins - Plan Personalizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- Custom Colors --- */
        :root {
            --brand-blue: #2563EB;
            --brand-purple: #7C3AED;
            --brand-cyan: #22D3EE;
            --brand-green: #4ADE80;
            --brand-pink: #F472B6;
            --brand-amber: #FBBF24;
        }

        /* --- Base and Scrollbar Styles --- */
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Default BG */
            color: #e0e0e0;
        }
        .main-app-bg {
            background-color: #111827; /* Fallback color */
            background-image: linear-gradient(to bottom, #2a2240, #111827);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Welcome & Onboarding Styles --- */
        .welcome-screen {
            background-color: #111827; /* Fallback */
            background-image: linear-gradient(to bottom, #391d3d, #111827);
        }
        .wizard-container {
             background-color: #111827;
        }
        .progress-bar-fill {
            transition: width 0.5s ease-in-out;
            background: linear-gradient(90deg, var(--brand-blue), var(--brand-purple));
        }
        .progress-circle {
            position: relative;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #1F2937;
            z-index: 1;
        }
        .progress-circle::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            padding: 1px; /* Border thickness */
            background: linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
                  mask-composite: exclude;
            z-index: -1;
        }
        .option-button {
            background-color: #1F2937;
            border: 1px solid #4B5563;
            transition: all 0.2s ease-in-out;
            color: #D1D5DB;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .option-button:hover {
            border-color: var(--brand-purple);
            transform: translateY(-2px);
        }
        .option-button.selected {
            background-color: var(--brand-blue);
            border-color: var(--brand-cyan);
            box-shadow: 0 0 20px rgba(34, 211, 238, 0.4);
            color: #FFFFFF;
            transform: translateY(-2px);
        }
        .info-card-onboarding {
            background-color: #1e1b2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        
        /* --- Dashboard & Card Styles --- */
        .dashboard-card, .guide-card, .advice-card {
            background-color: #1e1b2e; /* Dark purple-blue from reference */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            border-radius: 0.75rem;
            position: relative; /* Needed for icon positioning */
        }

        .advice-card {
             background-color: #2a2240; /* Slightly different background for advice */
        }

        .medical-warning {
            border-color: var(--brand-amber) !important;
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.4);
        }
        
        .lipid-analysis-card .interpretation-box {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
        }
        
        .lipid-analysis-card .interpretation-good {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            color: #A7F3D0;
        }

        .lipid-analysis-card .interpretation-warning {
            background-color: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            color: #FCD34D;
        }

        .image-gradient-border {
            border-radius: 9999px; /* rounded-full */
            border: 3px solid transparent;
            background-image: linear-gradient(#1e1b2e, #1e1b2e), linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
            background-origin: border-box;
            background-clip: content-box, border-box;
        }

        .logo-gradient-border {
            position: relative;
            border-radius: 50%;
            display: inline-block;
            padding: 2px; /* Controls the border thickness */
            background: linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
        }
        .logo-gradient-border img {
            display: block;
            border-radius: 50%;
        }


        /* --- Accordion Styles --- */
        .accordion-content {
            max-height: 0;
            overflow: hidden; /* Keep hidden for smooth transition */
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding-left: 1rem;
            padding-right: 1rem;
            padding-top: 0; /* Ensure initial padding is zero for transition */
            padding-bottom: 0; /* Ensure initial padding is zero for transition */
        }
        .accordion-content.open {
            max-height: 2000px; /* A large enough value to accommodate content */
            padding-top: 1rem;
            padding-bottom: 1rem;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            background-color: #1e1b2e;
        }
        .accordion-button.open {
             border-radius: 0.5rem 0.5rem 0 0;
        }
        .accordion-button.open .accordion-arrow {
            transform: rotate(90deg);
        }
        .accordion-arrow {
            transition: transform 0.3s ease;
        }


        /* --- General Buttons and Interactive Elements --- */
        .btn-glow {
            cursor: pointer;
            background: linear-gradient(90deg, var(--brand-blue), #4F46E5);
            box-shadow: 0 4px 15px 0 rgba(37, 99, 235, 0.35);
            transition: all 0.2s ease-out;
            border: 2px solid var(--brand-purple);
            border-bottom-width: 4px;
        }
        .btn-glow:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px 5px rgba(37, 99, 235, 0.45);
        }
        .btn-glow:active {
            transform: translateY(1px);
            box-shadow: 0 2px 10px 0 rgba(37, 99, 235, 0.3);
            border-bottom-width: 2px;
        }
        .btn-glow:disabled {
            background: #4B5563;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
            transform: translateY(0);
            border-color: #4B5563;
        }
        .custom-checkbox {
            appearance: none;
            background-color: #374151;
            border: 1px solid #4B5563;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 0.25rem;
            margin-right: 0.75rem;
            margin-top: 0.25rem;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }
        .custom-checkbox:checked {
            background-color: var(--brand-blue);
            border-color: var(--brand-blue);
        }
        .custom-checkbox:checked::after {
            content: '‚úì';
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.875rem;
            line-height: 1;
        }
        .note-textarea { background-color: rgba(17, 24, 39, 0.7); border: 1px solid #4B5563; }
        .note-textarea:focus { border-color: var(--brand-blue); box-shadow: 0 0 10px rgba(59, 130, 246, 0.5); outline: none; }

        /* --- Sidebar and Navigation --- */
        .sidebar { transition: transform 0.3s ease-in-out; }
        
        .nav-link.dashboard-special-button {
            position: relative;
            background-color: #1F2937;
            z-index: 1;
            border: none;
        }

        .nav-link.dashboard-special-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            padding: 1px; /* Controls the border thickness */
            background: linear-gradient(to right, var(--brand-pink), var(--brand-cyan));
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
                  mask-composite: exclude;
            z-index: -1;
        }


        .nav-link.active:not(.dashboard-special-button) {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.3), rgba(29, 78, 216, 0.3));
            box-shadow: inset 2px 0 0 var(--brand-blue), inset 0 0 10px rgba(99, 102, 241, 0.4);
            color: #ffffff; font-weight: 700;
        }
        .nav-link:not(.dashboard-special-button):hover { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.2), rgba(29, 78, 216, 0.2)); 
        }
        
        /* --- Toast Notification --- */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast-notification {
            transition: opacity 0.5s, transform 0.5s;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }

        /* --- Modal and Help Icon Styles --- */
        #info-modal {
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            transition: opacity 0.3s ease;
        }
        #info-modal.flex {
            display: flex;
        }
        .help-icon {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            width: 1.5rem;
            height: 1.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.7);
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .help-icon:hover {
            background-color: var(--brand-purple);
            color: white;
            transform: scale(1.1);
        }

    </style>
</head>
<body class="min-h-screen">

    <!-- Access Code Screen (New Welcome Screen) -->
    <div id="access-screen" class="welcome-screen fixed inset-0 z-50 flex flex-col items-center justify-center p-8 text-center">
        <div class="logo-gradient-border mb-8 shadow-2xl">
            <img src="https://i.ibb.co/20NypXdZ/ketoorigins.png" alt="Logo Keto Origins" class="w-48 h-48 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/192x192/1e1b2e/ffffff?text=Logo';">
        </div>
        <div class="w-full max-w-sm">
            <h1 class="text-3xl font-extrabold text-white mb-6">Bienvenido a Keto Origins</h1>
            <label for="access-code-input" class="block text-gray-300 mb-2">Ingresa tu c√≥digo de acceso para comenzar</label>
            <input type="text" id="access-code-input" placeholder="Tu C√≥digo Aqu√≠" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-4 text-center text-lg tracking-widest focus:ring-2 focus:ring-blue-500 outline-none transition">
            <button id="submit-code-btn" class="text-white font-bold py-4 px-16 rounded-full text-xl btn-glow mt-6 w-full">Validar C√≥digo</button>
            <div id="loading-spinner" class="hidden mt-4">
                <svg class="animate-spin h-8 w-8 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <p id="code-error-message" class="text-red-400 mt-4 font-semibold h-6"></p>
        </div>
    </div>

    <!-- Onboarding Wizard -->
    <div id="onboarding-wizard" class="wizard-container fixed inset-0 z-50 hidden flex-col p-4">
        <div class="w-full max-w-4xl mx-auto mb-4">
            <div class="grid grid-cols-3 items-center text-white mb-2">
                <div class="justify-self-start">
                    <button onclick="prevStep()" id="wizard-back-btn" class="text-2xl opacity-70 hover:opacity-100 transition">&larr;</button>
                </div>
                <div class="justify-self-center">
                    <div class="progress-circle">
                        <span id="progress-text" class="font-semibold text-lg">0%</span>
                    </div>
                </div>
                <div class="justify-self-end"></div> </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5">
                <div id="progress-bar" class="progress-bar-fill h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>
        <div id="wizard-steps-container" class="flex-grow flex items-center justify-center overflow-y-auto no-scrollbar py-4">
            <!-- Wizard steps will be rendered here -->
        </div>
        <div class="w-full max-w-4xl mx-auto mt-4 flex justify-center">
            <button id="wizard-next-btn" onclick="nextStep()" disabled class="text-white font-bold py-3 px-12 rounded-full text-lg btn-glow">Continuar</button>
        </div>
    </div>
    
    <!-- Toast Notification Container -->
    <div id="toast-container"></div>

    <!-- Main Application Container -->
    <div id="app-container" class="flex hidden main-app-bg">
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar fixed top-0 left-0 z-40 w-72 h-screen bg-black bg-opacity-30 backdrop-blur-lg p-5 transform -translate-x-full md:translate-x-0 flex flex-col no-scrollbar">
            <div class="flex items-center justify-center mb-8">
                <div class="logo-gradient-border shadow-lg">
                    <img src="https://i.ibb.co/20NypXdZ/ketoorigins.png" alt="Logo Keto Origins" class="w-28 h-28 rounded-full" onerror="this.onerror=null;this.src='https://placehold.co/112x112/1e1b2e/ffffff?text=Logo';">
                </div>
            </div>
            <nav id="main-nav" class="flex-grow overflow-y-auto no-scrollbar">
                <a href="#dashboard" class="nav-link dashboard-special-button block font-semibold py-3 px-4 rounded-lg transition duration-200 text-white">Dashboard</a>
                <a href="#herramientas" class="nav-link locked-content hidden block font-semibold py-3 px-4 rounded-lg transition duration-200 text-white mt-4">Herramientas</a>
            </nav>
             <!-- NUEVO: Bot√≥n de Reinicio -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                <button id="reset-app-btn" class="w-full text-center text-sm text-gray-400 hover:text-red-400 transition py-2 px-4 rounded-lg hover:bg-red-500/10">
                    Borrar mis datos y empezar de nuevo
                </button>
            </div>
        </aside>

        <!-- Sidebar Toggle for Mobile -->
        <button id="sidebar-toggle" class="md:hidden fixed top-4 left-4 z-50 p-2 rounded-md btn-glow text-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
        </button>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 md:ml-72 p-6 md:p-10 transition-all duration-300 overflow-y-auto h-screen">
            <section id="dashboard" class="mb-12">
                <!-- Dashboard content will be rendered here -->
            </section>
            
            <section id="herramientas" class="mb-12 hidden">
                <!-- Tools content will be rendered here -->
            </section>

        </main>
    </div>

    <!-- Information Modal -->
    <div id="info-modal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-black bg-opacity-70 p-4">
        <div id="info-modal-content" class="dashboard-card max-w-lg w-full relative">
            <h3 id="info-modal-title" class="text-2xl font-bold text-cyan-400 mb-4"></h3>
            <p id="info-modal-text" class="text-gray-300"></p>
            <button id="info-modal-close" class="btn-glow mt-6 py-2 px-6 rounded-lg self-center">Entendido</button>
        </div>
    </div>


<script>
// --- Global State & Config ---
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxSBjpr3iNusaGeYbdjKmTnz1I6rA35HZm1XbYAop1keBUPPSTgAWLzqwtHL-ScdkrBug/exec';
let appState = {};
let weightChartInstance = null;
let healthChartInstance = null;
let lipidChartInstance = null;
let isAppInitialized = false;
let eventListeners = []; 

// --- App Cleanup Function ---
function cleanupAndReset() {
    console.log("Cleaning up and resetting app state...");
    if (weightChartInstance) {
        weightChartInstance.destroy();
        weightChartInstance = null;
    }
    if (healthChartInstance) {
        healthChartInstance.destroy();
        healthChartInstance = null;
    }
    if (lipidChartInstance) {
        lipidChartInstance.destroy();
        lipidChartInstance = null;
    }

    eventListeners.forEach(({ element, type, handler }) => {
        if (element) {
            element.removeEventListener(type, handler);
        }
    });
    eventListeners = [];
    console.log("Event listeners cleared.");

    appState = {
        userId: '',
        currentStepIndex: 0,
        wizardFlow: [],
        userData: {
            altura: 0,
            pesoInicial: 0,
            pesoActual: 0,
            historialPeso: [],
            historialGlucosa: [],
            historialPresion: [],
            historialLipidico: []
        },
        answers: {}
    };
    console.log("App state reset to initial values.");

    isAppInitialized = false;

    const containersToClear = ['#dashboard', '#herramientas', '#wizard-steps-container', '#toast-container'];
    containersToClear.forEach(selector => {
        const el = document.querySelector(selector);
        if (el) el.innerHTML = '';
    });
    console.log("Dynamic containers cleared.");

    document.getElementById('access-screen')?.classList.remove('hidden');
    document.getElementById('onboarding-wizard')?.classList.add('hidden');
    document.getElementById('app-container')?.classList.add('hidden');
    console.log("Main container visibility reset.");
}


// --- Static Data Definitions ---
const infoCardGraphics = {
    'weight-graph': 'https://i.ibb.co/B5rswTYR/peso.png',
    'appetite-graph': 'https://i.ibb.co/LzkYrcDn/apetito.png',
    'sugar-graph': 'https://i.ibb.co/pv8nfKNG/azucar-en-sangre.png',
    'water-graph': 'https://i.ibb.co/4gptYYX8/agua.png'
};

const tooltipDefinitions = {
    'projection': {
        title: 'Proyecci√≥n de Peso',
        text: 'Estimaci√≥n de cuanto podr√≠a demorar tu cuerpo en alcanzar su equilibrio metab√≥lico. Siempre var√≠a seg√∫n los h√°bitos de cada persona.'
    },
    'imc': {
        title: 'Tu IMC actual',
        text: 'El √çndice de Masa Corporal (IMC) es un indicador que relaciona el peso de una persona con su altura, utilizado para evaluar si el peso se encuentra dentro de rangos saludables.'
    },
    'water': {
        title: 'Consumo de agua',
        text: 'El cuerpo humano est√° compuesto aproximadamente entre un 50% y un 70% de agua. Este porcentaje puede variar dependiendo de factores como la edad, el sexo y la composici√≥n corporal de cada individuo. Y es vital para el correcto funcionamiento de nuestro cuerpo.'
    },
    'recipes': {
        title: 'Tus Recetas Keto',
        text: 'Tendr√°s acceso a nuestra aplicaci√≥n de recetas keto para que no te quedes estancado sin saber que preparar cada d√≠a.'
    }
};

const baseWizardSteps = [
    { id: 'gender', type: 'question', question: 'üë§ Comencemos, ¬øCu√°l es tu g√©nero?', key: 'gender', options: [
        { text: '‚ôÄÔ∏è Femenino', value: 'female' },
        { text: '‚ôÇÔ∏è Masculino', value: 'male' }]
    },
    { id: 'weight_history', type: 'question', question: '‚öñÔ∏è ¬øHace cu√°nto tiempo que no est√°s en tu peso ideal? (Selecciona una opci√≥n)', key: 'weight_history', options: [
        { text: '‚úÖ Estoy en mi peso ideal', value: 'ideal_weight' },
        { text: 'üóìÔ∏è Menos de un a√±o', value: 'less_than_year' },
        { text: 'üìÖ M√°s de un a√±o', value: 'more_than_year' },
        { text: 'ü§∑ Ya ni lo recuerdo', value: 'cant_remember' }]
    },
    { id: 'main_goal', type: 'question', question: 'üéØ Cu√©ntanos sobre tu objetivo principal con Keto (Selecciona una opci√≥n)', key: 'main_goal', options: [
        { text: 'üìâ Perder peso y equilibrar mi metabolismo', value: 'loss' },
        { text: '‚ú® Mejorar energ√≠a, enfoque y concentraci√≥n', value: 'energy' },
        { text: '‚ù§Ô∏è Mejorar una condici√≥n de salud', value: 'health' },
        { text: 'üí™ Tonificar mi cuerpo y aumentar masa muscular', value: 'muscle' }]
    },
    { id: 'habits', type: 'question', question: 'üìù Selecciona las opciones que te identifican: (Puedes seleccionar varias)', key: 'habits', multiple: true, options: [
        { text: 'üò¥ Duermo muy poco', value: 'sleep_less' },
        { text: 'üåô Como muy tarde por la noche', value: 'dine_late' },
        { text: 'üßÇ Consumo muy poca sal', value: 'low_salt' },
        { text: 'üç´ Me encantan los dulces y chocolates', value: 'sweet_cravings' },
        { text: 'ü•§ Me gustan las gaseosas y/o energ√©ticas', value: 'love_soda' },
        { text: 'üëç Ninguna de las anteriores', value: 'none' }]
    },
    { id: 'emotional_eating', type: 'question', question: 'üçî ¬øSufres de hambre emocional? (Selecciona una opci√≥n)', key: 'emotional_eating', options: [
        { text: 'üòî S√≠, a menudo', value: 'yes' },
        { text: 'ü§î A veces', value: 'sometimes' },
        { text: 'üôÇ Muy rara vez', value: 'rarely' },
        { text: 'üòä Nunca', value: 'never' }]
    },
    { id: 'junk_food_freq', type: 'question', question: 'üå≠ ¬øCon qu√© frecuencia consumes comida chatarra? (Selecciona una opci√≥n)', key: 'junk_food_freq', options: [
        { text: 'ü•ó Nunca o raramente', value: 'rarely' },
        { text: 'üçü 1-2 veces por semana', value: '1-2_weekly' },
        { text: 'üçï 3-4 veces por semana', value: '3-4_weekly' },
        { text: 'üçî Casi a diario', value: 'daily' }]
    },
    { id: 'eat_out_freq', type: 'question', question: 'üèôÔ∏è ¬øCon qu√© frecuencia sales a comer fuera? (Selecciona una opci√≥n)', key: 'eat_out_freq', options: [
        { text: 'üè† Casi nunca', value: 'rarely' },
        { text: 'üç¥ Algunas veces al mes', value: 'monthly' },
        { text: 'üçΩÔ∏è Semanalmente', value: 'weekly' },
        { text: 'ü•° Casi a diario', value: 'daily' }]
    },
    { id: 'cooking_skill', type: 'question', question: 'üç≥ ¬øC√≥mo te consideras en la cocina? (Selecciona una opci√≥n)', key: 'cooking_skill', options: [
        { text: 'ü§∑‚Äç‚ôÇÔ∏è No s√© cocinar', value: 'no' },
        { text: 'üë®‚Äçüç≥ Soy principiante', value: 'beginner' },
        { text: 'üëå Me defiendo bien', value: 'intermediate' },
        { text: 'üßë‚Äçüç≥ Soy un chef experto', value: 'advanced' }]
    },
    { id: 'daily_drinks', type: 'question', question: 'ü•§ ¬øQu√© sueles beber durante el d√≠a? (Puedes seleccionar varias)', key: 'daily_drinks', multiple: true, options: [
        { text: '‚òï Caf√©', value: 'coffee' },
        { text: 'üçµ T√©', value: 'tea' },
        { text: 'üíß Agua', value: 'water' },
        { text: 'üßÉ Jugos', value: 'juice' },
        { text: 'ü•§ Gaseosas', value: 'soda' },
        { text: '‚úñÔ∏è Ninguna de las anteriores', value: 'none' }]
    },
    { id: 'water_intake', type: 'question', question: 'üö∞ ¬øCu√°nta agua bebes cada d√≠a? (Selecciona una opci√≥n)', key: 'water_intake', options: [
        { text: 'üíß Casi nada', value: 'less_2' },
        { text: 'üíßüíß 2-4 vasos', value: '2-4' },
        { text: 'üíßüíßüíß 4-6 vasos', value: '4-6' },
        { text: 'üíßüíßüíßüíß M√°s de 6 vasos', value: 'more_6' }]
    },
    { id: 'alcohol_intake', type: 'question', question: 'üç∫ ¬øCon qu√© frecuencia bebes alcohol? (Selecciona una opci√≥n)', key: 'alcohol_intake', options: [
        { text: 'üö´ No bebo alcohol', value: 'no' },
        { text: 'ü•Ç Ocasionalmente', value: 'occasionally' },
        { text: 'üçª Regularmente (fines de semana)', value: 'yes' }]
    },
    { id: 'info_weight', type: 'info_card', title: 'Tu Peso', text: 'La dieta keto es una herramienta poderosa para alcanzar tu peso ideal. Al cambiar el combustible de tu cuerpo de az√∫car a grasa, no solo pierdes peso, sino que tambi√©n reduces la inflamaci√≥n y ganas control sobre tu apetito, evitando el temido efecto rebote.<p class="text-sm italic text-purple-300 mt-4">"El hombre se convierte en lo que come" - Ludwig Feuerbach</p>', graphic_placeholder: 'weight-graph' },
    { id: 'activity_level', type: 'question', question: 'ü§∏ ¬øCu√°l es tu nivel de actividad f√≠sica semanal? (Selecciona una opci√≥n)', key: 'activity_level', options: [
        { text: 'üõãÔ∏è Sedentario', value: 'sedentary' },
        { text: 'üö∂ Ligero (caminatas 1-2 d√≠as)', value: 'light' },
        { text: 'üèÉ Moderado (ejercicio 2-3 d√≠as)', value: 'moderate' },
        { text: 'üèãÔ∏è Intenso (ejercicio 4+ d√≠as)', value: 'high' }]
    },
    { id: 'info_appetite', type: 'info_card', title: 'Tu Apetito', text: 'Al entrar en cetosis, tu cuerpo se vuelve sensible a las hormonas de la saciedad. Esto se traduce en menos antojos y un control natural del hambre, permiti√©ndote comer de forma consciente y no por impulso.<p class="text-sm italic text-purple-300 mt-4">"Comer es una necesidad, pero comer inteligentemente es un arte" - La Rochefoucauld</p>', graphic_placeholder: 'appetite-graph' },
    { id: 'health_conditions', type: 'question', question: '‚ù§Ô∏è‚Äçü©π ¬øTienes alguna de estas condiciones de salud? (Puedes seleccionar varias)', key: 'health_conditions', multiple: true, options: [
        { text: 'ü©∏ Resistencia a la Insulina / Diabetes T2', value: 'insulin_resistance' },
        { text: 'üåø H√≠gado Graso', value: 'fatty_liver' },
        { text: '‚ù§Ô∏è‚Äçü©π Hipertensi√≥n', value: 'hypertension' },
        { text: 'ü¶ã Hipotiroidismo', value: 'hypothyroidism' },
        { text: 'üî• Inflamaci√≥n Sist√©mica', value: 'inflammation' },
        { text: 'üò¥ Insomnio / Fatiga Cr√≥nica', value: 'insomnia' },
        { text: '‚úÖ Ninguna de las anteriores', value: 'none' }]
    },
    { id: 'info_sugar', type: 'info_card', title: 'Tu Az√∫car en Sangre', text: 'La dieta keto es excepcional para estabilizar la glucosa. Al minimizar los carbohidratos, evitas los picos de az√∫car que causan fatiga y antojos, logrando niveles de energ√≠a estables durante todo el d√≠a.<p class="text-sm italic text-purple-300 mt-4">"La comida debe ser simple, natural y nutritiva" - Louis Pasteur</p>', graphic_placeholder: 'sugar-graph' },
    { id: 'stress_level', type: 'question', question: 'ü§Ø ¬øSientes estr√©s con frecuencia? (Selecciona una opci√≥n)', key: 'stress_level', options: [
        { text: 'üòä Nunca', value: 'never' },
        { text: 'üôÇ A veces', value: 'sometimes' },
        { text: 'üòü A menudo', value: 'often' },
        { text: 'üò© Casi siempre', value: 'always' }]
    },
    { id: 'info_water', type: 'info_card', title: 'Tu Hidrataci√≥n', text: 'El agua es clave en keto para optimizar la quema de grasa y eliminar toxinas. Una correcta hidrataci√≥n con electrolitos previene la "gripe keto" y potencia tus resultados. Te daremos una meta personalizada.<p class="text-sm italic text-purple-300 mt-4">"La comida es la base de toda cura" - Paracelso</p>', graphic_placeholder: 'water-graph' },
    { id: 'final_measures', type: 'final', question: '¬°Casi listo! Introduce tus medidas para personalizar tu plan.' },
];

const conditionalSteps = {
    insulin_resistance: { id: 'cond_glucose', type: 'conditional_input', question: 'Si lo conoces, ingresa tu √∫ltimo nivel de glucosa en sangre (mg/dL). (Opcional)', key: 'glucose_level', inputType: 'number', placeholder: 'Ej: 110' },
    hypertension: { id: 'cond_pressure', type: 'conditional_input', question: 'Si la conoces, ingresa tu √∫ltima medici√≥n de presi√≥n arterial. (Opcional)', key: 'blood_pressure', inputType: 'text', placeholder: 'Ej: 140/90' },
    obesity: { id: 'cond_lipids', type: 'conditional_input', question: 'Si los tienes, ingresa tus datos de l√≠pidos. (Opcional)', key: 'lipids', multiple: true, fields: [
        { key: 'triglycerides', placeholder: 'Triglic√©ridos (mg/dL)' },
        { key: 'hdl', placeholder: 'Colesterol HDL (mg/dL)' },
        { key: 'ldl', placeholder: 'Colesterol LDL (mg/dL)' }
    ]}
};

const mainGoalPlan = {
    loss: {
        science: `Excelente elecci√≥n. Has tomado la decisi√≥n de no solo perder peso, sino de arreglar la causa ra√≠z del problema. Tu cuerpo es una m√°quina incre√≠blemente inteligente que ha estado funcionando en 'modo almacenamiento' debido a una hormona clave: la <strong>insulina</strong>. Cada vez que comes carbohidratos o az√∫car, la insulina sube y le grita a tu cuerpo: "¬°Guarda esta energ√≠a como grasa! ¬°No quemes nada!".<br><br>Lo que haremos es cambiar las reglas del juego. Al restringir los carbohidratos, vamos a 'silenciar' a la insulina. Cuando esta hormona baja, es como si tu cuerpo recibiera una nueva orden: <strong>"¬°Abran las bodegas de grasa y √∫senlas como combustible!"</strong>. Este cambio no es una dieta, es un cambio de sistema operativo para tu metabolismo, de quemador de az√∫car a quemador de grasa.`,
        steps: [
            "<strong>Vaciar las Reservas de Az√∫car (Depleci√≥n de Gluc√≥geno):</strong> Durante los primeros 3-5 d√≠as, tu √∫nica misi√≥n es agotar el az√∫car almacenado en tus m√∫sculos e h√≠gado. Para ello, elimina por completo todos los az√∫cares, granos, harinas y frutas (excepto un pu√±ado de bayas). S√© estricto aqu√≠, es la fase m√°s cr√≠tica.",
            "<strong>Activar la Quema de Grasa (Lip√≥lisis):</strong> Una vez vaciadas las reservas, tu cuerpo buscar√° una nueva fuente de energ√≠a. Aqu√≠ es donde entran las grasas saludables. Come palta, aceite de oliva, aceitunas, y no temas a la grasa natural de las carnes y huevos. Est√°s ense√±ando a cada c√©lula de tu cuerpo a usar grasa como su combustible preferido.",
            "<strong>Controlar la Insulina con tus Comidas:</strong> Come 2 o 3 comidas densas en nutrientes al d√≠a hasta sentirte saciado. Evita picotear entre horas. Cada vez que comes, generas una respuesta de insulina. Al espaciar tus comidas, mantienes la insulina baja por m√°s tiempo, maximizando las horas del d√≠a en que tu cuerpo est√° activamente quemando grasa.",
            "<strong>Optimizar con Electrolitos:</strong> Este paso no es opcional. La p√©rdida de agua inicial arrastra minerales. Prepara tu suero con <strong>agua mineral, sal de mar y lim√≥n</strong> y b√©belo durante el d√≠a para evitar fatiga o calambres."
        ]
    },
    energy: {
        science: `Un objetivo fant√°stico y uno de los beneficios m√°s sorprendentes para muchos. Pi√©nsalo de esta manera: tu cerebro ha estado funcionando con glucosa (az√∫car), que es como echarle a un auto de lujo la gasolina de peor calidad. Te da picos de energ√≠a seguidos de ca√≠das bruscas, lo que causa esa 'niebla mental' y el cansancio de la tarde.<br><br>Cuando tu cuerpo entra en cetosis, empieza a producir <strong>cetonas</strong>. Las cetonas son un <strong>s√∫per-combustible</strong> para el cerebro. Son una fuente de energ√≠a mucho m√°s limpia, estable y duradera que la glucosa. Al darle a tu cerebro este combustible premium, lo que experimentar√°s no es una energ√≠a nerviosa como la del caf√©, sino una <strong>calma enfocada</strong>.`,
        steps: [
            "<strong>Fase de Adaptaci√≥n (Semana 1-2):</strong> Tu prioridad absoluta es ense√±arle a tu cerebro a pedir el nuevo combustible. Elimina por completo az√∫cares, harinas y procesados. No te preocupes por contar calor√≠as, solo enf√≥cate en comer alimentos de nuestra lista de compras hasta sentirte saciado.",
            "<strong>Prioriza las Grasas Inteligentes:</strong> Tu cerebro est√° composto en un 60% por grasa. Dale los mejores materiales. Incorpora a diario palta (aguacate), aceite de oliva extra virgen, aceitunas y considera a√±adir aceite MCT a tu caf√© o batidos para un impulso cet√≥nico directo al cerebro.",
            "<strong>Hidrataci√≥n Neuronal:</strong> Un cerebro deshidratado es un cerebro lento. Prepara tu suero diario con <strong>agua mineral, sal de mar y lim√≥n</strong>. Los electrolitos son cruciales para la comunicaci√≥n entre neuronas y la claridad mental.",
            "<strong>Introduce el Ayuno 16/8:</strong> Una vez adaptado (despu√©s de la semana 2), intenta consolidar tus comidas en una ventana de 8 horas. Este per√≠odo de ayuno de 16 horas potenciar√° la producci√≥n de cetonas y activar√° la autofagia, un proceso de limpieza celular que es incre√≠blemente beneficioso para la salud neuronal."
        ]
    },
    health: {
        science: `Has elegido el camino m√°s profundo y poderoso. La mayor√≠a de las condiciones de salud cr√≥nicas modernas no son fallos de tu cuerpo, sino respuestas l√≥gicas a un ambiente hostil, principalmente uno pro-inflamatorio. El az√∫car y los carbohidratos refinados son los principales culpables, act√∫an como un incendio constante a nivel celular.<br><br>Al cambiar tu fuente de energ√≠a a grasas saludables, no solo quitamos el combustible a ese incendio, sino que producimos <strong>cetonas</strong>, que son mol√©culas de se√±alizaci√≥n que activamente le dan a tus genes la orden de <strong>reducir la inflamaci√≥n</strong>. Estamos, literalmente, cambiando la expresi√≥n de tus genes hacia un estado de reparaci√≥n y equilibrio.`,
        steps: [
            "<strong>Apagar el Fuego Inflamatorio:</strong> Tu primer paso, no negociable, es cortar de ra√≠z los principales agentes inflamatorios: az√∫car, harinas, granos y aceites de semilla (girasol, canola, soya). Esto es como dejarle√±a al fuego.",
            "<strong>Construir con Materiales Anti-inflamatorios:</strong> Prioriza grasas como la palta (aguacate), el aceite de oliva y el pescado graso (rico en Omega-3). Estas grasas son los ladrillos que tus c√©lulas usar√°n para reparar sus membranas y calmar la inflamaci√≥n.",
            "<strong>Activar la Limpieza Celular (Autofagia):</strong> Introduce un ayuno intermitente suave, como el 16/8 (16 horas de ayuno, 8 para comer). Este per√≠odo sin comer le da a tu cuerpo el tiempo y la se√±al para activar un proceso de 'reciclaje' interno, donde elimina las c√©lulas da√±adas que perpet√∫an la inflamaci√≥n.",
            "<strong>Reducir el Estr√©s Metab√©tico:</strong> El estr√©s cr√≥nico libera cortisol, una hormona que puede sabotear tus esfuerzos. Dedica 10 minutos diarios a una actividad relajante (caminar, respirar, meditar). Calmar tu sistema nervioso es tan importante como calmar la inflamaci√≥n con la comida."
        ]
    },
    muscle: {
        science: `Perfecto. Este es un punto donde hay muchos mitos. La gente cree que Keto te hace perder m√∫sculo, y es todo lo contrario si se hace bien. Una alimentaci√≥n cetog√©nica bien formulada es <strong>'protectora de la masa muscular'</strong>. Cuando tu cuerpo se adapta a quemar grasa, deja de tener la necesidad de recurrir a las prote√≠nas (tus m√∫sculos) para obtener energ√≠a.<br><br>El resultado es lo que llamamos <strong>'recomposici√≥n corporal'</strong>. Al usar la grasa como energ√≠a, tu cuerpo se vuelve incre√≠blemente eficiente en eliminar la grasa que recubre los m√∫sculos, mientras que preserva la masa magra. Esto es lo que produce esa apariencia tonificada y definida que buscas. Adem√°s, la reducci√≥n de la inflamaci√≥n general te ayudar√° a recuperarte mejor y m√°s r√°pido de tus entrenamientos.`,
        steps: [
            "<strong>Calcula tu Prote√≠na Objetivo:</strong> Este es tu paso m√°s importante. Apunta a consumir entre 1.6 y 2.2 gramos de prote√≠na por cada kilogramo de tu peso corporal ideal. Divide esa meta entre tus comidas. La prote√≠na es el ladrillo para tus m√∫sculos.",
            "<strong>Entrenamiento de Fuerza es Prioridad:</strong> Debes darle a tus m√∫sculos una raz√≥n para crecer. Prioriza el entrenamiento con pesas (pesas, calistenia) al menos 3-4 veces por semana, enfoc√°ndote en la sobrecarga progresiva (levantar un poco m√°s o hacer m√°s repeticiones con el tiempo).",
            "<strong>Usa la Grasa como Palanca Energ√©tica:</strong> La grasa es tu energ√≠a para entrenar. No le temas. Aseg√∫rate de consumir suficientes grasas saludables para sentirte con energ√≠a durante tus sesiones. Si te sientes d√©bil, probablemente necesites m√°s grasa, no m√°s carbohidratos.",
            "<strong>El Sue√±o es Anab√≥lico:</strong> El m√∫sculo no crece en el gimnasio, crece mientras duermes. Apunta a 7-9 horas de sue√±o de calidad por noche. Durante el sue√±o profundo, tu cuerpo libera hormona de crecimiento, que es esencial para la reparaci√≥n y el crecimiento muscular."
        ]
    }
};

// --- 100% REWRITTEN CONTENT FOR ORIGINALITY AND PLAGIARISM-FREE GUARANTEE ---
const pathologyExplanations = {
    insulin_resistance: {
        title: "Punto de Enfoque: Resistencia a la Insulina / Diabetes tipo 2",
        cause: "Piensa en tus c√©lulas como casas y en la insulina como el cartero que entrega el paquete de energ√≠a (glucosa). Cuando hay resistencia, es como si las casas dejaran de abrirle la puerta al cartero. La energ√≠a se queda 'dando vueltas en la calle' (tu sangre), sin poder ser usada y generando problemas.",
        action: "Este plan cambia las reglas del juego. En vez de depender del 'cartero', le ense√±amos a tu cuerpo a usar su propia reserva de combustible: la grasa. Al bajar los carbohidratos, la insulina se toma un descanso, permitiendo que las 'casas' vuelvan a ser receptivas. Es un reinicio metab√≥lico para que tu cuerpo use la energ√≠a de forma eficiente."
    },
    hypertension: {
        title: "Punto de Enfoque: Hipertensi√≥n",
        cause: "Tus arterias deber√≠an ser como mangueras nuevas y flexibles. La hipertensi√≥n a menudo significa que esas 'mangueras' se han endurecido por la inflamaci√≥n cr√≥nica, como una manguera vieja al sol. Esto obliga a tu coraz√≥n a bombear con mucha m√°s fuerza para que la sangre circule, aumentando la presi√≥n en todo el sistema.",
        action: "Nuestra estrategia es 'rejuvenecer' esas mangueras desde adentro. Al eliminar los alimentos pro-inflamatorios como el az√∫car y las harinas, y enfocarnos en nutrientes que combaten la inflamaci√≥n, le devolvemos la flexibilidad a tus arterias. Esto le quita un tremendo peso de encima a tu coraz√≥n, permitiendo que la presi√≥n arterial baje de forma natural."
    },
    fatty_liver: {
        title: "Punto de Enfoque: H√≠gado Graso",
        cause: "El h√≠gado es la 'bodega' principal de tu cuerpo. Cuando lo inundas con un exceso de az√∫car y carbohidratos, la bodega se llena y el h√≠gado no tiene m√°s opci√≥n que empezar a guardar esa energ√≠a extra en forma de grasa dentro de sus propias paredes, lo que lo 'ahoga' y le impide hacer bien su trabajo.",
        action: "Lo que haremos es simple: cerraremos la llave de paso del az√∫car. Al hacer esto, no solo detenemos la acumulaci√≥n de nueva grasa, sino que forzamos al h√≠gado a abrir las compuertas de la 'bodega' y a quemar la grasa ya almacenada para obtener energ√≠a. Es una desintoxicaci√≥n y un alivio directo para tu motor metab√≥lico."
    },
    hypothyroidism: {
        title: "Punto de Enfoque: Hipotiroidismo",
        cause: "La tiroides es el 'termostato' de tu metabolismo. En el hipotiroidismo, este termostato funciona a un ritmo m√°s bajo, causando cansancio y lentitud. Este estado a menudo se ve empeorado por una inflamaci√≥n corporal generalizada, que act√∫a como un 'ruido de fondo' que interfiere a√∫n m√°s con la se√±al de la tiroides.",
        action: "Este plan act√∫a como un 'aislante ac√∫stico' para tu metabolismo. Al ser profundamente antiinflamatorio, reducimos ese 'ruido de fondo', permitiendo que la funci√≥n tiroidea que tienes trabaje de forma m√°s eficiente. Aunque no es un reemplazo de tu tratamiento, muchas personas sienten un aumento significativo de energ√≠a y vitalidad al quitarle esta carga extra al cuerpo."
    },
    inflammation: {
        title: "Punto de Enfoque: Inflamaci√≥n Sist√©mica",
        cause: "La inflamaci√≥n es la respuesta natural del cuerpo a una agresi√≥n. El problema es la inflamaci√≥n cr√≥nica: es como tener una gotera en casa que nunca reparas. D√≠a tras d√≠a, esa peque√±a gotera (causada por el az√∫car, el estr√©s, los malos aceites) va da√±ando la estructura, generando un desgaste silencioso que es la base de muchas enfermedades.",
        action: "Este plan es como llamar al mejor g√°sfiter para tu cuerpo. Primero, cerramos la llave de paso (eliminamos el az√∫car y los procesados). Segundo, usamos materiales de reparaci√≥n de alta calidad (grasas saludables y nutrientes). Y tercero, las cetonas que producir√°s act√∫an como un sellador anti-fugas, combatiendo activamente la inflamaci√≥n y permitiendo que tu cuerpo se repare de verdad."
    },
    insomnia: {
        title: "Punto de Enfoque: Insomnio y Fatiga Cr√≥nica",
        cause: "Tu energ√≠a diaria y tu sue√±o nocturno son dos caras de la misma moneda: el az√∫car en la sangre. Si durante el d√≠a vives en una 'monta√±a rusa' de energ√≠a por el az√∫car (subidones y bajones bruscos), por la noche tu cerebro sigue en esa misma monta√±a rusa, impidiendo un sue√±o profundo y reparador.",
        action: "El plan Keto te baja de la monta√±a rusa y te sube a un 'auto de lujo en carretera'. La energ√≠a que obtienes de las grasas es estable, predecible y duradera. Esto no solo te da una vitalidad constante durante el d√≠a, sin 'bajones', sino que le da a tu cerebro la calma y estabilidad que necesita para tener un sue√±o de calidad y verdaderamente reparador."
    }
};

// --- LIBRER√çA DE CONSEJOS PARA H√ÅBITOS ---
const habitAdviceLibrary = {
    'sleep_less': {
        title: 'Sobre Dormir Poco',
        text: 'Dormir menos de 7 horas dispara la hormona del estr√©s, cortisol. Esto no solo aumenta el az√∫car en sangre y promove el almacenamiento de grasa abdominal, sino que tambi√©n incrementa la grelina, la hormona del hambre, provocando antojos de energ√≠a r√°pida (az√∫car) al d√≠a siguiente. Priorizar el sue√±o es una estrategia metab√≥lica fundamental.'
    },
    'dine_late': {
        title: 'Sobre Comer Tarde por la Noche',
        text: 'Cenar tarde crea una batalla hormonal. Tu cuerpo intenta liberar melatonina para iniciar el descanso, pero al mismo tiempo debe liberar insulina para gestionar la comida. Esto interrumpe la calidad del sue√±o profundo, impide la quema de grasa nocturna y la autofagia (limpieza celular), procesos clave para la reparaci√≥n y la p√©rdida de peso.'
    },
    'low_salt': {
        title: 'Sobre Consumir Poca Sal',
        text: 'Contrario a la creencia popular, en una dieta baja en carbohidratos, el cuerpo excreta m√°s sodio. La falta de sal (sodio) es la causa principal de la "gripe keto", calambres y fatiga. Necesitas M√ÅS sal de buena calidad (sal de mar) para mantener el equilibrio de electrolitos, la energ√≠a y la funci√≥n de tus gl√°ndulas suprarrenales.'
    },
    'sweet_cravings': {
        title: 'Sobre los Antojos de Dulces',
        text: 'Los antojos de dulces son un s√≠ntoma de una monta√±a rusa de az√∫car en sangre. Cada vez que comes az√∫car, tu insulina se dispara para bajarla, y la ca√≠da brusca te hace desear m√°s az√∫car. Es un c√≠rculo vicioso. Al eliminar el az√∫car y usar grasas como energ√≠a, estabilizas el az√∫car en sangre y las cetonas reducen los antojos a nivel cerebral.'
    },
    'love_soda': {
        title: 'Sobre las Gaseosas y Energ√©ticas',
        text: 'Las gaseosas, incluso las "diet√©ticas", son metab√≥licamente da√±inas. Las azucaradas son una bomba de az√∫car directo al h√≠gado, promoviendo el h√≠gado graso. Las "diet" con edulcorantes artificiales pueden alterar tu microbiota intestinal y, en algunas personas, generar una respuesta de insulina, manteniendo vivos los antojos por lo dulce.'
    }
};

// --- LIBRER√çA PSICOL√ìGICA COMBINADA ---
const psicologiaCombinada = {
    'yes': {
        'always': {
            enfoquePsicologico: "Gracias por tu valent√≠a al compartir esto. Es vital que reconozcas esta intensa conexi√≥n: cuando el estr√©s es constante, tu cuerpo est√° en modo de supervivencia y busca alivio inmediato. Comer por emoci√≥n no es una falla de voluntad, sino una respuesta bioqu√≠mica para obtener una dosis r√°pida de calma a trav√©s de la comida. Este plan est√° dise√±ado para romper ese ciclo, d√°ndote energ√≠a estable desde las grasas para que tu cerebro no necesite esos 'rescates' de az√∫car.",
            consejoAntiEstres: "Como un primer paso para recuperar el control, te propongo una 'Pausa de Anclaje' de 1 minuto. Cuando sientas que el estr√©s te desborda, detente. Pon una mano sobre tu pecho y siente tu respiraci√≥n. No intentes cambiarla, solo si√©ntela. Este simple acto f√≠sico te reconecta con tu cuerpo en el presente y crea un espacio entre el impulso y la acci√≥n, d√°ndote el poder de elegir."
        },
        'often': {
            enfoquePsicologico: "Reconocer que el hambre emocional aparece junto al estr√©s frecuente es un paso gigante. Tu cuerpo ha aprendido que la comida puede ser una forma r√°pida de apagar la 'alarma' del estr√©s. Nuestro objetivo es darle a tu cuerpo una fuente de energ√≠a tan estable (las grasas) que ya no necesite sonar esa alarma con tanta frecuencia, reduciendo la urgencia de comer por impulso.",
            consejoAntiEstres: "Para manejar el estr√©s frecuente, prueba la t√©cnica 'Soltar la Carga'. Al final del d√≠a, toma 3 minutos para escribir en un papel todo lo que te preocup√≥. No tienes que solucionarlo, solo sacarlo de tu mente y ponerlo en el papel. Este acto simb√≥lico le dice a tu cerebro que puede 'soltar' esas preocupaciones por la noche, permitiendo un descanso m√°s reparador."
        },
        'sometimes': {
            enfoquePsicologico: "Es muy com√∫n que en los picos de estr√©s, aunque sean ocasionales, recurramos a la comida como una forma de consuelo. Lo importante es que ya lo identificas. Con este plan, al tener tu az√∫car en sangre estable, notar√°s que en esos momentos de estr√©s, la 'voz' que pide comida pierde mucha fuerza, d√°ndote m√°s control.",
            consejoAntiEstres: "Para esos momentos de estr√©s ocasional, usa el 'Cambio de Escena'. En lugar de ir a la cocina, sal a caminar 5 minutos, escucha una canci√≥n que te guste mucho o llama a un amigo. Cambiar tu entorno f√≠sico y mental rompe el patr√≥n autom√°tico que te lleva del estr√©s a la comida."
        },
        'never': {
            enfoquePsicologico: "Es interesante que, aunque no sientas estr√©s, s√≠ identifiques el hambre emocional. Esto puede indicar que el h√°bito est√° muy arraigado o que la causa es puramente bioqu√≠mica: la monta√±a rusa del az√∫car. Al estabilizar tu glucosa con Keto, le quitamos el combustible a ese impulso, permiti√©ndote nutrir tu cuerpo con verdadera intenci√≥n.",
            consejoAntiEstres: "Ya que no sientes estr√©s, tu herramienta ser√° la 'Nutrici√≥n Consciente'. Antes de comer, preg√∫ntate: '¬øEsto es hambre real o es un h√°bito?'. T√≥mate un vaso de agua y espera 5 minutos. Esta simple pausa te dar√° la claridad para diferenciar el hambre f√≠sica de la emocional."
        }
    },
    'sometimes': {
        'always': {
            enfoquePsicologico: "Es una carga muy pesada vivir con estr√©s constante, y es natural que 'a veces' la comida se convierta en una v√°lvula de escape. El problema es que el alivio es moment√°neo y el ciclo contin√∫a. Al darle a tu cerebro energ√≠a limpia y constante con las cetonas, reduciremos la necesidad de esas 'escapadas' y te daremos m√°s resiliencia frente al estr√©s.",
            consejoAntiEstres: "Cuando el estr√©s es tu estado base, necesitas una rutina de 'descompresi√≥n'. Dedica 5 minutos cada ma√±ana, antes de empezar tu d√≠a, a sentarte en silencio y enfocarte en un sonido agradable (p√°jaros, m√∫sica suave). Esto establece un tono de calma para el resto del d√≠a, haciendo que el estr√©s sea menos reactivo."
        },
        'often': {
            enfoquePsicologico: "Esta combinaci√≥n es muy com√∫n. El estr√©s frecuente desgasta nuestras defensas y nos hace m√°s vulnerables a caer en el hambre emocional. La buena noticia es que al atacar la ra√≠z bioqu√≠mica con Keto, fortalecemos esas defensas. Notar√°s que, aunque el estr√©s aparezca, tu respuesta autom√°tica de buscar comida disminuir√° significativamente.",
            consejoAntiEstres: "Implementa la 'Regla del Bloqueo de 10 minutos'. Cuando el estr√©s te haga pensar en comida, pon una alarma para 10 minutos. En ese tiempo, bebe un t√© o haz una tarea simple. Nueve de cada diez veces, cuando la alarma suene, el impulso intenso habr√° pasado, demostr√°ndote que tienes el control."
        },
        'sometimes': {
            enfoquePsicologico: "Reconocer que ambos factores aparecen 'a veces' es clave. Significa que tienes una buena base de control, pero hay detonantes espec√≠ficos que activan el ciclo. Este plan te ayudar√° a ser a√∫n m√°s consciente de esos momentos, ya que al no tener picos de glucosa, ser√° m√°s f√°cil identificar si el hambre es real o una respuesta a una situaci√≥n concreta.",
            consejoAntiEstres: "Tu herramienta ser√° el 'Diario de Detonantes'. Cuando sientas la combinaci√≥n de estr√©s y ganas de comer por emoci√≥n, anota r√°pidamente qu√© pas√≥ justo antes. ¬øUna reuni√≥n dif√≠cil? ¬øUna mala noticia? Identificar tus patrones es el primer paso para desactivarlos."
        },
        'never': {
            enfoquePsicologico: "Aqu√≠ vemos que el hambre emocional, aunque ocasional, no est√° ligada al estr√©s. Esto apunta fuertemente a una causa fisiol√≥gica. Probablemente, tus 'antojos' ocasionais coinciden con bajadas de az√∫car en sangre. Keto es la soluci√≥n perfecta para esto, ya que elimina esa monta√±a rusa de glucosa.",
            consejoAntiEstres: "Tu pr√°ctica ser√° la 'Planificaci√≥n de Snacks Inteligentes'. Ten siempre a mano un snack keto aprobado (un pu√±ado de almendras, unas aceitunas). As√≠, cuando aparezca el impulso, tienes una opci√≥n que te saciar√° sin sacarte del plan y sin reforzar el ciclo del az√∫car."
        }
    },
    'rarely': {
        'always': {
            enfoquePsicologico: "Es admirable que, a pesar de sentirlo constantemente, muy rara vez recurras a la comida. Esto demuestra una gran fortaleza mental. Sin embargo, ese estr√©s cr√≥nico sigue afectando tu metabolismo. Este plan te ayudar√° a combatir el estr√©s desde adentro, reduciendo la inflamaci√≥n que genera y d√°ndote m√°s energ√≠a para afrontarlo.",
            consejoAntiEstres: "Para ti, el foco es la recuperaci√≥n. El estr√©s cr√≥nico agota los nutrientes. Aseg√∫rate de cumplir con tu ingesta de electrolitos (especialmente magnesio antes de dormir) y considera un suplemento de Omega-3. Nutrir tu sistema nervioso es la mejor defensa contra el estr√©s a largo plazo."
        },
        'often': {
            enfoquePsicologico: "Tienes un excelente control, ya que a pesar del estr√©s frecuente, el hambre emocional es rara. Esto nos dice que tu principal batalla es contra los efectos fisiol√≥gicos del estr√©s. Al adoptar Keto, le dar√°s a tu cuerpo una energ√≠a m√°s resiliente que te ayudar√° a manejar esos periodos de estr√©s con mayor calma y claridad.",
            consejoAntiEstres: "Prueba la 'Respiraci√≥n Cuadrada'. Inhala durante 4 segundos, sost√©n el aire 4 segundos, exhala durante 4 segundos y mantente sin aire 4 segundos. Repite 5-10 veces. Es una t√©cnica usada por atletas y militares para calmar el sistema nervioso r√°pidamente en momentos de alta presi√≥n."
        },
        'sometimes': {
            enfoquePsicologico: "Este es un perfil muy resiliente. Indica que tienes una relaci√≥n muy consciente con la comida y buenas herramientas para manejar el estr√©s. Este plan actuar√° como un optimizador, llevando tu bienestar y claridad mental al siguiente nivel, haciendo que esos raros episodios sean a√∫n menos frecuentes.",
            consejoAntiEstres: "Tu estrategia es la 'Prevenci√≥n'. Si sabes que vas a entrar en una situaci√≥n estresante (ej. una presentaci√≥n importante), ten una comida rica en grasas saludables y prote√≠nas antes. Un cerebro bien nutrido y saciado es mucho menos susceptible al estr√©s."
        },
        'never': {
            enfoquePsicologico: "Este es el escenario ideal. No sufres de estr√©s y el hambre emocional es pr√°cticamente inexistente. Tienes una base psico-metab√≥lica s√≥lida. Para ti, este plan no es una reparaci√≥n, es una optimizaci√≥n para alcanzar tu m√°ximo potencial de energ√≠a y rendimiento cognitivo.",
            consejoAntiEstres: "Tu pr√°ctica es la 'Gratitud Activa'. Cada d√≠a, piensa en tres cosas espec√≠ficas por las que est√°s agradecido. Esto refuerza las v√≠as neuronales positivas y protege tu mente contra el estr√©s futuro, manteniendo esa fortaleza que ya posees."
        }
    },
    'never': {
        'always': {
            enfoquePsicologico: "Es impresionante que nunca uses la comida para lidiar con el estr√©s, a pesar de sentirlo constantemente. Tienes una disciplina de hierro. Sin embargo, ese estr√©s cr√≥nico sigue afectando tu metabolismo a nivel hormonal. Este plan te ayudar√° a mitigar ese da√±o interno, reduciendo la inflamaci√≥n y d√°ndote una energ√≠a m√°s estable.",
            consejoAntiEstres: "Tu enfoque debe ser el movimiento. El ejercicio de baja intensidad, como una caminata diaria de 30 minutos, es una de las formas m√°s efectivas de 'quemar' el exceso de cortisol y adrenalina generados por el estr√©s cr√≥nico. No es para quemar calor√≠as, es para limpiar tu sistema."
        },
        'often': {
            enfoquePsicologico: "Tienes una excelente disociaci√≥n entre emoci√≥n y comida. El estr√©s frecuente sigue siendo un desaf√≠o metab√≥lico. Al cambiar a Keto, tu cuerpo y cerebro tendr√°n un combustible m√°s eficiente, lo que te har√° sentir m√°s ecu√°nime y con mayor capacidad para gestionar esos picos de estr√©s sin que te agoten.",
            consejoAntiEstres: "Usa la 'T√©cnica de la Perspectiva'. Cuando te sientas estresado, preg√∫ntate: '¬øEsto importar√° en 5 d√≠as? ¬øEn 5 meses? ¬øEn 5 a√±os?'. Esta pregunta ayuda a redimensionar el problema y a reducir la respuesta de estr√©s inmediata."
        },
        'sometimes': {
            enfoquePsicologico: "Este es un perfil muy resiliente. Tienes una relaci√≥n sana con la comida y manejas bien el estr√©s ocasional. Para ti, este plan es una herramienta de bio-hacking para optimizar tu rendimiento, d√°ndote una claridad mental y una energ√≠a f√≠sica a√∫n mayores.",
            consejoAntiEstres: "Tu herramienta es la 'Planificaci√≥n Proactiva'. Identifica qu√© situaciones te generan estr√©s y planifica c√≥mo las afrontar√°s. Tener un plan de acci√≥n reduce la ansiedad anticipatoria y te da una sensaci√≥n de control que minimiza el impacto del estr√©s cuando llega."
        },
        'never': {
            enfoquePsicologico: "Felicidades, este es el estado √≥ptimo de bienestar psico-metab√≥lico. Tienes una relaci√≥n impecable con la comida y un sistema nervioso bien regulado. Este plan te servir√° para explorar los beneficios m√°s profundos de la cetosis, como la longevidad celular y el m√°ximo rendimiento cognitivo.",
            consejoAntiEstres: "Tu pr√°ctica es el 'Reto Positivo'. Ya que no tienes que luchar contra el estr√©s, canaliza esa energ√≠a en un nuevo reto que te entusiasme: aprender una nueva habilidad, un nuevo deporte. Esto mantiene tu cerebro pl√°stico y tu motivaci√≥n alta."
        }
    }
};

// --- LIBRER√çA DE CONSEJOS PARA COMIDA CHATARRA ---
const junkFoodAdviceLibrary = {
    'rarely': {
        text: "¬°Excelente! Disfrutar de un gusto de vez en cuando es parte de un estilo de vida sostenible. La clave es hacerlo de forma inteligente. La pr√≥xima vez que tengas antojo de una hamburguesa, te retamos a que la prepares en casa. Imagina: carne de alta calidad, queso derretido, tocino crujiente, palta y tus vegetales favoritos... todo dentro de un <strong>delicioso pan de hamburguesa keto</strong> que puedes hacer t√∫ mismo o encontrar en tiendas especializadas. Descubrir√°s que la versi√≥n casera y keto no solo es incre√≠blemente sabrosa, sino que te dejar√° sinti√©ndote con energ√≠a, no inflamado."
    },
    '1-2_weekly': {
        text: "Gracias por tu honestidad. Es importante que sepas que consumir comida chatarra varias veces por semana somete a tu cuerpo a un estr√©s metab√≥lico constante. No se trata solo de calor√≠as, sino de una avalancha de inflamaci√≥n. Los aceites vegetales refinados (soya, canola) aumentan la inflamaci√≥n celular, mientras que el exceso de az√∫car y harinas dispara tu insulina, promoviendo el almacenamiento de grasa y alimentando un ciclo de antojos. Este plan est√° dise√±ado para darte las herramientas para romper ese ciclo."
    },
    '3-4_weekly': {
        text: "Gracias por tu honestidad. Es importante que sepas que consumir comida chatarra varias veces por semana somete a tu cuerpo a un estr√©s metab√≥lico constante. No se trata solo de calor√≠as, sino de una avalancha de inflamaci√≥n. Los aceites vegetales refinados (soya, canola) aumentan la inflamaci√≥n celular, mientras que el exceso de az√∫car y harinas dispara tu insulina, promoviendo el almacenamiento de grasa y alimentando un ciclo de antojos. Este plan est√° dise√±ado para darte las herramientas para romper ese ciclo."
    },
    'daily': {
        text: `Aqu√≠ necesitamos ser completamente transparentes. Comer comida r√°pida a diario es una de las acciones m√°s perjudiciales para tu salud a largo plazo. Es similar a la advertencia que las cadenas de comida r√°pida est√°n obligadas a mostrar: estos alimentos est√°n asociados a enfermedades graves. Esto se debe a que no solo consumes calor√≠as vac√≠as, sino un c√≥ctel de qu√≠micos dise√±ados para crear adicci√≥n.<br><br>
        <strong>Algunos de los ingredientes que est√°s ingeriendo son:</strong><br>
        <ul class="list-disc list-inside mt-2 space-y-1">
            <li><strong>Aceites Hidrogenados (Grasas Trans):</strong> Se utilizan para fre√≠r porque son baratos y reutilizables. Tu cuerpo no puede procesarlos, lo que causa inflamaci√≥n masiva en tus arterias y c√©lulas.</li>
            <li><strong>Jarabe de Ma√≠z de Alta Fructosa:</strong> Un az√∫car ultraprocesado que va directo a tu h√≠gado, convirti√©ndose en grasa y siendo un precursor directo del h√≠gado graso y la resistencia a la insulina.</li>
            <li><strong>Glutamato Monos√≥dico (GMS):</strong> Un potenciador del sabor que 'enga√±a' a tu cerebro, haci√©ndote comer m√°s de lo que necesitas y anulando tus se√±ales naturales de saciedad.</li>
            <li><strong>Acrilamidas:</strong> Un compuesto qu√≠mico que se forma en alimentos ricos en almid√≥n (como las papas fritas) al ser cocinados a altas temperaturas. Las agencias de salud lo clasifican como un probable carcin√≥geno.</li>
        </ul><br>
        La decisi√≥n de seguir este plan es el primer paso para liberar a tu cuerpo de esta carga t√≥xica.`
    }
};

// --- LIBRER√çA DE CONSEJOS PARA BEBIDAS ---
const drinksAdviceLibrary = {
    'water': {
        title: 'La Jerarqu√≠a de la Hidrataci√≥n',
        text: "Has elegido el pilar fundamental de la vida, pero es crucial entender que no toda el agua hidrata de la misma manera.<br><ul class='list-disc list-inside mt-2 space-y-1'><li><strong>Agua de la Llave:</strong> A menudo contiene aditivos como el cloro, que puede da√±ar tu microbiota, y el fl√∫or, un disruptor endocrino que puede calcificar la gl√°ndula pineal, reguladora de tus ciclos de sue√±o.</li><li><strong>Agua Purificada:</strong> Es un agua 'muerta' y desmineralizada que puede 'robar' minerales de tu cuerpo.</li><li><strong>Agua Mineral:</strong> Es la opci√≥n superior, cargada de electrolitos naturales para una verdadera hidrataci√≥n celular.</li></ul>"
    },
    'juice': {
        title: 'La Verdad T√≥xica de la Fructosa',
        text: "Los jugos, incluso naturales, son una bomba de **fructosa** l√≠quida. Su metabolismo en el h√≠gado consume energ√≠a (ATP) y genera un residuo t√≥xico: **√°cido √∫rico**. El √°cido √∫rico elevado puede cristalizarse en las articulaciones causando **Gota** y, adem√°s, inhibe la producci√≥n de **√≥xido n√≠trico**, crucial para la salud de tus vasos sangu√≠neos y la presi√≥n arterial."
    },
    'soda': {
        title: 'El C√≥ctel Qu√≠mico de las Gaseosas',
        text: "Las gaseosas, incluidas las 'diet', son un ataque qu√≠mico a tu metabolismo. Las azucaradas conducen al h√≠gado graso. Las 'diet' usan qu√≠micos como el **aspartamo** (asociado en estudios con da√±os neurol√≥gicos) y el **colorante caramelo (E150d)**, cuyo proceso de fabricaci√≥n genera 4-MEI, un posible carcin√≥geno."
    },
    'coffee': {
        title: 'El Doble Filo del Caf√©',
        text: "El caf√© es una potente herramienta metab√≥lica por sus antioxidantes. Sin embargo, es un diur√©tico y su alto contenido en **oxalatos** puede aumentar el riesgo de c√°lculos renales si no se gestiona con una hidrataci√≥n inteligente."
    },
    'tea': {
        title: 'El Doble Filo del T√©',
        text: "El t√©, especialmente el verde, es rico en antioxidantes. No obstante, al igual que el caf√©, es un diur√©tico y contiene oxalatos. La clave es la moderaci√≥n y acompa√±arlo siempre de agua mineralizada."
    },
    'smart_combo': {
        title: 'Sinergia de Hidrataci√≥n Inteligente',
        text: "¬°Esta es una combinaci√≥n estrat√©gica! Entiendes que el caf√©/t√© aporta beneficios, pero que la verdadera **homeostasis h√≠drica** (el equilibrio de agua en tus c√©lulas) depende de minerales como el **sodio, potasio y magnesio**.<br><br><strong>Tu Protocolo Experto:</strong> Por cada taza de caf√© o t√©, bebe un vaso de agua mineral con una pizca de **sal de mar** (para el sodio y oligoelementos) y el **jugo de medio lim√≥n**. La sal repone los electrolitos que el caf√©/t√© elimina, y el citrato del lim√≥n es el inhibidor natural m√°s potente de la formaci√≥n de c√°lculos de oxalato. Con esta estrategia, obtienes todos los beneficios mientras anulas todos los riesgos."
    }
};

const personalizedAdviceLibrary = {
    alcohol_intake: {
        'yes': {
            emoji: 'üõë',
            title: "Foco Rojo: Consumo Regular de Alcohol",
            text: "El consumo de alcohol afecta gravemente al h√≠gado, provoca inflamaci√≥n, acumulaci√≥n de grasa y cicatrices, lo que puede derivar en enfermedades hep√°ticas graves como la cirrosis. Adem√°s, puede interferir con el metabolismo de las grasas y dificultar la p√©rdida de peso, lo que va en contra de los principios de la dieta cetog√©nica."
        },
        'occasionally': {
            emoji: 'ü•Ç',
            title: "Brindis Inteligente: Alcohol en Ocasiones",
            text: "Debemos aclarar que no recomendamos el consumo de alcohol para la dieta keto!, ya que te saca completamente de cetosis. y no ayuda en nada a nuestro h√≠gado. Pero entendemos que la vida tiene momentos para celebrar. ¬°No se trata de prohibir, sino de elegir sabiamente! Para esas ocasiones, prefiere destilados puros (whisky, gin, vodka, tequila) con agua mineral y hielo, o comparte una botella de vino (sin az√∫car adicionada o vinos soleados). Al final de la lista, cerveza ligera y espumantes Brut Nature o Extra Brut . As√≠ minimizas el az√∫car y el impacto en tu progreso. ¬°Salud por eso!"
        },
        'no': {
            emoji: 'üèÜ',
            title: "¬°Decisi√≥n de Campe√≥n!",
            text: "¬°Excelente! Esta es una de las decisiones que m√°s acelera los resultados. Al no consumir alcohol, le das a tu h√≠gado la libertad para enfocarse 100% en quemar grasa y desintoxicar tu cuerpo. Tienes una ventaja competitiva enorme. ¬°Felicidades!"
        }
    },
    cooking_skill: {
        'no': {
            emoji: 'üç≥',
            title: "¬°Bienvenido a tu Nueva Cocina!",
            text: "¬°No te preocupes en absoluto! Nuestras recetas est√°n dise√±adas para ser a prueba de principiantes: sencillas, r√°pidas y deliciosas. Ver√°s que te conviertes en un chef keto con confianza antes de lo que imaginas. ¬°Este es el inicio de una nueva habilidad!"
        },
        'beginner': {
            emoji: 'üë®‚Äçüç≥',
            title: "De Principiante a Profesional Keto",
            text: "¬°Perfecto! Tienes la curiosidad y las ganas, que es lo m√°s importante. Con nuestra gu√≠a, pasar√°s de amateur a un cocinero keto seguro, sorprendiendo a todos (incluy√©ndote a ti) con platos incre√≠bles y saludables."
        },
        'intermediate': {
            emoji: 'üî•',
            title: "Perfeccionando tus Habilidades",
            text: "¬°Genial! Ya tienes una base s√≥lida. Este plan te dar√° las herramientas y los 'secretos' keto para llevar tus habilidades al siguiente nivel. Aprender√°s a optimizar sabores y nutrientes para potenciar a√∫n m√°s tus resultados."
        },
        'advanced': {
            emoji: 'üåü',
            title: "El Lado Gourmet de Keto te Espera",
            text: "¬°Fant√°stico! Un chef en la cocina. Prep√°rate para explorar el lado m√°s sofisticado de Keto. Con tu habilidad, podr√°s crear verdaderas obras de arte culinarias que no solo son deliciosas, sino que son tu mejor medicina."
        }
    },
    activity_level: {
        'sedentary': {
            emoji: 'üå±',
            title: "Este es el comienzo de tu Transformaci√≥n",
            text: "Este es el punto de partida perfecto para un cambio incre√≠ble. Nuestras mitocondrias son las fuentes energ√©ticas de nuestro cuerpo, y se multiplican principalmente a trav√©s de un proceso llamado biog√©nesis mitocondrial, que es estimulado por el ejercicio f√≠sico. a mas mitocondrias, m√°s grasa quemas!. No necesitas ser un atleta. Empezaremos a despertar tu metabolismo con movimientos y rutinas suaves y efectivos. Cada paso, por peque√±o que sea, construye un gran progreso."
        },
        'light': {
            emoji: 'üö∂‚Äç‚ôÇÔ∏è',
            title: "Encendiendo tu Metabolismo.",
            text: "¬°Excelente! Ya tienes el h√°bito del movimiento, y eso es una gran victoria. Ahora, vamos a optimizar esa actividad para que cada paso se convierta en una se√±al potente para pasar al pr√≥ximo nivel, quemar grasa y construir energ√≠a duradera."
        },
        'moderate': {
            emoji: 'üí™',
            title: "Hacia un Nuevo Nivel de Energ√≠a",
            text: "Est√°s en el punto ideal. Al combinar tu entrenamiento con la energ√≠a estable de Keto, vas a experimentar una resistencia y potencia que quiz√°s no conoc√≠as. Prep√°rate para superar tus propios l√≠mites y transformar tu cuerpo."
        },
        'high': {
            emoji: 'üöÄ',
            title: "Rendimiento de √âlite",
            text: "Impresionante. Ya est√°s construyendo tu mejor versi√≥n!. La alimentaci√≥n Keto puede ser el eslab√≥n perdido para llevar tu rendimiento y recuperaci√≥n a un nivel superior. Usaremos la grasa como un combustible de alto octanaje para tu motor. ¬°A romper tus propios r√©cords!"
        }
    },
    eat_out_freq: {
        'daily': {
            emoji: 'üèôÔ∏è',
            title: "Navegando el Men√∫ como un Experto",
            text: "Comer fuera a diario es un desaf√≠o, pero no un obst√°culo insuperable. En nuestra gu√≠a, encontrar√°s una secci√≥n dedicada a convertirte en un 'detective de men√∫s', para que sepas exactamente qu√© pedir y qu√© evitar para mantenerte en cetosis y disfrutar."
        },
        'weekly': {
            emoji: 'üçΩÔ∏è',
            title: "Disfrutando Fuera de Casa",
            text: "Perfecto para mantener un equilibrio. Te ense√±aremos los trucos para que tus salidas semanales sean un placer sin culpa. Aprender√°s a elegir platos que te mantengan en el camino correcto sin sacrificar tu vida social."
        },
        'monthly': {
            emoji: 'üéâ',
            title: "Salidas Ocasionales, Cero Estr√©s",
            text: "Tus salidas son un gusto especial, y as√≠ deben seguir. Te daremos una gu√≠a r√°pida para que, cuando llegue la ocasi√≥n, sepas exactamente qu√© opciones del men√∫ son tus aliadas para seguir disfrutando y progresando."
        },
        'rarely': {
            emoji: 'üè°',
            title: "El Control est√° en tus Manos",
            text: "¬°Esto es una gran ventaja! Cocinar en casa te da el m√°ximo control sobre la calidad de tus ingredientes. Y para esas raras ocasiones que comas fuera, nuestra gu√≠a te preparar√° para que lo hagas como un profesional."
        }
    }
};


const imcCategories = [
    { range: [0, 15.9], name: 'Delgadez Severa', rangeText: '< 16.0', definition: 'Un peso significativamente bajo que puede suponer un riesgo para la salud.' },
    { range: [16, 16.9], name: 'Delgadez Moderada', rangeText: '16.0 - 16.9', definition: 'Indica un peso bajo. Es importante asegurar una nutrici√≥n adecuada.' },
    { range: [17, 18.4], name: 'Delgadez Aceptable', rangeText: '17.0 - 18.4', definition: 'Est√°s en el l√≠mite inferior del peso saludable. Un plan bien estructurado te ayudar√°.' },
    { range: [18.5, 24.9], name: 'Peso Normal', rangeText: '18.5 - 24.9', definition: '¬°Felicidades! Tu peso est√° en un rango saludable y equilibrado.' },
    { range: [25, 29.9], name: 'Sobrepeso', rangeText: '25.0 - 29.9', definition: 'Indica un exceso de peso corporal que puede aumentar el riesgo de problemas de salud.' },
    { range: [30, 34.9], name: 'Obesidad Tipo I', rangeText: '30.0 - 34.9', definition: 'Un nivel de exceso de peso que requiere atenci√≥n para prevenir complicaciones de salud.' },
    { range: [35, 39.9], name: 'Obesidad Tipo II', rangeText: '35.0 - 39.9', definition: 'Considerada una obesidad severa. Es un buen momento para tomar acci√≥n.' },
    { range: [40, 49.9], name: 'Obesidad Tipo III (M√≥rbida)', rangeText: '40.0 - 49.9', definition: 'Un grado de obesidad que presenta un alto riesgo para la salud. Este plan es un gran primer paso.' },
    { range: [50, Infinity], name: 'Obesidad Tipo IV (Extrema)', rangeText: '‚â• 50.0', definition: 'El nivel m√°s alto de obesidad, que requiere un plan de acci√≥n inmediato y supervisado.' }
];

// --- App Start & Wizard Logic ---
function startQuestionnaire() {
    console.log("Starting questionnaire...");
    const accessScreen = document.getElementById('access-screen');
    const wizard = document.getElementById('onboarding-wizard');
    if (accessScreen) accessScreen.classList.add('hidden');
    
    if (wizard) {
        appState.wizardFlow = [...baseWizardSteps, { id: 'action_plan', type: 'action_plan' }];
        appState.currentStepIndex = 0;
        document.getElementById('app-container').classList.add('hidden');
        wizard.classList.remove('hidden');
        wizard.classList.add('flex');
        renderCurrentStep();
        const backBtn = document.getElementById('wizard-back-btn');
        if(backBtn) backBtn.style.display = 'none';
        console.log("Onboarding wizard displayed.");
    }
}

function renderCurrentStep() {
    const stepData = appState.wizardFlow[appState.currentStepIndex];
    const container = document.getElementById('wizard-steps-container');
    if (!container || !stepData) {
        console.error("Container or step data not found for rendering current step.");
        return;
    }

    console.log(`Rendering step: ${stepData.id} (Type: ${stepData.type})`);
    let stepHtml = '';

    if (stepData.type === 'question') stepHtml = createQuestionStep(stepData);
    else if (stepData.type === 'info_card') stepHtml = createInfoCardStep(stepData);
    else if (stepData.type === 'final') stepHtml = createFinalStep(stepData);
    else if (stepData.type === 'conditional_input') stepHtml = createConditionalInputStep(stepData);
    else if (stepData.type === 'action_plan') {
        createActionPlan();
        return;
    }
    
    container.innerHTML = stepHtml;

    if (stepData.type === 'question') {
        document.querySelectorAll('.option-button').forEach(button => {
            addTrackedListener(button, 'click', () => selectOption(button, stepData.multiple));
        });
    }
    
    updateProgress();
    checkNextButtonState();
}

function nextStep() {
    const currentStep = appState.wizardFlow[appState.currentStepIndex];
    if (!currentStep) {
        console.error("Current step not found for nextStep.");
        return;
    }
    
    if (currentStep.type === 'question') {
        const selected = Array.from(document.querySelectorAll('.option-button.selected')).map(b => b.dataset.value);
        if (selected.length === 0) {
            showToast('Por favor, selecciona una opci√≥n.', 'error');
            return;
        }
        appState.answers[currentStep.key] = currentStep.multiple ? selected : selected[0];
    } else if (currentStep.type === 'final') {
        if (!saveFinalMeasures()) return;
    } else if (currentStep.type === 'conditional_input') {
        saveConditionalData(currentStep);
    }

    if (currentStep.id === 'health_conditions') {
        insertConditionalSteps(appState.answers.health_conditions);
    } else if (currentStep.id === 'final_measures') {
        const imc = calculateIMC(appState.answers.measurements.height, appState.answers.measurements.weight);
        if (imc >= 30 && !appState.wizardFlow.some(s => s.id === 'cond_lipids')) {
             appState.wizardFlow.splice(appState.currentStepIndex + 1, 0, conditionalSteps.obesity);
        }
    }
    
    if (appState.currentStepIndex < appState.wizardFlow.length - 1) {
        appState.currentStepIndex++;
        renderCurrentStep();
        const backBtn = document.getElementById('wizard-back-btn');
        if(backBtn) backBtn.style.display = 'block';
    } else {
        console.log("Wizard finished. Creating action plan.");
        createActionPlan();
    }
}

function prevStep() {
    if (appState.currentStepIndex > 0) {
        appState.currentStepIndex--;
        renderCurrentStep();
        console.log(`Moved to previous step: ${appState.wizardFlow[appState.currentStepIndex].id}`);
    }

    const backBtn = document.getElementById('wizard-back-btn');
    if (appState.currentStepIndex === 0 && backBtn) {
        backBtn.style.display = 'none';
    }
}

function insertConditionalSteps(conditions) {
    if (!Array.isArray(conditions) || conditions.includes('none')) return;
    const stepsToInsert = conditions
        .map(condition => conditionalSteps[condition])
        .filter(step => step && !appState.wizardFlow.some(s => s.id === step.id));
    if (stepsToInsert.length > 0) {
        appState.wizardFlow.splice(appState.currentStepIndex + 1, 0, ...stepsToInsert);
        console.log("Inserted conditional steps:", stepsToInsert.map(s => s.id));
    }
}

function createActionPlan() {
    console.log("Creating action plan (transitioning to main app)...");
    const wizard = document.getElementById('onboarding-wizard');
    if (!wizard) {
        console.error("Onboarding wizard element not found.");
        return;
    }
    wizard.style.transition = 'opacity 0.5s ease-out';
    wizard.style.opacity = '0';
    setTimeout(() => {
        wizard.classList.add('hidden');
        wizard.classList.remove('flex');
        const appContainer = document.getElementById('app-container');
        if (appContainer) {
            appContainer.classList.remove('hidden');
            appContainer.classList.add('flex');
            console.log("Main app container displayed.");
        }
        initializeApp(false);
    }, 500);
}

// --- HTML Generation for Steps ---
function createQuestionStep(stepData) {
    const gridCols = stepData.options.length > 4 ? 'grid-cols-1 md:grid-cols-2' : 'grid-cols-1';
    let optionsHtml = stepData.options.map(opt => `
        <button class="option-button w-full text-left p-4 rounded-lg font-semibold text-lg flex items-center" data-value="${opt.value}">
            <span>${opt.text}</span>
        </button>
    `).join('');
    return `<div class="w-full max-w-2xl text-center text-white px-4"><h2 class="text-2xl md:text-3xl font-bold mb-8">${stepData.question}</h2><div class="grid ${gridCols} gap-4">${optionsHtml}</div></div>`;
}

function createInfoCardStep(stepData) {
    const imageUrl = infoCardGraphics[stepData.graphic_placeholder];
    let graphicHtml = `<div class="w-full h-64 bg-gray-900/30 rounded-lg flex items-center justify-center my-4 border border-dashed border-gray-600">
        <span class="text-gray-500 text-sm italic">Espacio para gr√°fico: ${stepData.graphic_placeholder}</span>
    </div>`;

    if (imageUrl) {
        graphicHtml = `<div class="my-4"><img src="${imageUrl}" alt="${stepData.title}" class="w-full h-auto object-contain max-h-72" onerror="this.onerror=null;this.src='https://placehold.co/400x288/1e1b2e/ffffff?text=Imagen';"></div>`;
    }

    return `<div class="w-full max-w-md text-center text-white px-4">
                <div class="info-card-onboarding p-4 rounded-2xl">
                    ${graphicHtml}
                    <div class="text-gray-300 text-lg px-4 mt-4">${stepData.text}</div>
                </div>
            </div>`;
}

function createFinalStep(stepData) {
    return `<div class="w-full max-w-md text-white">
                <h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">${stepData.question}</h2>
                <div class="space-y-4 text-left bg-gray-800 bg-opacity-50 p-6 rounded-lg border border-gray-700">
                    <div><label for="final-age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="final-age" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition"></div>
                    <div><label for="final-altura" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="final-altura" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition"></div>
                    <div><label for="final-peso" class="block text-sm font-medium text-gray-300 mb-1">Peso Actual (kg)</label><input type="number" id="final-peso" class="w-full bg-gray-900 border border-gray-600 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none transition"></div>
                </div>
            </div>`;
}

function createConditionalInputStep(stepData) {
    let inputsHtml = '';
    if (stepData.multiple) {
        inputsHtml = stepData.fields.map(field => `<div><label for="cond-input-${field.key}" class="block text-sm font-medium text-gray-300 mb-1">${field.placeholder}</label><input type="${field.inputType || 'text'}" id="cond-input-${field.key}" data-key="${field.key}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="${field.placeholder}"></div>`).join('');
    } else {
        inputsHtml = `<div><label for="cond-input-${stepData.key}" class="block text-sm font-medium text-gray-300 mb-1">${stepData.placeholder}</label><input type="${stepData.inputType || 'text'}" id="cond-input-${stepData.key}" data-key="${stepData.key}" class="w-full bg-gray-900 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-blue-500 outline-none transition" placeholder="${stepData.placeholder}"></div>`;
    }
    return `<div class="w-full max-w-md text-white"><h2 class="text-2xl md:text-3xl font-bold mb-8 text-center">${stepData.question}</h2><div class="space-y-4 text-left bg-gray-800 bg-opacity-50 p-6 rounded-lg border border-gray-700">${inputsHtml}</div></div>`;
}

// --- Data Saving ---
function saveFinalMeasures() {
    const age = document.getElementById('final-age').value;
    const height = document.getElementById('final-altura').value;
    const weight = document.getElementById('final-peso').value;
    if (!age || !height || !weight) {
        showToast('Por favor, completa edad, altura y peso.', 'error');
        return false;
    }
    appState.answers.measurements = { age: parseInt(age), height: parseFloat(height), weight: parseFloat(weight) };
    console.log("App State after final measures:", appState.answers);
    return true;
}

function saveConditionalData(step) {
    if (step.multiple) {
        appState.answers[step.key] = {};
        step.fields.forEach(field => {
            const input = document.getElementById(`cond-input-${field.key}`);
            if (input && input.value) {
                appState.answers[step.key][field.key] = input.value;
            }
        });
    } else {
        const input = document.getElementById(`cond-input-${step.key}`);
        if (input && input.value) {
            appState.answers[step.key] = input.value;
        }
    }
    console.log(`Conditional data saved for ${step.key}:`, appState.answers[step.key]);
}

// --- Wizard State & UI ---
function checkNextButtonState() {
    const step = appState.wizardFlow[appState.currentStepIndex];
    const nextBtn = document.getElementById('wizard-next-btn');
    if (!step || !nextBtn) return;
    
    if (step.type === 'info_card' || step.type === 'conditional_input') {
        nextBtn.disabled = false;
    } else if (step.type === 'question') {
        nextBtn.disabled = document.querySelectorAll('.option-button.selected').length === 0;
    } else if (step.type === 'final') {
        const ageEl = document.getElementById('final-age');
        const heightEl = document.getElementById('final-altura');
        const weightEl = document.getElementById('final-peso');
        
        const update = () => {
             nextBtn.disabled = !ageEl.value || !heightEl.value || !weightEl.value;
        };

        addTrackedListener(ageEl, 'input', update);
        addTrackedListener(heightEl, 'input', update);
        addTrackedListener(weightEl, 'input', update);
        update(); // Initial check
    }
}

function updateProgress() {
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    if (!progressBar || !progressText) return;

    const progress = (appState.currentStepIndex / (appState.wizardFlow.length - 1)) * 100;
    progressBar.style.width = `${progress}%`;
    progressText.innerText = `${Math.round(progress)}%`;
}

function selectOption(button, isMultiple) {
    const value = button.dataset.value;
    if (value === 'none') {
        document.querySelectorAll('.option-button.selected').forEach(b => b.classList.remove('selected'));
        button.classList.add('selected');
    } else {
        const noneButton = document.querySelector('.option-button[data-value="none"]');
        if (noneButton) noneButton.classList.remove('selected');
        if (!isMultiple) {
            document.querySelectorAll('.option-button.selected').forEach(b => {
                if (b !== button) b.classList.remove('selected');
            });
        }
        button.classList.toggle('selected');
    }
    checkNextButtonState();
}

// --- Helper & Calculation Functions ---
function calculateIMC(height, weight) {
    return (height > 0 && weight > 0) ? (weight / ((height / 100) ** 2)) : 0;
}

function getIMCCategory(imc) {
    return imcCategories.find(cat => imc >= cat.range[0] && imc <= cat.range[1]) || { name: 'N/A', definition: '' };
}

function calculateHealthyWeightRange(height) {
    if (!height || height <= 0) return null;
    const heightInMeters = height / 100;
    const minWeight = 18.5 * (heightInMeters ** 2);
    const maxWeight = 24.9 * (heightInMeters ** 2);
    const idealWeight = 21.75 * (heightInMeters ** 2);
    return {
        min: minWeight.toFixed(1),
        max: maxWeight.toFixed(1),
        ideal: idealWeight.toFixed(1)
    };
}


function calculateWaterIntake(weight, height, age, gender, activity_level) {
    if (isNaN(weight) || weight <= 0 || isNaN(height) || height <= 0 || isNaN(age) || age <= 0 || !gender || !activity_level) {
        console.warn("Invalid input for calculateWaterIntake. Returning null.");
        return null;
    }

    let bmr = (10 * weight) + (6.25 * height) - (5 * age);
    bmr += (gender === 'male' ? 5 : -161);
    const activityMultipliers = { sedentary: 1.2, light: 1.375, moderate: 1.55, high: 1.725 };
    const multiplier = activityMultipliers[activity_level] || 1.2;
    const tdee = bmr * multiplier;
    const waterLiters = (tdee * 1.5) / 1000;
    return Math.max(2.0, waterLiters);
}

function renderImcDetails(container, height, weight) {
    if(!container) return;
    container.innerHTML = '';
    const h = parseFloat(height), w = parseFloat(weight);
    if (h > 0 && w > 0) {
        const imc = calculateIMC(h, w);
        const imcCategory = getIMCCategory(imc);
        let html = `<p class="text-5xl font-bold">${imc.toFixed(1)}</p><p class="text-lg text-gray-300 mt-1">${imcCategory.name}</p><ul class="space-y-1 text-sm mt-4">`;
        imcCategories.forEach(cat => {
            const isCurrent = (imc >= cat.range[0] && imc <= cat.range[1]);
            html += `<li class="flex justify-between items-center p-2 rounded-md transition-all duration-300 ${isCurrent ? 'bg-blue-900/50 ring-1 ring-blue-400' : ''}"><span>${cat.name}</span><span class="font-mono text-gray-400">${cat.rangeText}</span></li>`;
        });
        html += '</ul>';
        container.innerHTML = html;
        console.log(`IMC calculated: ${imc.toFixed(1)} (${imcCategory.name})`);
    } else {
        container.innerHTML = '<p class="text-gray-400">Ingresa tus datos para calcular.</p>';
        console.warn("Cannot calculate IMC: height or weight is zero/invalid.");
    }
}


// --- Main App Initialization ---
function initializeApp(isReloading = false) {
    console.log(`Initializing app... (Reloading: ${isReloading})`);
    if (isAppInitialized) {
        console.log("App already initialized, re-rendering dashboard.");
        renderDashboard();
        return;
    }
    
    if (!isReloading) {
        const { measurements, glucose_level, blood_pressure, lipids, accessCode } = appState.answers;
        
        appState.userData.altura = measurements.height;
        appState.userData.pesoInicial = measurements.weight;
        appState.userData.pesoActual = measurements.weight;
        appState.userData.historialPeso.push({ fecha: new Date().toISOString().split('T')[0], peso: measurements.weight });
        
        appState.userData.historialGlucosa = [];
        appState.userData.historialPresion = [];
        appState.userData.historialLipidico = [];

        if (glucose_level) {
            appState.userData.historialGlucosa.push({ fecha: new Date().toISOString().split('T')[0], valor: parseFloat(glucose_level) });
        }
        if (blood_pressure) {
            const [sistolica, diastolica] = blood_pressure.split('/').map(Number);
            if(sistolica && diastolica) {
                appState.userData.historialPresion.push({ fecha: new Date().toISOString().split('T')[0], sistolica: sistolica, diastolica: diastolica });
            }
        }
        if (lipids && Object.keys(lipids).length > 0) {
            appState.userData.historialLipidico.push({
                fecha: new Date().toISOString().split('T')[0],
                triglycerides: parseFloat(lipids.triglycerides) || null,
                hdl: parseFloat(lipids.hdl) || null,
                ldl: parseFloat(lipids.ldl) || null
            });
        }

        sendDataToGoogleSheet();
        try {
            localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
            localStorage.setItem('ketoOriginsSession', JSON.stringify({ code: accessCode, userId: appState.userId }));
            console.log("App state and session saved to localStorage.");
        } catch (e) {
            console.error("Error saving to localStorage:", e);
        }
    }

    isAppInitialized = true;
    console.log("App initialized. User data:", appState.userData);

    renderDashboard();
    setupEventListeners();
    setActiveNavLink();
}

// --- Dashboard Rendering ---

function generateMainGoalAccordion(goal) {
    const plan = mainGoalPlan[goal];
    if (!plan) return '';

    const stepsHtml = plan.steps.map((step, index) => `
        <li class="flex items-start mb-2">
            <span class="text-green-400 font-bold mr-3">${index + 1}.</span>
            <span class="text-gray-300">${step}</span>
        </li>
    `).join('');

    return `
        <div class="mb-6">
            <div class="dashboard-card">
                <button class="accordion-button w-full flex justify-between items-center text-left p-0">
                    <span class="font-semibold text-lg text-cyan-400">üëá La ciencia de tu plan y tus primeros pasos</span>
                    <span class="accordion-arrow text-2xl text-cyan-400">&rarr;</span>
                </button>
                <div class="accordion-content">
                    <div class="pt-4 border-t border-gray-700/50 mt-4">
                        <p class="text-gray-300 mb-4">${plan.science}</p>
                        <h4 class="font-bold text-green-400 mb-2">Tu Plan de Acci√≥n Metab√≥lica:</h4>
                        <ul class="list-none p-0">${stepsHtml}</ul>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function generatePersonalizedAdvice(answers) {
    let adviceHtml = '';
    const handledKeys = new Set();

    const createAccordionHtml = (advice) => {
        return `
            <div>
                <button class="accordion-button w-full flex justify-between items-center text-left bg-gray-800/50 p-4 rounded-lg hover:bg-gray-700/50 transition">
                    <span class="font-semibold text-lg text-cyan-400 flex items-center">
                        <span class="text-2xl mr-3">${advice.emoji || ''}</span>
                        <span>${advice.title}</span>
                    </span>
                    <span class="accordion-arrow text-2xl text-cyan-400">&rarr;</span>
                </button>
                <div class="accordion-content">
                    <div class="pt-4 text-sm text-gray-300">${advice.text}</div>
                </div>
            </div>
        `;
    };

    const selectedHabits = answers.habits;
    if (selectedHabits && Array.isArray(selectedHabits) && selectedHabits.length > 0 && !selectedHabits.includes('none')) {
        let combinedText = selectedHabits.map(habitKey => {
            const advice = habitAdviceLibrary[habitKey];
            return advice ? `<p class="mb-3"><strong>${advice.title}:</strong> ${advice.text}</p>` : '';
        }).join('');
        const stormAccordion = { emoji: '‚ö†Ô∏è', title: 'An√°lisis Cr√≠tico: La Tormenta Metab√≥lica Perfecta', text: combinedText };
        adviceHtml += createAccordionHtml(stormAccordion);
    }

    const emotionalResponse = answers.emotional_eating;
    const stressResponse = answers.stress_level;
    if (emotionalResponse && stressResponse && psicologiaCombinada[emotionalResponse] && psicologiaCombinada[emotionalResponse][stressResponse]) {
        const adviceData = psicologiaCombinada[emotionalResponse][stressResponse];
        const combinedText = `<p class="mb-3">${adviceData.enfoquePsicologico}</p><p><strong>Tu primer paso pr√°ctico:</strong> ${adviceData.consejoAntiEstres}</p>`;
        const psychoAccordion = { emoji: '‚ù§Ô∏è‚Äçü©π', title: 'Sanando la Relaci√≥n con la Comida', text: combinedText };
        adviceHtml += createAccordionHtml(psychoAccordion);
        handledKeys.add('emotional_eating'); 
    }

    const waterIntakeResponse = answers.water_intake;
    if (waterIntakeResponse) {
        const waterGoal = calculateWaterIntake(answers.measurements.weight, answers.measurements.height, answers.measurements.age, answers.gender, answers.activity_level);
        let hydrationText = '', userIntakeLiters = 0;
        switch (waterIntakeResponse) {
            case 'less_2': userIntakeLiters = 0.25; break;
            case '2-4': userIntakeLiters = 0.75;  break;
            case '4-6': userIntakeLiters = 1.25; break;
            case 'more_6': userIntakeLiters = 1.75; break;
        }
        if (waterGoal === null) {
            hydrationText = `<p class="text-gray-400">Datos insuficientes o inv√°lidos para calcular tu meta de hidrataci√≥n.</p>`;
        } else if (waterIntakeResponse === 'less_2') {
            hydrationText = `Gracias por tu honestidad. Aqu√≠ hemos detectado un foco rojo de alto riesgo para tu salud. Tu meta diaria de hidrataci√≥n es de <strong>${waterGoal.toFixed(1)} litros</strong>, pero actualmente tu ingesta es m√≠nima. Esto es una emergencia metab√©tica silenciosa. La deshidrataci√≥n cr√≥nica, incluso si no sientes sed, tiene consecuencias graves:
<ul class="list-disc list-inside mt-2 space-y-1">
    <li><strong>Estr√©s Cardiovascular:</strong> Tu volumen sangu√≠neo disminuye, lo que obliga a tu coraz√≥n a bombear com m√°s fuerza y eleva tu presi√≥n arterial.</li>
    <li><strong>Toxicidad Acumulada:</strong> Tus ri√±ones no tienen suficiente l√≠quido para filtrar y eliminar las toxinas de tu cuerpo, lo que lleva a una acumulaci√≥n interna.</li>
    <li><strong>Niebla Mental y Fatiga:</strong> La entrega de ox√≠geno a tu cerebro se ve dr√°sticamente reducida, causando confusi√≥n, falta de concentraci√≥n y un cansancio que ning√∫n caf√© puede solucionar.</li>
</ul>
<p class="mt-2">Tu misi√≥n m√°s importante, que no es negociable, es comenzar a hidratarte correctamente desde hoy. Tu primera meta es simplemente beber m√°s agua, y la forma ideal de hacerlo es con la combinaci√≥n perfecta: Agua Mineral (nunca purificada ni de la llave, por su contenido de fl√∫or y cloro) con una pizca de sal de mar y el jugo de medio lim√≥n. Esto no solo hidrata, sino que repone los minerales esenciales para que el agua pueda entrar a tus c√©lulas.</p>`;
        } else if (userIntakeLiters < waterGoal) {
            hydrationText = `¬°Excelente que ya tengas el h√°bito de beber agua! Est√°s en camino y muy cerca del objetivo. Tu meta de hidrataci√≥n es de <strong>${waterGoal.toFixed(1)} litros</strong>, y actualmente est√°s consumiendo alrededor de <strong>${userIntakeLiters.toFixed(1)} litros</strong>. Est√°s a solo unos vasos de diferencia. Ese √∫ltimo tramo es el que marca la diferencia entre simplemente 'funcionar' y 'prosperar'. Ese extra de agua potenciar√° la quema de grasa, mejorar√° dr√°sticamente la apariencia de tu piel y aumentar√° tu claridad mental. Para optimizar tu esfuerzo, recuerda siempre la combinaci√≥n perfecta: Agua Mineral con sal de mar y lim√≥n.`;
        } else {
            hydrationText = `¬°Felicidades! Este es uno de los h√°bitos m√°s importantes para el √©xito en Keto y ya lo tienes dominado. Tu ingesta de agua cumple o supera tu meta de <strong>${waterGoal.toFixed(1)} litros</strong>. Esto significa que est√°s apoyando activamente la desintoxicaci√≥n de tu cuerpo, manteniendo tus c√©lulas energizadas y optimizando cada proceso metab√≥lico. Recuerda siempre la combinaci√≥n perfecta para potenciar a√∫n m√°s los resultados: Agua Mineral + Sal de Mar + Lim√≥n.`;
        }
        const hydrationAccordion = { emoji: 'üíßüìà', title: 'An√°lisis de tu Hidrataci√≥n', text: hydrationText };
        adviceHtml += createAccordionHtml(hydrationAccordion);
    }

    for (const key in personalizedAdviceLibrary) {
        if (handledKeys.has(key)) continue;
        const userResponse = answers[key];
        if (userResponse) {
            const processResponse = (responseValue) => {
                if (personalizedAdviceLibrary[key]?.[responseValue]) {
                    adviceHtml += createAccordionHtml(personalizedAdviceLibrary[key][responseValue]);
                }
            };
            Array.isArray(userResponse) ? userResponse.forEach(processResponse) : processResponse(userResponse);
        }
    }
    
    const junkFoodResponse = answers.junk_food_freq;
    if (junkFoodResponse && junkFoodAdviceLibrary[junkFoodResponse]) {
        const junkFoodAccordion = { emoji: 'üçîüçï', title: 'La Verdad Oculta en la Comida R√°pida', text: junkFoodAdviceLibrary[junkFoodResponse].text };
        adviceHtml += createAccordionHtml(junkFoodAccordion);
    }

    const selectedDrinks = answers.daily_drinks;
    if (selectedDrinks && Array.isArray(selectedDrinks) && selectedDrinks.length > 0 && !selectedDrinks.includes('none')) {
        let drinksText = '';
        const hasWater = selectedDrinks.includes('water'), hasStimulant = selectedDrinks.includes('coffee') || selectedDrinks.includes('tea');
        if (hasWater && hasStimulant) {
            drinksText = `<p class="mb-3"><strong>${drinksAdviceLibrary.smart_combo.title}:</strong> ${drinksAdviceLibrary.smart_combo.text}</p>`;
            selectedDrinks.filter(d => d !== 'water' && d !== 'coffee' && d !== 'tea').forEach(drinkKey => {
                if (drinksAdviceLibrary[drinkKey]) drinksText += `<p class="mb-3"><strong>${drinksAdviceLibrary[drinkKey].title}:</strong> ${drinksAdviceLibrary[drinkKey].text}</p>`;
            });
        } else {
            selectedDrinks.forEach(drinkKey => {
                if (drinksAdviceLibrary[drinkKey]) drinksText += `<p class="mb-3"><strong>${drinksAdviceLibrary[drinkKey].title}:</strong> ${drinksAdviceLibrary[drinkKey].text}</p>`;
            });
        }
        const drinksAccordion = { emoji: 'ü•õü•§', title: 'Lo que Bebes Importa', text: drinksText };
        adviceHtml += createAccordionHtml(drinksAccordion);
    }

    return adviceHtml;
}


function renderDashboard() {
    console.log("Rendering dashboard...");
    const dashboardContainer = document.getElementById('dashboard');
    if (!dashboardContainer) {
        console.error("Dashboard container not found.");
        return;
    }

    const { measurements, health_conditions = [], glucose_level, blood_pressure, main_goal, weight_history, lipids } = appState.answers;
    const imc = calculateIMC(measurements.height, measurements.weight);
    const imcCategory = getIMCCategory(imc);
    const waterIntake = calculateWaterIntake(measurements.weight, measurements.height, measurements.age, appState.answers.gender, appState.answers.activity_level);
    const healthyWeight = calculateHealthyWeightRange(measurements.height);
    const diferenciaPeso = measurements.weight - healthyWeight.ideal;

    let weightGoalCardHtml = '';
    if (diferenciaPeso > 0) {
        weightGoalCardHtml = `<div class="dashboard-card flex flex-col justify-center items-center text-center border-amber-400/50"><p class="text-4xl font-bold text-amber-400">${diferenciaPeso.toFixed(1)}</p><p class="text-sm text-amber-400/80 mt-1">Kg a Perder</p></div>`;
    } else if (diferenciaPeso < 0) {
        weightGoalCardHtml = `<div class="dashboard-card flex flex-col justify-center items-center text-center border-green-400/50"><p class="text-4xl font-bold text-green-400">${Math.abs(diferenciaPeso).toFixed(1)}</p><p class="text-sm text-green-400/80 mt-1">Kg a Ganar</p></div>`;
    }

    let weightProjectionText = '';
    if (diferenciaPeso > 0) {
        const monthsToLose = ((diferenciaPeso * 1000) / 143 / 30).toFixed(1);
        weightProjectionText = `Basado en una p√©rdida de grasa saludable y sostenible, podr√≠as alcanzar tu peso ideal en aproximadamente <strong>${monthsToLose} meses</strong>.`;
    } else if (diferenciaPeso < 0) {
        weightProjectionText = `Tu peso est√° por debajo del rango saludable. Este plan te ayudar√° a ganar masa muscular y peso de forma saludable.`;
    } else {
        weightProjectionText = `¬°Felicidades! Est√°s en tu peso ideal. El plan se enfocar√° en optimizar tu energ√≠a y salud.`;
    }

    const goalTitles = {
        loss: 'Tu Hoja de Ruta para Perder Peso y Equilibrar tu Metabolismo',
        energy: 'Tu Hoja de Ruta para Mejorar tu Energ√≠a y Enfoque',
        health: 'Tu Hoja de Ruta para Mejorar una Condici√≥n de Salud',
        muscle: 'Tu Hoja de Ruta para Tonificar tu Cuerpo y Aumentar Masa Muscular'
    };
    const mainTitle = goalTitles[main_goal] || 'Tu Hoja de Ruta Personalizada';
    const mainGoalAccordionHtml = generateMainGoalAccordion(main_goal);

    let introParagraph = '';
    if (weight_history === 'ideal_weight') {
        introParagraph = `<p class="text-center text-gray-300 mb-4 text-md">¬°Felicitaciones por estar en tu peso ideal! Este plan optimizar√° tu bienestar.</p>`;
    } else if (weight_history === 'less_than_year') {
        introParagraph = `<p class="text-center text-gray-300 mb-4 text-md">Est√°s en el momento perfecto para actuar. Tu cuerpo responder√° r√°pidamente.</p>`;
    } else if (weight_history === 'more_than_year' || weight_history === 'cant_remember') {
        introParagraph = `<p class="text-center text-gray-300 mb-4 text-md">Entendemos que llevas tiempo luchando. Este plan es un 'reseteo' profundo. ¬°Vamos a hacerlo bien!</p>`;
    }

    const personalizedAdviceHtml = generatePersonalizedAdvice(appState.answers);
    
    const topMetricsHtml = `
        <div class="dashboard-card flex flex-col justify-center items-center text-center"><p class="text-4xl font-bold text-cyan-400">${measurements.age}</p><p class="text-sm text-gray-400 mt-1">A√±os</p></div>
        <div class="dashboard-card flex flex-col justify-center items-center text-center"><p class="text-4xl font-bold text-cyan-400">${measurements.height}</p><p class="text-sm text-gray-400 mt-1">Altura (cm)</p></div>
        <div class="dashboard-card flex flex-col justify-center items-center text-center"><p class="text-4xl font-bold text-cyan-400">${measurements.weight}</p><p class="text-sm text-gray-400 mt-1">Peso Actual kg</p></div>
        ${weightGoalCardHtml}
    `;
    
    const healthyWeightCardHtml = `
        <div class="dashboard-card p-4">
            <h3 class="font-bold text-xl mb-2 text-green-400">Tu Rango de Peso Saludable</h3>
            <p class="text-sm text-gray-300">Basado en tu estatura, un peso saludable para ti se encuentra entre <strong class="text-white">${healthyWeight.min} kg</strong> y <strong class="text-white">${healthyWeight.max} kg</strong>.</p>
            <p class="text-sm text-gray-400 mt-2">Un punto ideal de referencia, con un IMC de 21.75, es alrededor de <strong class="text-green-300">${healthyWeight.ideal} kg</strong>. ¬°Esa es una excelente meta a largo plazo!</p>
        </div>
    `;

    let healthFocusHtml = '';
    if (health_conditions.length > 0 && !health_conditions.includes('none')) {
        healthFocusHtml = `<div class="dashboard-card p-4">
            <h3 class="font-bold text-xl mb-4 text-pink-400">Tu Plan de Enfoque de Salud</h3>`;
        health_conditions.forEach(condition => {
            const explanation = pathologyExplanations[condition];
            if (explanation) {
                let medicalAdvice = '';
                let warningClass = '';
                if (condition === 'insulin_resistance' && glucose_level >= 100) {
                    warningClass = 'medical-warning';
                    medicalAdvice = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu nivel de glucosa (${glucose_level} mg/dL) sugiere una atenci√≥n especial. Aunque este plan es una excelente herramienta, es fundamental que converses sobre este valor con tu m√©dico.</p>`;
                }
                if (condition === 'hypertension' && blood_pressure) {
                    const [systolic, diastolic] = blood_pressure.split('/').map(Number);
                    if (systolic >= 140 || diastolic >= 90) {
                        warningClass = 'medical-warning';
                        medicalAdvice = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu presi√≥n arterial (${blood_pressure}) se encuentra elevada. Si bien este plan te ayudar√° a mejorar, es crucial que un m√©dico eval√∫e estos n√∫meros contigo.</p>`;
                    }
                }

                healthFocusHtml += `<div class="mb-3 pb-3 border-b border-gray-700/50 last:border-b-0 ${warningClass}">
                    <h4 class="font-semibold text-blue-400 text-md">${explanation.title}</h4>
                    <p class="text-xs text-gray-400 mt-1"><strong class="text-gray-300">La Ra√≠z Metab√©tica:</strong> ${explanation.cause}</p>
                    <p class="text-xs text-gray-400"><strong class="text-gray-300">Tu Plan de Acci√≥n Keto:</strong> ${explanation.action}</p>
                    ${medicalAdvice}
                </div>`;
            }
        });
        healthFocusHtml += `</div>`;
    }

    let lipidProfileHtml = '';
    if (lipids && (lipids.triglycerides || lipids.hdl || lipids.ldl)) {
        const tg = parseFloat(lipids.triglycerides);
        const hdlVal = parseFloat(lipids.hdl);
        const ldlVal = parseFloat(lipids.ldl);
        const ratio = (tg && hdlVal) ? (tg / hdlVal).toFixed(2) : 'N/A';
        const gender = appState.answers.gender;

        let interpretationText = '';
        let interpretationClass = '';
        let medicalAdviceLipids = '';
        if (ratio !== 'N/A') {
             if (gender === 'male') {
                 if (ratio <= 3.5) {
                     interpretationClass = 'interpretation-good';
                     interpretationText = `<strong>Interpretaci√≥n (Hombre):</strong> ¬°Excelente! Tu ratio TG/HDL de <strong>${ratio}</strong> est√° en el rango deseable (menor a 3.5).`;
                 } else if (ratio > 5.0) {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretaci√≥n (Hombre):</strong> Atenci√≥n. Tu ratio TG/HDL de <strong>${ratio}</strong> es elevado (mayor a 5.0).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) es elevado. Es fundamental que converses sobre este valor con tu m√©dico.</p>`;
                 } else {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretaci√≥n (Hombre):</strong> Tu ratio TG/HDL de <strong>${ratio}</strong> est√° en un rango moderado (entre 3.5 y 5.0).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) est√° en un rango moderado. Considera discutir este valor con tu m√©dico.</p>`;
                 }
             } else { // female
                 if (ratio <= 2.5) {
                     interpretationClass = 'interpretation-good';
                     interpretationText = `<strong>Interpretaci√≥n (Mujer):</strong> ¬°Excelente! Tu ratio TG/HDL de <strong>${ratio}</strong> est√° en el rango ideal (menor a 2.5).`;
                 } else if (ratio > 3.5) {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretaci√≥n (Mujer):</strong> Atenci√≥n. Tu ratio TG/HDL de <strong>${ratio}</strong> es elevado (mayor a 3.5).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) es elevado. Es fundamental que converses sobre este valor con tu m√©dico.</p>`;
                 } else {
                     interpretationClass = 'interpretation-warning';
                     interpretationText = `<strong>Interpretaci√≥n (Mujer):</strong> Tu ratio TG/HDL de <strong>${ratio}</strong> est√° en un rango moderado (entre 2.5 y 3.5).`;
                     medicalAdviceLipids = `<p class="mt-2 p-2 text-sm bg-amber-500/10 text-amber-300 rounded-lg border border-amber-500/20"><b>Consejo Importante:</b> Tu ratio TG/HDL (${ratio}) est√° en un rango moderado. Considera discutir este valor con tu m√©dico.</p>`;
                 }
             }
        }
        lipidProfileHtml = `
        <div class="dashboard-card p-4 lipid-analysis-card">
            <h3 class="font-bold text-xl mb-4 text-pink-300">üî¨ An√°lisis de tu Perfil Lip√≠dico</h3>
            <div class="mb-4">
                <p class="text-sm">Para entender tus resultados, primero conozcamos a tu <strong>flota de submarinos</strong>, las lipoprote√≠nas que transportan grasas y colesterol por tu cuerpo:</p>
                <ul class="list-disc list-inside space-y-1 mt-2 text-xs">
                    <li><strong>Quilomicrones:</strong> Submarinos gigantes que transportan la grasa de tu √∫ltima comida desde los intestinos.</li>
                    <li><strong>VLDL:</strong> Submarinos grandes lanzados desde el h√≠gado, cargados con triglic√©ridos (energ√≠a) para tus c√©lulas.</li>
                    <li><strong>IDL:</strong> El VLDL despu√©s de entregar parte de su carga, un paso intermedio.</li>
                    <li><strong>LDL:</strong> Submarinos cuya misi√≥n vital es entregar colesterol para reparar y construir cada c√©lula de tu cuerpo.</li>
                    <li><strong>HDL:</strong> Tu flota de 'salvamento y reparaci√≥n'. Patrullan tus arterias, recogen el colesterol no utilizado y, crucialmente, <strong>limpian las paredes arteriales de colesterol oxidado (ateromas)</strong>, devolvi√©ndolo al h√≠gado.</li>
                </ul>
            </div>
            <div class="p-3 bg-gray-800/50 rounded-lg mb-3">
                <h4 class="font-semibold text-lg text-cyan-300">Tus Valores Actuales:</h4>
                <p>Triglic√©ridos: <strong>${tg || 'N/A'} mg/dL</strong></p>
                <p>Colesterol HDL: <strong>${hdlVal || 'N/A'} mg/dL</strong></p>
                <p>Colesterol LDL: <strong>${ldlVal || 'N/A'} mg/dL</strong></p>
                <p class="mt-2 text-xl">Ratio TG/HDL: <strong class="text-amber-400">${ratio}</strong></p>
            </div>
            <div class="interpretation-box ${interpretationClass}">
                ${interpretationText}
            </div>
            ${medicalAdviceLipids}
            <p class="mt-4 text-xs italic">El objetivo es: <strong>Triglic√©ridos bajos</strong> (el cuerpo quema grasa), <strong>HDL alto</strong> (buen sistema de limpieza) y un <strong>LDL "contextualizado"</strong>, donde la calidad de la part√≠cula (inferida por el ratio) es m√°s importante que su cantidad total. Recuerda que estos rangos pueden variar com la edad, consulta siempre a tu m√©dico.</p>
        </div>`;
    }
    
    const otherCardsHtml = `
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/mrnDR0CS/PROYECCION-DE-PESO.png" alt="Gr√°fico de Proyecci√≥n de Peso" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="projection">?</span>
                <h3 class="font-bold text-white mb-2">Proyecci√≥n de Peso</h3>
                <p class="text-sm text-gray-300 leading-relaxed">${weightProjectionText}</p>
            </div>
        </div>
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/20mMD59q/Tu-IMC-actual.png" alt="Gr√°fico de IMC" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="imc">?</span>
                <h3 class="font-bold text-white mb-2">Tu IMC actual</h3>
                <p class="text-5xl font-extrabold text-cyan-400">${imc.toFixed(1)}</p>
                <p class="text-md font-semibold text-gray-300">${imcCategory.name}</p>
                <p class="text-xs text-gray-400 mt-1 px-2">${imcCategory.definition}</p>
            </div>
        </div>
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/GvFVvJPM/Copia-de-Copia-de-Logo-500-x-500-px-1.png" alt="Gr√°fico de Consumo de agua" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="water">?</span>
                <h3 class="font-bold text-white">Consumo de agua</h3>
                <p class="text-5xl font-bold text-cyan-400 my-2">${waterIntake !== null ? waterIntake.toFixed(1) : 'N/A'} L</p>
                <p class="text-xs text-gray-400">El cuerpo pierde 1.5-2.5L de agua al d√≠a (respiraci√≥n, sudor, orina, etc.). Usamos la f√≥rmula de Holliday-Segar para tu recomendaci√≥n.</p>
            </div>
        </div>
        <div class="text-center flex flex-col">
            <img src="https://i.ibb.co/S4hTHgbj/Copia-de-Copia-de-Logo-500-x-500-px-3.png" alt="Gr√°fico de Recetas Keto" class="w-32 h-32 object-contain mx-auto relative z-10 image-gradient-border" onerror="this.onerror=null;this.src='https://placehold.co/128x128/1e1b2e/ffffff?text=Imagen';">
            <div class="dashboard-card -mt-16 pt-20 flex-grow">
                         <span class="help-icon" data-tooltip-key="recipes">?</span>
                <h3 class="font-bold text-white mb-2">Tus Recetas Keto</h3>
                <p class="text-sm text-gray-300 leading-relaxed">Deliciosos platos, inspirados en los alimentos que m√°s te gustan y tus h√°bitos.</p>
            </div>
        </div>
    `;

    dashboardContainer.innerHTML = `
        <h1 class="text-3xl font-extrabold text-white text-center mb-6">${mainTitle}</h1>
        ${mainGoalAccordionHtml}
        ${introParagraph}
        <h2 class="text-2xl font-bold text-white text-center mb-2 mt-8">Tus M√©tricas Clave</h2>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-6">${topMetricsHtml}</div>
        <div class="grid grid-cols-1 gap-4 mb-6">${healthyWeightCardHtml}</div>
        ${healthFocusHtml ? `<div class="grid grid-cols-1 gap-4 mb-6">${healthFocusHtml}</div>` : ''}
        ${lipidProfileHtml ? `<div class="grid grid-cols-1 gap-4 mb-6">${lipidProfileHtml}</div>` : ''}
        <h2 class="text-2xl font-bold text-white text-center mb-4 mt-8">Tus Consejos Personalizados</h2>
        <div id="personalized-advice-container" class="space-y-4 mb-6">${personalizedAdviceHtml}</div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8">${otherCardsHtml}</div>
        <div id="unlock-button-container" class="text-center mt-8"><button id="unlock-app-btn" class="btn-glow text-white font-bold py-3 px-12 rounded-full text-xl">VER MIS HERRAMIENTAS</button></div>
    `;
    
    addTrackedListener(document.getElementById('unlock-app-btn'), 'click', unlockAppContent);
    console.log("Dashboard rendered.");
}

function unlockAppContent() {
    console.log("Unlocking app content (populating tools)...");
    populateToolsContent(); // Populate tools before showing them
    
    const herramientas = document.getElementById('herramientas');
    if(herramientas) herramientas.classList.remove('hidden');

    document.querySelectorAll('.locked-content').forEach(el => {
        el.classList.remove('hidden');
    });

    const unlockBtnContainer = document.getElementById('unlock-button-container');
    if(unlockBtnContainer) unlockBtnContainer.style.display = 'none';

    if(herramientas) herramientas.scrollIntoView({ behavior: 'smooth' });
    console.log("Tools section made visible.");
}

function populateToolsContent() {
    console.log("Populating tools content with HTML...");
    const herramientasContainer = document.getElementById('herramientas');
    if (!herramientasContainer) {
        console.error("Herramientas container not found.");
        return;
    }

    const userMeasurements = appState.answers.measurements || {};
    const userGender = appState.answers.gender || '';
    const userActivityLevel = appState.answers.activity_level || '';

    const healthTrackersHtml = `
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-pink-300 mb-4">Registrar Nuevas Mediciones</h2>
            <div class="space-y-4">
                <div><label for="new-glucose" class="block text-sm font-medium text-gray-300 mb-1">Glucosa (mg/dL)</label><input type="number" id="new-glucose" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <div><label for="new-pressure" class="block text-sm font-medium text-gray-300 mb-1">Presi√≥n Arterial (ej: 120/80)</label><input type="text" id="new-pressure" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <button id="register-measurement-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Registrar Medici√≥n</button>
            </div>
        </div>
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">Evoluci√≥n de tu Salud Metab√≥lica</h2>
            <div class="relative h-64"><canvas id="health-chart"></canvas></div>
            <button id="reset-health-chart-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg mt-4">Reiniciar Gr√°fico</button>
        </div>
    `;
    
    const lipidTrackersHtml = `
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-pink-300 mb-4">Registrar Perfil Lip√≠dico</h2>
            <div class="space-y-4">
                <div><label for="new-triglycerides" class="block text-sm font-medium text-gray-300 mb-1">Triglic√©ridos (mg/dL)</label><input type="number" id="new-triglycerides" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <div><label for="new-hdl" class="block text-sm font-medium text-gray-300 mb-1">Colesterol HDL (mg/dL)</label><input type="number" id="new-hdl" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <div><label for="new-ldl" class="block text-sm font-medium text-gray-300 mb-1">Colesterol LDL (mg/dL)</label><input type="number" id="new-ldl" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-pink-500 transition"></div>
                <button id="register-lipids-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Registrar L√≠pidos</button>
            </div>
        </div>
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-purple-300 mb-4">Evoluci√≥n de tu Perfil Lip√≠dico</h2>
            <div class="relative h-64"><canvas id="lipid-chart"></canvas></div>
            <button id="reset-lipid-chart-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg mt-4">Reiniciar Gr√°fico</button>
        </div>
    `;

    const weightTrackersHtml = `
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-green-300 mb-4">Registrar Peso</h2>
            <div class="space-y-4">
                <div>
                    <label for="new-weight" class="block text-sm font-medium text-gray-300 mb-1">Peso Actual (kg)</label>
                    <input type="number" id="new-weight" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                </div>
                <button id="register-weight-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Registrar Peso</button>
            </div>
        </div>
        <div class="guide-card p-6">
            <h2 class="text-2xl font-bold text-green-300 mb-4">Evoluci√≥n del Peso</h2>
            <div class="relative h-64"><canvas id="weight-chart"></canvas></div>
            <button id="reset-weight-chart-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg mt-4">Reiniciar Gr√°fico</button>
        </div>
    `;

    herramientasContainer.innerHTML = `
        <h1 class="text-4xl font-extrabold mb-8 text-white">Herramientas Keto</h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="guide-card p-6">
                <h2 class="text-2xl font-bold text-cyan-300 mb-4">Calculadora de IMC</h2>
                <div class="space-y-4">
                    <div><label for="tool-altura" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="tool-altura" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" value="${userMeasurements.height || ''}"></div>
                    <div><label for="tool-peso" class="block text-sm font-medium text-gray-300 mb-1">Peso (kg)</label><input type="number" id="tool-peso" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition" value="${userMeasurements.weight || ''}"></div>
                    <button id="calc-imc-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Calcular</button>
                </div>
                <div id="tool-imc-result-container" class="mt-6"></div>
            </div>
            <div class="guide-card p-6">
                <h2 class="text-2xl font-bold text-green-300 mb-4">Calculadora de Hidrataci√≥n</h2>
                <div class="space-y-4">
                    <div><label for="peso-agua" class="block text-sm font-medium text-gray-300 mb-1">Tu Peso (kg)</label><input type="number" id="peso-agua" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" value="${userMeasurements.weight || ''}"></div>
                    <div><label for="hydration-age" class="block text-sm font-medium text-gray-300 mb-1">Edad</label><input type="number" id="hydration-age" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" value="${userMeasurements.age || ''}"></div>
                    <div><label for="hydration-height" class="block text-sm font-medium text-gray-300 mb-1">Altura (cm)</label><input type="number" id="hydration-height" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition" value="${userMeasurements.height || ''}"></div>
                    <div><label for="hydration-gender" class="block text-sm font-medium text-gray-300 mb-1">G√©nero</label>
                        <select id="hydration-gender" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                            <option value="">Selecciona</option>
                            <option value="female" ${userGender === 'female' ? 'selected' : ''}>Femenino</option>
                            <option value="male" ${userGender === 'male' ? 'selected' : ''}>Masculino</option>
                        </select>
                    </div>
                    <div><label for="hydration-activity" class="block text-sm font-medium text-gray-300 mb-1">Nivel de Actividad</label>
                        <select id="hydration-activity" class="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                            <option value="">Selecciona</option>
                            <option value="sedentary" ${userActivityLevel === 'sedentary' ? 'selected' : ''}>Sedentario</option>
                            <option value="light" ${userActivityLevel === 'light' ? 'selected' : ''}>Ligero (caminatas 1-2 d√≠as)</option>
                            <option value="moderate" ${userActivityLevel === 'moderate' ? 'selected' : ''}>Moderado (ejercicio 2-3 d√≠as)</option>
                            <option value="high" ${userActivityLevel === 'high' ? 'selected' : ''}>Intenso (ejercicio 4+ d√≠as)</option>
                        </select>
                    </div>
                    <button id="calc-agua-btn" class="btn-glow text-white font-bold py-2 px-6 rounded-lg">Calcular Agua</button>
                    <div id="resultado-agua" class="mt-4"></div>
                </div>
            </div>
            ${weightTrackersHtml}
            ${healthTrackersHtml}
            ${lipidTrackersHtml}
        </div>
        <div class="text-center mt-12 border-t-2 border-gray-700 pt-8">
             <button id="download-full-report-btn" class="btn-glow text-white font-bold py-4 px-16 rounded-full text-xl">Descargar Reporte Completo en PDF</button>
             <button id="full-guide-btn" class="btn-glow text-white font-bold py-4 px-16 rounded-full text-xl mt-4">Gu√≠a Completa KETO Origins</button>
        </div>
    `;
    setTimeout(() => {
        attachToolsEventListeners(); 
        setupHealthTracking(); 
        console.log("setupHealthTracking and attachToolsEventListeners called after a short delay.");
    }, 100);
}


function addTrackedListener(element, type, handler) {
    if (!element) {
        console.warn(`Attempted to add listener to non-existent element for type: ${type}`);
        return;
    }
    element.addEventListener(type, handler);
    eventListeners.push({ element, type, handler });
}

function attachToolsEventListeners() {
    console.log("Attaching tools specific event listeners...");

    addTrackedListener(document.getElementById('calc-imc-btn'), 'click', () => {
        const height = document.getElementById('tool-altura').value;
        const weight = document.getElementById('tool-peso').value;
        const container = document.getElementById('tool-imc-result-container');
        if (!height || !weight) {
            showToast('Por favor, ingresa altura y peso.', 'error');
            return;
        }
        renderImcDetails(container, height, weight);
    });

    addTrackedListener(document.getElementById('calc-agua-btn'), 'click', () => {
        const weight = parseFloat(document.getElementById('peso-agua').value);
        const age = parseFloat(document.getElementById('hydration-age').value);
        const height = parseFloat(document.getElementById('hydration-height').value);
        const gender = document.getElementById('hydration-gender').value;
        const activity = document.getElementById('hydration-activity').value;
        const resultEl = document.getElementById('resultado-agua');
        
        if (!weight || !age || !height || !gender || !activity) {
            showToast('Por favor, completa todos los campos.', 'error');
            return;
        }
        
        const waterLiters = calculateWaterIntake(weight, height, age, gender, activity);
        if (waterLiters !== null) {
            resultEl.innerHTML = `<p class="text-5xl font-bold text-cyan-400">${waterLiters.toFixed(1)} L</p><p class="text-md font-semibold text-gray-300 mt-1">Tu consumo diario recomendado</p>`;
        } else {
            showToast('Datos inv√°lidos para calcular la hidrataci√≥n.', 'error');
        }
    });

    addTrackedListener(document.getElementById('register-measurement-btn'), 'click', registerNewMeasurement);
    addTrackedListener(document.getElementById('register-lipids-btn'), 'click', registerNewLipidMeasurement);
    addTrackedListener(document.getElementById('register-weight-btn'), 'click', registerNewWeight);
    addTrackedListener(document.getElementById('reset-weight-chart-btn'), 'click', resetWeightChartData);
    addTrackedListener(document.getElementById('reset-health-chart-btn'), 'click', resetHealthChartData);
    addTrackedListener(document.getElementById('reset-lipid-chart-btn'), 'click', resetLipidChartData);
    
    addTrackedListener(document.getElementById('download-full-report-btn'), 'click', downloadFullReportPDF);
    
    addTrackedListener(document.getElementById('full-guide-btn'), 'click', () => {
        window.open('https://guia-completa-herramientas.netlify.app/', '_blank');
    });

    console.log("Tools specific event listeners attached.");
}


function setupEventListeners() {
    console.log("Setting up global event listeners...");
    const accordionHandler = function(event) {
        const button = event.target.closest('.accordion-button');
        if (button) {
            const content = button.nextElementSibling;
            if (content && content.classList.contains('accordion-content')) {
                button.classList.toggle('open');
                content.classList.toggle('open');
            }
        }
    };
    if (!document.body.__accordionListenerAdded) {
        addTrackedListener(document.body, 'click', accordionHandler);
        document.body.__accordionListenerAdded = true;
    }

    const sidebarToggle = document.getElementById('sidebar-toggle');
    const sidebar = document.getElementById('sidebar');
    
    const sidebarToggleHandler = (e) => {
        e.stopPropagation();
        sidebar.classList.toggle('-translate-x-full');
    };
    addTrackedListener(sidebarToggle, 'click', sidebarToggleHandler);

    const documentClickHandler = (e) => {
        if (sidebar && !sidebar.contains(e.target) && !sidebarToggle.contains(e.target)) {
            sidebar.classList.add('-translate-x-full');
        }
    };
    addTrackedListener(document, 'click', documentClickHandler);

    document.querySelectorAll('.nav-link').forEach(link => {
        addTrackedListener(link, 'click', handleNavClick);
    });

    const mainContent = document.getElementById('main-content');
    addTrackedListener(mainContent, 'scroll', setActiveNavLink);

    addTrackedListener(document.body, 'click', function(event) {
        const icon = event.target.closest('.help-icon');
        if (icon) {
            const key = icon.dataset.tooltipKey;
            showInfoModal(key);
        }
    });
    addTrackedListener(document.getElementById('info-modal-close'), 'click', hideInfoModal);
    addTrackedListener(document.getElementById('info-modal'), 'click', function(event) {
        if (event.target === this) {
            hideInfoModal();
        }
    });

    addTrackedListener(document.getElementById('reset-app-btn'), 'click', resetAppAndData);

    console.log("Global event listeners set up.");
}

function resetAppAndData() {
    const confirmation = confirm("¬øEst√°s seguro de que quieres borrar todos tus datos y empezar de nuevo? Esta acci√≥n no se puede deshacer.");
    if (confirmation) {
        try {
            localStorage.removeItem('ketoOriginsData');
            localStorage.removeItem('ketoOriginsSession'); // Clear session too
            console.log("localStorage data cleared.");
            showToast('Datos borrados. La aplicaci√≥n se reiniciar√°.', 'success');
            setTimeout(() => window.location.reload(), 2000);
        } catch (e) {
            console.error("Error clearing localStorage:", e);
            showToast('No se pudieron borrar los datos.', 'error');
        }
    } else {
        showToast('Acci√≥n cancelada.', 'info');
    }
}


function showInfoModal(key) {
    const modal = document.getElementById('info-modal');
    const titleEl = document.getElementById('info-modal-title');
    const textEl = document.getElementById('info-modal-text');
    const definition = tooltipDefinitions[key];

    if (definition && modal && titleEl && textEl) {
        titleEl.textContent = definition.title;
        textEl.textContent = definition.text;
        modal.classList.add('flex');
        modal.classList.remove('hidden');
        setTimeout(() => modal.style.opacity = '1', 10);
    }
}

function hideInfoModal() {
    const modal = document.getElementById('info-modal');
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.remove('flex');
            modal.classList.add('hidden');
        }, 300);
    }
}


function handleNavClick(event) {
    event.preventDefault();
    const targetId = event.currentTarget.getAttribute('href');
    const targetElement = document.querySelector(targetId);
    if (targetElement) {
        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
        if (window.innerWidth < 768) {
            document.getElementById('sidebar')?.classList.add('-translate-x-full');
        }
    }
}

function setActiveNavLink() {
    const mainContent = document.getElementById('main-content');
    if (!mainContent) return;
    let currentSectionId = 'dashboard';
    
    const sections = document.querySelectorAll('#main-content > section[id]');
    
    for (const section of sections) {
        if (section.id && section.offsetTop <= mainContent.scrollTop + 150) {
            currentSectionId = section.id;
        }
    }
    
    document.querySelectorAll('.nav-link').forEach(link => {
        const linkHref = link.getAttribute('href').substring(1);
        link.classList.toggle('active', linkHref === currentSectionId);
    });
}


// --- Health Tracking Functions ---
function setupHealthTracking() {
    console.log("Setting up health tracking (charts and input listeners)...");
    renderHealthChart();
    renderLipidChart();
    renderWeightChart();
}

function registerNewWeight() {
    const weightInput = document.getElementById('new-weight');
    const parsedWeight = parseFloat(weightInput.value);
    if (!isNaN(parsedWeight) && parsedWeight > 0) {
        appState.userData.historialPeso.push({ fecha: new Date().toISOString().split('T')[0], peso: parsedWeight });
        localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
        weightInput.value = '';
        showToast('Peso registrado con √©xito.', 'success');
        renderWeightChart();
        sendTrackingDataToSheet({ type: 'Peso', value1: parsedWeight });
    } else {
        showToast('Por favor, ingresa un valor de peso v√°lido.', 'error');
    }
}

function registerNewMeasurement() {
    const glucoseInput = document.getElementById('new-glucose');
    const pressureInput = document.getElementById('new-pressure');
    const newGlucose = glucoseInput.value;
    const newPressure = pressureInput.value;
    const today = new Date().toISOString().split('T')[0]; 
    let registered = false;
    let stateChanged = false;

    if (newGlucose && !isNaN(parseFloat(newGlucose)) && parseFloat(newGlucose) > 0) {
        appState.userData.historialGlucosa.push({ fecha: today, valor: parseFloat(newGlucose) });
        glucoseInput.value = '';
        registered = true;
        stateChanged = true;
        sendTrackingDataToSheet({ type: 'Glucosa (mg/dL)', value1: parseFloat(newGlucose) });
    }
    if (newPressure) {
        const [sistolica, diastolica] = newPressure.split('/').map(Number);
        if (sistolica && diastolica && !isNaN(sistolica) && !isNaN(diastolica)) {
            appState.userData.historialPresion.push({ fecha: today, sistolica, diastolica });
            pressureInput.value = '';
            registered = true;
            stateChanged = true;
            sendTrackingDataToSheet({ type: 'Presi√≥n Arterial', value1: `${sistolica}/${diastolica}` });
        } else if (newPressure.trim() !== '') {
            showToast('Formato de presi√≥n incorrecto. Usa "120/80".', 'error');
            return;
        }
    }
    
    if(registered) {
        showToast('Medici√≥n registrada con √©xito.', 'success');
        if (stateChanged) {
            localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
        }
        renderHealthChart();
    } else {
        showToast('Ingresa al menos un valor v√°lido.', 'error');
    }
}

function registerNewLipidMeasurement() {
    const tgInput = document.getElementById('new-triglycerides');
    const hdlInput = document.getElementById('new-hdl');
    const ldlInput = document.getElementById('new-ldl');
    const newTriglycerides = parseFloat(tgInput.value);
    const newHdl = parseFloat(hdlInput.value);
    const newLdl = parseFloat(ldlInput.value);

    if (!isNaN(newTriglycerides) && !isNaN(newHdl) && !isNaN(newLdl) && newTriglycerides > 0 && newHdl > 0 && newLdl > 0) {
        appState.userData.historialLipidico.push({
            fecha: new Date().toISOString().split('T')[0],
            triglycerides: newTriglycerides,
            hdl: newHdl,
            ldl: newLdl
        });
        localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
        tgInput.value = '';
        hdlInput.value = '';
        ldlInput.value = '';
        showToast('Perfil lip√≠dico registrado.', 'success');
        renderLipidChart();
        sendTrackingDataToSheet({ 
            type: 'Perfil Lip√≠dico', 
            value1: `TG: ${newTriglycerides}`,
            value2: `HDL: ${newHdl}`,
            value3: `LDL: ${newLdl}`
        });
    } else {
        showToast('Por favor, completa los tres campos de l√≠pidos.', 'error');
    }
}

function renderWeightChart() {
    const canvas = document.getElementById('weight-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (weightChartInstance) weightChartInstance.destroy();
    const weightData = appState.userData.historialPeso;
    const displayLabels = weightData.map((d, index) => `Entrada ${index + 1}`);
    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
    gradient.addColorStop(0, 'rgba(139, 92, 246, 0.8)');
    gradient.addColorStop(1, 'rgba(34, 211, 238, 0.8)');
    weightChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: displayLabels,
            datasets: [{
                label: 'Peso (kg)',
                data: weightData.map(d => d.peso),
                backgroundColor: gradient,
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 1,
                borderRadius: 5,
            }]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#9CA3AF' } }, y: { beginAtZero: true, ticks: { color: '#9CA3AF' } } },
            plugins: { legend: { display: false } }
        }
    });
}

function renderHealthChart() {
    const canvas = document.getElementById('health-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (healthChartInstance) healthChartInstance.destroy();
    const glucoseData = appState.userData.historialGlucosa;
    const pressureData = appState.userData.historialPresion;
    const maxEntries = Math.max(glucoseData.length, pressureData.length);
    const displayLabels = Array.from({ length: maxEntries }, (_, i) => `Entrada ${i + 1}`);
    const datasets = [];
    if (glucoseData.length > 0) datasets.push({
        label: 'Glucosa (mg/dL)',
        data: displayLabels.map((_, i) => glucoseData[i] ? glucoseData[i].valor : null),
        backgroundColor: 'rgba(244, 114, 182, 0.6)', borderColor: 'rgba(244, 114, 182, 1)', borderWidth: 1, borderRadius: 5
    });
    if (pressureData.length > 0) {
        datasets.push({
            label: 'Presi√≥n Sist√≥lica (mmHg)',
            data: displayLabels.map((_, i) => pressureData[i] ? pressureData[i].sistolica : null),
            backgroundColor: 'rgba(139, 92, 246, 0.6)', borderColor: 'rgba(139, 92, 246, 1)', borderWidth: 1, borderRadius: 5
        });
        datasets.push({
            label: 'Presi√≥n Diast√≥lica (mmHg)',
            data: displayLabels.map((_, i) => pressureData[i] ? pressureData[i].diastolica : null),
            backgroundColor: 'rgba(96, 165, 250, 0.6)', borderColor: 'rgba(96, 165, 250, 1)', borderWidth: 1, borderRadius: 5
        });
    }
    healthChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: displayLabels, datasets: datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#9CA3AF' } }, y: { beginAtZero: true, ticks: { color: '#9CA3AF' } } },
            plugins: { legend: { labels: { color: '#D1D5DB' } } }
        }
    });
}

function renderLipidChart() {
    const canvas = document.getElementById('lipid-chart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    if (lipidChartInstance) lipidChartInstance.destroy();
    const lipidData = appState.userData.historialLipidico;
    const displayLabels = lipidData.map(d => new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'));
    lipidChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: displayLabels,
            datasets: [
                { label: 'Triglic√©ridos', data: lipidData.map(d => d.triglycerides), backgroundColor: 'rgba(251, 191, 36, 0.6)', borderColor: 'rgba(251, 191, 36, 1)', borderWidth: 1, borderRadius: 5 },
                { label: 'HDL', data: lipidData.map(d => d.hdl), backgroundColor: 'rgba(76, 175, 80, 0.6)', borderColor: 'rgba(76, 175, 80, 1)', borderWidth: 1, borderRadius: 5 },
                { label: 'LDL', data: lipidData.map(d => d.ldl), backgroundColor: 'rgba(59, 130, 246, 0.6)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { x: { ticks: { color: '#9CA3AF' } }, y: { beginAtZero: true, ticks: { color: '#9CA3AF' } } },
            plugins: { legend: { labels: { color: '#D1D5DB' } } }
        }
    });
}

// --- Reset Chart Data Functions ---
function resetWeightChartData() {
    appState.userData.historialPeso = [];
    localStorage.setItem('ketoOriginsData', JSON.stringify(appState)); // Update localStorage
    showToast('Gr√°fico de Peso Reiniciado.', 'success');
    renderWeightChart();
}

function resetHealthChartData() {
    appState.userData.historialGlucosa = [];
    appState.userData.historialPresion = [];
    localStorage.setItem('ketoOriginsData', JSON.stringify(appState)); // Update localStorage
    showToast('Gr√°fico de Salud Metab√≥lica Reiniciado.', 'success');
    renderHealthChart();
}

function resetLipidChartData() {
    appState.userData.historialLipidico = [];
    localStorage.setItem('ketoOriginsData', JSON.stringify(appState)); // Update localStorage
    showToast('Gr√°fico de Perfil Lip√≠dico Reiniciado.', 'success');
    renderLipidChart();
}

// --- PDF Generation ---
async function downloadFullReportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let yPos = 15; // Initial Y position for content

    doc.setFontSize(22);
    doc.text("Reporte de Progreso - Keto Origins", 105, yPos, { align: 'center' });
    yPos += 15;

    // Helper to add chart and table to PDF
    const addSection = (chartInstance, title, data, head, bodyMapper) => {
        if (yPos > 240) { // Check if new page is needed before adding content
            doc.addPage();
            yPos = 15;
        }
        doc.setFontSize(16);
        doc.text(title, 14, yPos);
        yPos += 10;

        if (chartInstance && data.length > 0) {
            const imgData = chartInstance.toBase64Image();
            doc.addImage(imgData, 'PNG', 14, yPos, 180, 90);
            yPos += 100;

            doc.autoTable({
                startY: yPos,
                head: [head],
                body: data.map(bodyMapper),
                theme: 'grid',
                headStyles: { fillColor: [30, 27, 46] }
            });
            yPos = doc.autoTable.previous.finalY + 15;
        } else {
            doc.setFontSize(12);
            doc.text("No hay datos registrados para este gr√°fico.", 14, yPos);
            yPos += 10;
        }
    };

    // 1. Weight Section
    addSection(
        weightChartInstance,
        "Evoluci√≥n del Peso",
        appState.userData.historialPeso,
        ['Entrada', 'Fecha', 'Peso (kg)'],
        (d, i) => [`Entrada ${i + 1}`, new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), d.peso]
    );

    // 2. Health Section
    if (yPos > 240) { doc.addPage(); yPos = 15; }
    doc.setFontSize(16);
    doc.text("Evoluci√≥n de Salud Metab√≥lica", 14, yPos);
    yPos += 10;
    if (healthChartInstance && (appState.userData.historialGlucosa.length > 0 || appState.userData.historialPresion.length > 0)) {
        const imgData = healthChartInstance.toBase64Image();
        doc.addImage(imgData, 'PNG', 14, yPos, 180, 90);
        yPos += 100;

        if (appState.userData.historialGlucosa.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Entrada', 'Fecha', 'Glucosa (mg/dL)']],
                body: appState.userData.historialGlucosa.map((d, i) => [`Entrada ${i + 1}`, new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), d.valor]),
                theme: 'grid', headStyles: { fillColor: [30, 27, 46] }
            });
            yPos = doc.autoTable.previous.finalY + 10;
        }
        if (appState.userData.historialPresion.length > 0) {
            doc.autoTable({
                startY: yPos,
                head: [['Entrada', 'Fecha', 'Presi√≥n Arterial']],
                body: appState.userData.historialPresion.map((d, i) => [`Entrada ${i + 1}`, new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), `${d.sistolica}/${d.diastolica}`]),
                theme: 'grid', headStyles: { fillColor: [30, 27, 46] }
            });
            yPos = doc.autoTable.previous.finalY + 15;
        }
    } else {
        doc.setFontSize(12);
        doc.text("No hay datos de glucosa o presi√≥n registrados.", 14, yPos);
        yPos += 10;
    }

    // 3. Lipid Section
    addSection(
        lipidChartInstance,
        "Evoluci√≥n del Perfil Lip√≠dico",
        appState.userData.historialLipidico,
        ['Fecha', 'Triglic√©ridos', 'HDL', 'LDL'],
        (d) => [new Date(d.fecha + 'T00:00:00').toLocaleDateString('es-ES'), d.triglycerides, d.hdl, d.ldl]
    );

    doc.save('reporte_completo_keto_origins.pdf');
    showToast('Reporte PDF generado.', 'success');
}


// --- Toast Notification System ---
function showToast(message, type = 'success', duration = 3000) {
    const container = document.getElementById('toast-container');
    if (!container) return;
    const toast = document.createElement('div');
    const bgColor = type === 'error' ? 'bg-red-600' : 'bg-green-600';
    
    toast.className = `toast-notification ${bgColor} text-white font-bold py-3 px-6 rounded-full opacity-0 transform translate-y-4`;
    toast.textContent = message;
    
    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.remove('opacity-0', 'translate-y-4');
        toast.classList.add('opacity-100', 'translate-y-0');
    }, 10);

    setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', 'translate-y-4');
        setTimeout(() => toast.remove(), 500);
    }, duration);
}


// --- Functions to send data to Google Sheet ---

function translateValue(key, value) {
    if (!value) return '';
    if (Array.isArray(value)) {
        return value.map(v => translateValue(key, v)).join(', ');
    }

    const step = baseWizardSteps.find(s => s.key === key);
    if (step && step.options) {
        const option = step.options.find(o => o.value === value);
        return option ? option.text : value;
    }
    return value;
}

/**
 * NEW: Generic function to communicate with the Google Apps Script.
 * It handles errors and expects a JSON response.
 */
async function sendApiRequest(payload) {
    try {
        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            redirect: 'follow',
            headers: {
                'Content-Type': 'text/plain;charset=utf-8' // Workaround for Apps Script CORS
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('API response not OK:', response.status, errorText);
            throw new Error(`Error del servidor (${response.status}).`);
        }

        const text = await response.text();
        try {
            return JSON.parse(text);
        } catch (e) {
            console.error("Failed to parse API response as JSON. Raw response:", text);
            throw new Error("Respuesta del servidor no v√°lida.");
        }
    } catch (error) {
        console.error(`Error in sendApiRequest for action ${payload.action}:`, error);
        return { status: 'error', message: error.message || 'Error de red.' };
    }
}

/**
 * Gathers user data from the appState and sends it to a Google Apps Script endpoint.
 */
function sendDataToGoogleSheet() {
    const { measurements, accessCode, ...otherAnswers } = appState.answers;
    const flatAnswers = { ...otherAnswers, ...measurements };
    
    const translatedData = Object.keys(flatAnswers).reduce((acc, key) => {
        const headerMap = {
            gender: 'Genero', main_goal: 'ObjetivoPrincipal', weight_history: 'HistoriaPeso', habits: 'Habitos',
            emotional_eating: 'HambreEmocional', junk_food_freq: 'FrecuenciaComidaChatarra', eat_out_freq: 'FrecuenciaComerFuera',
            cooking_skill: 'NivelCocina', daily_drinks: 'BebidasDiarias', water_intake: 'ConsumoAgua', alcohol_intake: 'ConsumoAlcohol',
            activity_level: 'NivelActividad', health_conditions: 'CondicionesSalud', stress_level: 'NivelEstres',
            age: 'Edad', height: 'Altura', weight: 'Peso', glucose_level: 'NivelGlucosa', blood_pressure: 'PresionArterial', lipids: 'Lipidos'
        };
        const header = headerMap[key];
        if (header && flatAnswers[key] !== undefined) {
             let value = flatAnswers[key];
            if (key === 'lipids' && value) {
                value = `TG: ${value.triglycerides || 'N/A'}, HDL: ${value.hdl || 'N/A'}, LDL: ${value.ldl || 'N/A'}`;
            }
            acc[header] = translateValue(key, value);
        }
        return acc;
    }, {});

    const payload = { 
        action: 'saveInitialData',
        userId: appState.userId,
        data: { UserID: appState.userId, ...translatedData },
        appStateJSON: JSON.stringify(appState) // Include the full state
    };

    sendApiRequest(payload).then(res => {
        console.log("Response from saveInitialData:", res);
        if (res.status !== 'success' && res.result !== 'success') { // Check both possible success keys
            showToast('Error al guardar datos iniciales.', 'error');
        }
    });
}


// --- NEW FUNCTION to send TRACKING data ---
function sendTrackingDataToSheet(data) {
    const payload = {
        action: 'saveTrackingData',
        userId: appState.userId,
        data: { UserID: appState.userId, ...data },
        appStateJSON: JSON.stringify(appState) // Include the updated state
    };

    sendApiRequest(payload).then(res => {
        console.log("Response from saveTrackingData:", res);
         if (res.status !== 'success' && res.result !== 'success') {
            showToast('Error al guardar seguimiento.', 'error');
        }
    });
}

// --- NEW Access Control Functions ---
async function handleCodeValidation() {
    const codeInput = document.getElementById('access-code-input');
    const code = codeInput.value.trim().toUpperCase();
    const errorEl = document.getElementById('code-error-message');
    const spinner = document.getElementById('loading-spinner');
    const submitBtn = document.getElementById('submit-code-btn');

    if (!code) {
        errorEl.textContent = 'Por favor, ingresa un c√≥digo.';
        return;
    }
    
    errorEl.textContent = '';
    spinner.classList.remove('hidden');
    submitBtn.disabled = true;

    const payload = { action: 'validateCode', code: code };
    const result = await sendApiRequest(payload);

    spinner.classList.add('hidden');
    submitBtn.disabled = false;
        
    if (result.status === 'success') {
        if (result.data) { // Returning user with existing data
            console.log("Returning user validated. Loading data...");
            try {
                // Data from Apps Script is expected to be a stringified JSON
                appState = JSON.parse(result.data);
                // Save the valid session info
                localStorage.setItem('ketoOriginsData', JSON.stringify(appState));
                localStorage.setItem('ketoOriginsSession', JSON.stringify({ code: code, userId: appState.userId }));
                
                document.getElementById('access-screen').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                initializeApp(true); // Initialize in "reloading" mode
            } catch (e) {
                console.error("Failed to parse user data from server:", e);
                errorEl.textContent = "Error al procesar los datos del usuario.";
            }
        } else { // New user, validation was successful
            console.log("New user validated. Proceeding to questionnaire.");
            appState.userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            appState.answers.accessCode = code; // Save code to link user later
            
            // Assign user ID to the code in the background
            const assignPayload = { action: 'assignUser', code: code, userId: appState.userId };
            sendApiRequest(assignPayload).then(assignRes => {
                console.log("User ID assignment response:", assignRes);
            });

            startQuestionnaire();
        }
    } else {
        errorEl.textContent = result.message || 'C√≥digo no v√°lido o expirado.';
    }
}


// --- Main App Execution ---
function main() {
    console.log("Main function started. Cleaning up and resetting.");
    cleanupAndReset();

    try {
        const savedSessionJSON = localStorage.getItem('ketoOriginsSession');
        const savedDataJSON = localStorage.getItem('ketoOriginsData');
        
        if (savedSessionJSON && savedDataJSON) {
            console.log("Found saved session. Loading dashboard directly.");
            const savedData = JSON.parse(savedDataJSON);
            appState = savedData;

            document.getElementById('access-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            initializeApp(true);
        } else {
            console.log("No saved session found. Showing access code screen.");
            document.getElementById('access-screen').classList.remove('hidden');
            addTrackedListener(document.getElementById('submit-code-btn'), 'click', handleCodeValidation);
            addTrackedListener(document.getElementById('access-code-input'), 'keypress', (e) => {
                if (e.key === 'Enter') {
                    handleCodeValidation();
                }
            });
        }
    } catch (e) {
        console.error("Error with localStorage, starting fresh.", e);
        localStorage.clear(); // Clear potentially corrupted storage
        document.getElementById('access-screen').classList.remove('hidden');
        addTrackedListener(document.getElementById('submit-code-btn'), 'click', handleCodeValidation);
         addTrackedListener(document.getElementById('access-code-input'), 'keypress', (e) => {
            if (e.key === 'Enter') {
                handleCodeValidation();
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', main);

</script>
</body>
</html>

